<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job File Management System</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" style="display: none;">
        <div class="container" style="max-width: 400px; margin-top: 5rem;">
            <h1 style="text-align: center; margin-bottom: 2rem; color: var(--theme-color);">Job File Management</h1>
            
            <!-- Login Form -->
            <div id="login-form">
                <h2 style="text-align: center; margin-bottom: 1.5rem;">Login</h2>
                <div style="margin-bottom: 1rem;">
                    <input type="email" id="login-email" placeholder="Email" class="input-field" required>
                </div>
                <div style="margin-bottom: 1.5rem;">
                    <input type="password" id="login-password" placeholder="Password" class="input-field" required>
                </div>
                <button onclick="window.authModule.login()" style="width: 100%; background: var(--theme-color); color: white; padding: 0.75rem; border: none; border-radius: 0.375rem; cursor: pointer; font-weight: 500;">
                    Login
                </button>
            </div>
            
            <!-- Signup Form -->
            <div id="signup-form" style="display: none;">
                <h2 style="text-align: center; margin-bottom: 1.5rem;">Sign Up</h2>
                <div style="margin-bottom: 1rem;" id="signup-name-field">
                    <input type="text" id="signup-name" placeholder="Full Name" class="input-field" required>
                </div>
                <div style="margin-bottom: 1rem;">
                    <input type="email" id="signup-email" placeholder="Email" class="input-field" required>
                </div>
                <div style="margin-bottom: 1.5rem;">
                    <input type="password" id="signup-password" placeholder="Password" class="input-field" required>
                </div>
                <button onclick="window.authModule.signup()" style="width: 100%; background: var(--theme-color); color: white; padding: 0.75rem; border: none; border-radius: 0.375rem; cursor: pointer; font-weight: 500;">
                    Sign Up
                </button>
            </div>
            
            <p id="auth-toggle" style="text-align: center; margin-top: 1rem;">
                Don't have an account? <a href="#" onclick="window.authModule.toggleAuthMode()" style="color: var(--theme-color);">Sign up</a>
            </p>
        </div>
    </div>

    <!-- Driver Dashboard -->
    <div id="driver-dashboard" style="display: none;">
        <div class="container">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 2rem;">
                <h1>Driver Dashboard</h1>
                <button onclick="window.authModule.logout()" style="background: #ef4444; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.25rem; cursor: pointer;">
                    Logout
                </button>
            </div>
            
            <!-- Driver Stats -->
            <div id="driver-stats" style="margin-bottom: 2rem;"></div>
            
            <!-- Driver Assignments -->
            <div>
                <h2 style="margin-bottom: 1rem;">My Assignments</h2>
                <div id="driver-assignments"></div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="main-container" style="display: none;">
        <div class="container">
            <!-- Header -->
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                <h1 style="margin: 0; color: var(--theme-color);">Job File Management</h1>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button onclick="window.mainModule.newJobFile()" style="background: var(--theme-color); color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.25rem; cursor: pointer;">New</button>
                    <button onclick="window.fileManagerModule.showFileManager()" style="background: #10b981; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.25rem; cursor: pointer;">Load</button>
                    <button onclick="window.mainModule.printJobFile()" style="background: #8b5cf6; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.25rem; cursor: pointer;">Print</button>
                    <button onclick="window.deliveryModule.showDeliveryRequest()" class="admin-only" style="background: #f59e0b; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.25rem; cursor: pointer;">Delivery</button>
                    <button onclick="window.adminModule.showAdminPanel()" class="admin-only" style="background: #ef4444; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.25rem; cursor: pointer;">Admin</button>
                    <button onclick="window.analyticsModule.showAnalytics()" class="admin-only" style="background: #3b82f6; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.25rem; cursor: pointer;">Analytics</button>
                    <button onclick="window.authModule.logout()" style="background: #6b7280; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.25rem; cursor: pointer;">Logout</button>
                </div>
            </div>

            <!-- Job File Form -->
            <form id="job-file-form">
                <!-- Basic Information -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Job File No.</label>
                        <input type="text" id="jobFileNo" class="input-field" required>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Service Type</label>
                        <select id="serviceType" class="input-field">
                            <option value="">Select Service</option>
                            <option value="consultation">Consultation</option>
                            <option value="documentation">Documentation</option>
                            <option value="legal">Legal Services</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Priority</label>
                        <select id="priority" class="input-field">
                            <option value="normal">Normal</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                </div>

                <!-- Client Information -->
                <h3 style="margin: 2rem 0 1rem 0; color: var(--theme-color);">Client Information</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Client Name</label>
                        <input type="text" id="clientName" class="input-field" required>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Email</label>
                        <input type="email" id="clientEmail" class="input-field">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Phone</label>
                        <input type="tel" id="clientPhone" class="input-field">
                    </div>
                </div>
                <div style="margin-bottom: 2rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Address</label>
                    <textarea id="clientAddress" class="input-field" rows="3"></textarea>
                </div>

                <!-- Service Description -->
                <h3 style="margin: 2rem 0 1rem 0; color: var(--theme-color);">Service Description</h3>
                <div style="margin-bottom: 2rem;">
                    <textarea id="description" class="input-field" rows="4" placeholder="Describe the service requirements..."></textarea>
                </div>

                <!-- Charges Table -->
                <h3 style="margin: 2rem 0 1rem 0; color: var(--theme-color);">Charges</h3>
                <div style="overflow-x: auto; margin-bottom: 1rem;">
                    <table id="charges-table" style="width: 100%; min-width: 600px;">
                        <thead>
                            <tr style="background: #f3f4f6;">
                                <th class="table-cell" style="font-weight: 600;">Description</th>
                                <th class="table-cell" style="font-weight: 600;">Quantity</th>
                                <th class="table-cell" style="font-weight: 600;">Rate (₹)</th>
                                <th class="table-cell" style="font-weight: 600;">Amount (₹)</th>
                                <th class="table-cell" style="font-weight: 600;">Action</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                    <button type="button" onclick="window.mainModule.addChargeRow()" style="background: var(--theme-color); color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.25rem; cursor: pointer;">Add Row</button>
                    <div style="font-weight: 600; font-size: 1.1rem;">
                        Total: ₹<input type="number" id="totalAmount" readonly style="border: none; background: transparent; font-weight: 600; font-size: 1.1rem; width: 100px;">
                    </div>
                </div>

                <!-- Remarks -->
                <h3 style="margin: 2rem 0 1rem 0; color: var(--theme-color);">Remarks</h3>
                <div style="margin-bottom: 2rem;">
                    <textarea id="remarks" class="input-field" rows="3" placeholder="Additional notes or remarks..."></textarea>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center;">
                    <button type="submit" style="background: var(--theme-color); color: white; padding: 0.75rem 2rem; border: none; border-radius: 0.375rem; cursor: pointer; font-weight: 500;">Save Job File</button>
                    
                    <!-- Status Update Buttons (Admin/Checker Only) -->
                    <div class="checker-only" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button type="button" onclick="updateJobFileStatus('approved')" style="background: #10b981; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.25rem; cursor: pointer;">Approve</button>
                        <button type="button" onclick="updateJobFileStatus('rejected')" style="background: #ef4444; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.25rem; cursor: pointer;">Reject</button>
                        <button type="button" onclick="updateJobFileStatus('checked')" style="background: #3b82f6; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.25rem; cursor: pointer;">Mark as Checked</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- File Manager Modal -->
    <div id="file-manager-modal" class="overlay">
        <div class="modal-content">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1rem;">
                <h2 style="margin: 0;">File Manager</h2>
                <button onclick="window.fileManagerModule.hideFileManager()" style="background: #ef4444; color: white; border: none; padding: 0.5rem; border-radius: 0.25rem; cursor: pointer;">×</button>
            </div>
            
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                <input type="text" id="file-search" placeholder="Search job files..." onkeyup="window.fileManagerModule.searchJobFiles()" style="flex: 1; min-width: 200px;" class="input-field">
                <select id="status-filter" onchange="window.fileManagerModule.filterByStatus()" class="input-field">
                    <option value="all">All Status</option>
                    <option value="pending">Pending</option>
                    <option value="approved">Approved</option>
                    <option value="rejected">Rejected</option>
                    <option value="checked">Checked</option>
                </select>
            </div>
            
            <div id="job-files-list" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- Admin Panel Modal -->
    <div id="admin-modal" class="overlay">
        <div class="modal-content">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1rem;">
                <h2 style="margin: 0;">Admin Panel</h2>
                <button onclick="window.adminModule.hideAdminPanel()" style="background: #ef4444; color: white; border: none; padding: 0.5rem; border-radius: 0.25rem; cursor: pointer;">×</button>
            </div>
            
            <!-- Add New User -->
            <div style="background: #f9fafb; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                <h3 style="margin: 0 0 1rem 0;">Add New User</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                    <input type="text" id="new-user-name" placeholder="Full Name" class="input-field">
                    <input type="email" id="new-user-email" placeholder="Email" class="input-field">
                    <input type="password" id="new-user-password" placeholder="Password" class="input-field">
                    <select id="new-user-role" class="input-field">
                        <option value="user">User</option>
                        <option value="checker">Checker</option>
                        <option value="admin">Admin</option>
                        <option value="driver">Driver</option>
                    </select>
                </div>
                <button onclick="window.adminModule.addNewUser()" style="background: var(--theme-color); color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.25rem; cursor: pointer;">Add User</button>
            </div>
            
            <!-- Users List -->
            <div id="users-list" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- Delivery Request Container -->
    <div id="delivery-request-container" style="display: none;">
        <div class="container">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 2rem;">
                <h1>Create Delivery Request</h1>
                <button onclick="window.deliveryModule.hideDeliveryRequest()" style="background: #6b7280; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.25rem; cursor: pointer;">Back</button>
            </div>
            
            <!-- Step 1: Select Job File -->
            <div id="delivery-step-1">
                <h2>Step 1: Select Job File</h2>
                <div style="margin-bottom: 1rem;">
                    <input type="text" id="job-file-search" placeholder="Search by Job File No. or Client Name..." onkeyup="window.deliveryModule.searchJobFiles()" class="input-field">
                </div>
                <div id="job-file-search-results" style="max-height: 300px; overflow-y: auto;"></div>
            </div>
            
            <!-- Step 2: Delivery Details -->
            <div id="delivery-step-2" style="display: none;">
                <h2>Step 2: Delivery Details</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Delivery Address</label>
                        <textarea id="delivery-address" class="input-field" rows="3" required></textarea>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Contact Number</label>
                        <input type="tel" id="delivery-contact" class="input-field" required>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Delivery Type</label>
                        <select id="delivery-type" class="input-field">
                            <option value="standard">Standard</option>
                            <option value="express">Express</option>
                            <option value="same-day">Same Day</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Scheduled Date</label>
                        <input type="date" id="delivery-date" class="input-field">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Scheduled Time</label>
                        <input type="time" id="delivery-time" class="input-field">
                    </div>
                </div>
                <div style="margin-bottom: 2rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Special Instructions</label>
                    <textarea id="delivery-instructions" class="input-field" rows="3"></textarea>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button onclick="window.deliveryModule.prevDeliveryStep(2)" style="background: #6b7280; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.25rem; cursor: pointer;">Previous</button>
                    <button onclick="window.deliveryModule.nextDeliveryStep()" style="background: var(--theme-color); color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.25rem; cursor: pointer;">Next</button>
                </div>
            </div>
            
            <!-- Step 3: Select Driver -->
            <div id="delivery-step-3" style="display: none;">
                <h2>Step 3: Assign Driver</h2>
                <div id="driver-selection" style="max-height: 300px; overflow-y: auto; margin-bottom: 2rem;"></div>
                <div>
                    <button onclick="window.deliveryModule.prevDeliveryStep(3)" style="background: #6b7280; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.25rem; cursor: pointer;">Previous</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics Container -->
    <div id="analytics-container" style="display: none;">
        <div class="container">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 2rem;">
                <h1>Analytics Dashboard</h1>
                <button onclick="window.analyticsModule.hideAnalytics()" style="background: #6b7280; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.25rem; cursor: pointer;">Back</button>
            </div>
            <div id="analytics-content"></div>
        </div>
    </div>

    <!-- POD Modal -->
    <div id="pod-modal" class="overlay">
        <div class="modal-content">
            <h2 style="margin-bottom: 1rem;">Proof of Delivery</h2>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Recipient Name *</label>
                <input type="text" id="recipient-name" class="input-field" required>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Recipient ID (Optional)</label>
                <input type="text" id="recipient-id" class="input-field">
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Signature *</label>
                <canvas id="signature-canvas" width="400" height="200" style="border: 1px solid #d1d5db; border-radius: 0.25rem; cursor: crosshair;"></canvas>
                <button onclick="window.driverModule.clearSignature()" style="background: #6b7280; color: white; padding: 0.25rem 0.5rem; border: none; border-radius: 0.25rem; cursor: pointer; margin-top: 0.5rem;">Clear</button>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Delivery Notes</label>
                <textarea id="delivery-notes" class="input-field" rows="3"></textarea>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: end;">
                <button onclick="document.getElementById('pod-modal').style.display='none'" style="background: #6b7280; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.25rem; cursor: pointer;">Cancel</button>
                <button onclick="window.driverModule.submitPOD()" style="background: #10b981; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.25rem; cursor: pointer;">Complete Delivery</button>
            </div>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receipt-modal" class="overlay">
        <div class="modal-content">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1rem;">
                <h2 style="margin: 0;">Delivery Receipt</h2>
                <button onclick="document.getElementById('receipt-modal').style.display='none'" style="background: #ef4444; color: white; border: none; padding: 0.5rem; border-radius: 0.25rem; cursor: pointer;">×</button>
            </div>
            <div id="receipt-content"></div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Firebase Configuration -->
    <script>
        // Firebase configuration - Replace with your config
        const firebaseConfig = {
            apiKey: "your-api-key",
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "your-app-id"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        console.log('Firebase initialized:', firebase.apps.length > 0);
    </script>

    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

    <!-- Application Scripts -->
    <script src="js/auth.js"></script>
    <script src="js/main.js"></script>
    <script src="js/fileManager.js"></script>
    <script src="js/admin.js"></script>
    <script src="js/delivery.js"></script>
    <script src="js/driver.js"></script>
    <script src="js/analytics.js"></script>

    <!-- Status Update Function -->
    <script>
        async function updateJobFileStatus(status) {
            if (!window.currentFileId) {
                window.mainModule.showNotification('No job file loaded', 'error');
                return;
            }
            
            const currentUser = window.authModule.getCurrentUser();
            const userRole = window.authModule.getUserRole();
            
            if (userRole !== 'admin' && userRole !== 'checker') {
                window.mainModule.showNotification('Access denied. Admin or Checker privileges required.', 'error');
                return;
            }
            
            try {
                await firebase.firestore().collection('jobFiles').doc(window.currentFileId).update({
                    status: status,
                    statusUpdatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    statusUpdatedBy: currentUser.uid
                });
                
                window.mainModule.showNotification(`Job file ${status} successfully!`, 'success');
                
                // Add visual stamp
                addStatusStamp(status);
                
            } catch (error) {
                console.error('Error updating status:', error);
                window.mainModule.showNotification('Error updating status', 'error');
            }
        }
        
        function addStatusStamp(status) {
            // Remove existing stamps
            const existingStamps = document.querySelectorAll('.stamp');
            existingStamps.forEach(stamp => stamp.remove());
            
            // Add new stamp
            const stamp = document.createElement('div');
            stamp.className = `stamp stamp-${status}`;
            stamp.textContent = status;
            stamp.style.display = 'block';
            
            const container = document.querySelector('.container');
            container.style.position = 'relative';
            container.appendChild(stamp);
        }
    </script>
</body>
</html>