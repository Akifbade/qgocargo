<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QGO Cargo - Simple Dashboard</title>
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            color: #1a202c;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 30px;
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
        }

        .firebase-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .firebase-connected {
            background: #dcfdf7;
            border: 1px solid #10b981;
            color: #047857;
        }

        .firebase-disconnected {
            background: #fef2f2;
            border: 1px solid #ef4444;
            color: #dc2626;
        }

        .system-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .system-card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 32px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .system-card:hover {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            transform: translateY(-4px);
            border-color: #3b82f6;
        }

        .system-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.9;
        }

        .system-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #1a202c;
        }

        .system-description {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 16px;
        }

        .system-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .status-online {
            background: #dcfdf7;
            color: #047857;
            border: 1px solid #10b981;
        }

        .status-maintenance {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }

        .status-offline {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #ef4444;
        }

        .btn {
            background: #3b82f6;
            border: 1px solid #3b82f6;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            font-weight: 500;
        }

        .btn:hover {
            background: #2563eb;
            border-color: #2563eb;
        }

        .btn-primary {
            background: rgba(59, 130, 246, 0.8);
            border: 1px solid rgba(59, 130, 246, 1);
        }

        .btn-primary:hover {
            background: rgba(59, 130, 246, 1);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 40px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
        }

        .modal h3 {
            margin-bottom: 20px;
            font-size: 24px;
            font-weight: 600;
            color: #1a202c;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
        }

        .input {
            background: #ffffff;
            border: 1px solid #d1d5db;
            color: #1a202c;
            padding: 12px;
            border-radius: 8px;
            width: 100%;
            font-size: 14px;
        }

        .input::placeholder {
            color: #9ca3af;
        }

        .input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 8px;
            color: white;
            z-index: 2000;
            font-weight: 500;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
        }

        .notification.success {
            background: rgba(16, 185, 129, 0.9);
            border: 1px solid rgba(16, 185, 129, 1);
        }

        .notification.error {
            background: rgba(239, 68, 68, 0.9);
            border: 1px solid rgba(239, 68, 68, 1);
        }

        .notification.warning {
            background: rgba(245, 158, 11, 0.9);
            border: 1px solid rgba(245, 158, 11, 1);
        }

        @keyframes slideIn {
            from { 
                transform: translateX(100%); 
                opacity: 0; 
            }
            to { 
                transform: translateX(0); 
                opacity: 1; 
            }
        }

        .stats-bar {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #10b981;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 14px;
            color: #64748b;
            font-weight: 500;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .close-btn {
            background: #ef4444;
            border: 1px solid #ef4444;
        }

        .close-btn:hover {
            background: #dc2626;
            border-color: #dc2626;
        }

        .version-info {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
            font-size: 14px;
            color: #64748b;
            border: 1px solid #e2e8f0;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: bold;
        }

        .admin-btn {
            background: #10b981;
            border: 1px solid #10b981;
            margin-left: 10px;
        }

        .admin-btn:hover {
            background: #059669;
            border-color: #059669;
        }

        .icon-picker {
            display: none;
            position: absolute;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            max-height: 300px;
            overflow-y: auto;
            width: 300px;
        }

        .icon-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
        }

        .icon-option {
            padding: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .icon-option:hover {
            background: #f3f4f6;
            border-color: #3b82f6;
        }

        .icon-option.selected {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .system-editor {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .system-editor h5 {
            color: #1a202c;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .delete-system-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .add-system-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .add-system-btn:hover {
            background: #059669;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <div class="logo-icon">QGO</div>
                <div>
                    <h1 style="font-size: 28px; font-weight: 700; margin-bottom: 4px; color: #1a202c;">QGO Cargo Dashboard</h1>
                    <p style="color: #64748b; font-size: 16px;">Professional Management System</p>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <button class="btn admin-btn" onclick="openAdminPanel()">
                    <i class="fas fa-shield-alt"></i> Admin Panel
                </button>
                <div id="firebaseStatus" class="firebase-status firebase-disconnected">
                    <i class="fas fa-database"></i>
                    <span>Connecting...</span>
                </div>
            </div>
        </div>

        <div class="stats-bar">
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="totalSystems">-</div>
                    <div class="stat-label">Active Systems</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalUsage">-</div>
                    <div class="stat-label">Total Usage</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="onlineSystems">-</div>
                    <div class="stat-label">Online</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="lastUpdate">-</div>
                    <div class="stat-label">Last Updated</div>
                </div>
            </div>
        </div>

        <div class="system-grid" id="systemGrid">
            <!-- Systems will be loaded dynamically from localStorage or defaults -->
        </div>

        <div class="version-info">
            <i class="fas fa-info-circle"></i>
            QGO Cargo Dashboard v2.0 - Simple & Efficient
        </div>
    </div>

    <!-- Admin Panel Modal -->
    <div id="adminModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <h3><i class="fas fa-shield-alt"></i> Admin Panel - System Configuration</h3>
            
            <!-- Admin Login -->
            <div id="adminLogin" style="display: block;">
                <div class="input-group">
                    <label>Admin Password</label>
                    <input type="password" id="adminPassword" class="input" placeholder="Enter admin password (default: 1234)">
                </div>
                <div class="buttons">
                    <button class="btn btn-primary" onclick="adminLogin()">
                        <i class="fas fa-lock"></i> Login
                    </button>
                    <button class="btn close-btn" onclick="closeAdminModal()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>

            <!-- Admin Panel Content -->
            <div id="adminContent" style="display: none;">
                <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="color: #1a202c; margin-bottom: 15px;"><i class="fas fa-info-circle"></i> Current Firebase Config</h4>
                    <div style="font-family: monospace; background: white; padding: 15px; border-radius: 6px; border: 1px solid #e2e8f0;">
                        <strong>Project ID:</strong> my-job-file-system<br>
                        <strong>API Key:</strong> AIzaSyAAulR2nJQm-4QtNyEqKTnnDPw-iKW92Mc<br>
                        <strong>Auth Domain:</strong> my-job-file-system.firebaseapp.com<br>
                        <strong>App ID:</strong> 1:145307873304:web:d661ea6ec118801b4a136d
                    </div>
                </div>

                <h4 style="color: #1a202c; margin-bottom: 15px;"><i class="fas fa-link"></i> System Management</h4>
                <div style="margin-bottom: 15px; display: flex; gap: 10px;">
                    <button class="add-system-btn" onclick="addNewSystem()">
                        <i class="fas fa-plus"></i> Add New System
                    </button>
                    <button onclick="resetToDefaults()" style="background: #ef4444; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
                        <i class="fas fa-undo"></i> Reset to Defaults
                    </button>
                </div>
                <div id="systemManagementEditor">
                    <!-- Systems will be populated dynamically -->
                </div>

                <h4 style="color: #1a202c; margin: 20px 0 15px 0;"><i class="fas fa-palette"></i> System Icons & Colors</h4>
                <div id="systemIconsEditor">
                    <!-- Icons will be populated dynamically -->
                </div>

                <!-- Icon Picker Modal -->
                <div id="iconPicker" class="icon-picker">
                    <h5 style="margin-bottom: 10px; color: #1a202c;">Choose an Icon</h5>
                    <div class="icon-grid" id="iconGrid">
                        <!-- Icons will be populated by JavaScript -->
                    </div>
                </div>

                <div class="buttons" style="margin-top: 30px;">
                    <button class="btn btn-primary" onclick="saveAdminSettings()">
                        <i class="fas fa-save"></i> Save All Changes
                    </button>
                    <button class="btn" onclick="resetToDefaults()" style="background: #f59e0b; border-color: #f59e0b;">
                        <i class="fas fa-undo"></i> Reset to Defaults
                    </button>
                    <button class="btn close-btn" onclick="closeAdminModal()">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        let db = null;
        let firebaseConfig = {
            apiKey: "AIzaSyAAulR2nJQm-4QtNyEqKTnnDPw-iKW92Mc",
            authDomain: "my-job-file-system.firebaseapp.com",
            projectId: "my-job-file-system",
            storageBucket: "my-job-file-system.appspot.com",
            messagingSenderId: "145307873304",
            appId: "1:145307873304:web:d661ea6ec118801b4a136d",
            measurementId: "G-8EHX5K7YHL"
        };

        // Initialize Firebase
        function initializeFirebase() {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.firestore();
                
                // Enable offline persistence for better reliability
                db.enablePersistence({ synchronizeTabs: true }).catch((err) => {
                    if (err.code == 'failed-precondition') {
                        console.log('Multiple tabs open, persistence can only be enabled in one tab at a time.');
                    } else if (err.code == 'unimplemented') {
                        console.log('The current browser does not support all features required for persistence');
                    }
                });
                
                updateFirebaseStatus(true);
                loadGlobalData(true); // Force fresh data on init
                console.log('Firebase initialized successfully - Global tracking enabled');
            } catch (error) {
                console.error('Firebase initialization error:', error);
                updateFirebaseStatus(false);
                loadLocalStats(); // Fallback to local stats
            }
        }

        // Update Firebase Status
        function updateFirebaseStatus(connected) {
            const statusElement = document.getElementById('firebaseStatus');
            if (connected) {
                statusElement.className = 'firebase-status firebase-connected';
                statusElement.innerHTML = '<i class="fas fa-database"></i><span>Connected</span>';
            } else {
                statusElement.className = 'firebase-status firebase-disconnected';
                statusElement.innerHTML = '<i class="fas fa-database"></i><span>Disconnected</span>';
            }
        }

        // Load Global Data with force refresh
        async function loadGlobalData(forceRefresh = false) {
            if (!db) {
                console.log('Firebase not available - using local fallback');
                loadLocalStats();
                return;
            }

            try {
                // Use simpler collection structure for better reliability
                const usageRef = db.collection('usage').doc('global');
                let usageDoc;
                
                if (forceRefresh) {
                    usageDoc = await usageRef.get({ source: 'server' });
                } else {
                    usageDoc = await usageRef.get();
                }
                
                if (usageDoc.exists) {
                    const data = usageDoc.data();
                    updateStats(data);
                    updateFirebaseStatus(true);
                    console.log('Global Firebase data loaded successfully');
                } else {
                    console.log('Creating initial global usage document');
                    await initializeGlobalUsage();
                }
            } catch (error) {
                console.error('Firebase error:', error.message);
                
                // Try alternative collection structure
                try {
                    const altRef = db.collection('globalStats').doc('usage');
                    const altDoc = await altRef.get();
                    if (altDoc.exists) {
                        const data = altDoc.data();
                        updateStats(data);
                        updateFirebaseStatus(true);
                        console.log('Alternative Firebase collection loaded');
                    } else {
                        await initializeGlobalUsage();
                    }
                } catch (altError) {
                    console.error('All Firebase attempts failed:', altError.message);
                    updateFirebaseStatus(false);
                    showNotification('Firebase connection issues - using local mode', 'warning');
                    loadLocalStats();
                }
            }
        }

        // Load local statistics when Firebase is unavailable
        function loadLocalStats() {
            const localStats = JSON.parse(localStorage.getItem('localUsageStats') || '{}');
            const savedSystems = JSON.parse(localStorage.getItem('systemsList') || '[]');
            
            // Calculate stats from local data
            const totalSystems = savedSystems.length || 6;
            const totalUsage = Object.values(localStats).reduce((sum, count) => sum + (count || 0), 0);
            
            updateStats({
                totalSystems: totalSystems,
                dashboard: { count: localStats.dashboard || 0 },
                jobfile: { count: localStats.jobfile || 0 },
                pod: { count: localStats.pod || 0 },
                backup: { count: localStats.backup || 0 },
                wh: { count: localStats.wh || 0 },
                admin: { count: localStats.admin || 0 },
                lastUpdated: new Date()
            });
        }

        // Initialize Global Usage
        async function initializeGlobalUsage() {
            if (!db) return;

            const savedSystems = JSON.parse(localStorage.getItem('systemsList') || '[]');
            const systemCount = savedSystems.length || 6;

            const initialData = {
                totalSystems: systemCount,
                dashboard: { count: 0, lastAccess: new Date() },
                jobfile: { count: 0, lastAccess: new Date() },
                pod: { count: 0, lastAccess: new Date() },
                backup: { count: 0, lastAccess: new Date() },
                wh: { count: 0, lastAccess: new Date() },
                admin: { count: 0, lastAccess: new Date() },
                lastUpdated: new Date(),
                version: '2.0'
            };

            try {
                // Use simple collection structure
                await db.collection('usage').doc('global').set(initialData, { merge: true });
                updateStats(initialData);
                console.log('Global usage initialized in Firebase');
                showNotification('Firebase global tracking activated!', 'success');
            } catch (error) {
                console.error('Failed to initialize Firebase:', error);
                // Try alternative collection
                try {
                    await db.collection('globalStats').doc('usage').set(initialData, { merge: true });
                    updateStats(initialData);
                    console.log('Global usage initialized in alternative collection');
                    showNotification('Firebase tracking enabled (alternative)', 'success');
                } catch (altError) {
                    console.error('All Firebase initialization attempts failed:', altError);
                    loadLocalStats(); // Use local fallback
                }
            }
        }

        // Update Stats Display
        function updateStats(data) {
            if (!data) return;

            // Calculate total usage from all systems
            const totalUsage = Object.keys(data)
                .filter(key => typeof data[key] === 'object' && data[key].count !== undefined)
                .reduce((sum, key) => sum + (data[key].count || 0), 0);

            // Count online systems based on status
            const savedSystems = JSON.parse(localStorage.getItem('systemsList') || '[]');
            const onlineSystems = savedSystems.filter(system => system.status === 'online').length || 5;

            document.getElementById('totalSystems').textContent = data.totalSystems || savedSystems.length || 6;
            document.getElementById('totalUsage').textContent = totalUsage.toLocaleString();
            document.getElementById('onlineSystems').textContent = onlineSystems;
            
            if (data.lastUpdated) {
                const lastUpdate = data.lastUpdated.toDate ? data.lastUpdated.toDate() : new Date(data.lastUpdated);
                document.getElementById('lastUpdate').textContent = lastUpdate.toLocaleString();
            } else {
                document.getElementById('lastUpdate').textContent = 'Just now';
            }
            
            // Log for debugging
            console.log('📊 Stats Updated:', {
                totalSystems: data.totalSystems,
                totalUsage: totalUsage,
                onlineSystems: onlineSystems,
                systems: {
                    dashboard: data.dashboard?.count || 0,
                    jobfile: data.jobfile?.count || 0,
                    pod: data.pod?.count || 0,
                    backup: data.backup?.count || 0,
                    wh: data.wh?.count || 0,
                    admin: data.admin?.count || 0
                }
            });
        }

        // Track System Access - GLOBAL FIREBASE TRACKING
        async function trackSystemAccess(systemName) {
            console.log(`Tracking access to ${systemName}`);
            
            // Always track locally as backup
            const localStats = JSON.parse(localStorage.getItem('localUsageStats') || '{}');
            localStats[systemName] = (localStats[systemName] || 0) + 1;
            localStorage.setItem('localUsageStats', JSON.stringify(localStats));
            
            // PRIMARY: Track in Firebase for GLOBAL usage
            if (db) {
                try {
                    const usageRef = db.collection('usage').doc('global');
                    
                    await db.runTransaction(async (transaction) => {
                        const doc = await transaction.get(usageRef);
                        
                        if (doc.exists) {
                            const data = doc.data();
                            const currentCount = data[systemName]?.count || 0;
                            
                            const updates = {
                                [`${systemName}.count`]: currentCount + 1,
                                [`${systemName}.lastAccess`]: new Date(),
                                lastUpdated: new Date()
                            };
                            
                            transaction.update(usageRef, updates);
                            console.log(`✅ GLOBAL: ${systemName} tracked in Firebase (count: ${currentCount + 1})`);
                        } else {
                            // Create document if it doesn't exist
                            await initializeGlobalUsage();
                        }
                    });
                    
                    // Refresh the stats display immediately
                    setTimeout(() => loadGlobalData(true), 500);
                    
                } catch (error) {
                    console.error(`Firebase tracking failed for ${systemName}:`, error);
                    
                    // Try alternative collection
                    try {
                        const altRef = db.collection('globalStats').doc('usage');
                        await db.runTransaction(async (transaction) => {
                            const doc = await transaction.get(altRef);
                            
                            if (doc.exists) {
                                const data = doc.data();
                                const currentCount = data[systemName]?.count || 0;
                                
                                const updates = {
                                    [`${systemName}.count`]: currentCount + 1,
                                    [`${systemName}.lastAccess`]: new Date(),
                                    lastUpdated: new Date()
                                };
                                
                                transaction.update(altRef, updates);
                                console.log(`✅ GLOBAL (ALT): ${systemName} tracked in Firebase`);
                            }
                        });
                        
                        setTimeout(() => loadGlobalData(true), 500);
                        
                    } catch (altError) {
                        console.error(`All Firebase tracking failed for ${systemName}:`, altError);
                        showNotification(`${systemName} usage tracked locally only`, 'warning');
                        loadLocalStats(); // Update local display
                    }
                }
            } else {
                console.log(`Firebase not available - ${systemName} tracked locally only`);
                loadLocalStats();
            }
        }

        // Open System
        function openSystem(systemName) {
            trackSystemAccess(systemName);
            
            // Show loading notification
            showNotification(`Opening ${systemName.toUpperCase()}...`, 'success');
            
            // Get saved system links or use defaults
            const savedLinks = JSON.parse(localStorage.getItem('systemLinks') || '{}');
            const defaultFiles = {
                'dashboard': 'simple-dashboard.html',
                'jobfile': 'jobfile.html', 
                'pod': 'pod (1).html',
                'backup': 'backup.html',
                'wh': 'wh (1).html',
                'admin': 'admin.html'
            };
            
            // Open system in new tab after short delay
            setTimeout(() => {
                const fileName = savedLinks[systemName] || defaultFiles[systemName] || `${systemName}.html`;
                window.open(fileName, '_blank');
            }, 500);
        }

        // Load and render dynamic systems
        function loadDynamicSystems() {
            const savedSystems = JSON.parse(localStorage.getItem('systemsList') || '[]');
            const systemGrid = document.getElementById('systemGrid');
            
            // Use default systems if no custom systems saved
            const defaultSystems = [
                { id: 'dashboard', name: 'Dashboard', description: 'Main control panel', link: 'simple-dashboard.html', icon: 'fas fa-tachometer-alt', color: '#3b82f6', status: 'online' },
                { id: 'jobfile', name: 'Job File', description: 'Job management system', link: 'jobfile.html', icon: 'fas fa-briefcase', color: '#10b981', status: 'online' },
                { id: 'pod', name: 'POD', description: 'Proof of delivery', link: 'pod (1).html', icon: 'fas fa-cube', color: '#8b5cf6', status: 'online' },
                { id: 'backup', name: 'Backup', description: 'Data backup system', link: 'backup.html', icon: 'fas fa-shield-alt', color: '#f59e0b', status: 'maintenance' },
                { id: 'wh', name: 'Warehouse', description: 'Inventory management', link: 'wh (1).html', icon: 'fas fa-warehouse', color: '#06b6d4', status: 'online' },
                { id: 'admin', name: 'Admin', description: 'System administration', link: '#', icon: 'fas fa-cog', color: '#ef4444', status: 'online' }
            ];
            
            const systemsToRender = savedSystems.length > 0 ? savedSystems : defaultSystems;
            
            // Clear existing systems
            systemGrid.innerHTML = '';
            
            // Render each system
            systemsToRender.forEach(system => {
                const systemCard = document.createElement('div');
                systemCard.className = 'system-card';
                
                // Determine click action
                const clickAction = system.id === 'admin' ? 'openAdminPanel()' : `openSystem('${system.id}')`;
                systemCard.setAttribute('onclick', clickAction);
                
                // Determine status class
                const statusClass = system.status === 'online' ? 'status-online' : 
                                  system.status === 'maintenance' ? 'status-maintenance' : 'status-offline';
                
                systemCard.innerHTML = `
                    <div class="system-icon">
                        <i class="${system.icon}" style="color: ${system.color};"></i>
                    </div>
                    <div class="system-title">${system.name}</div>
                    <div class="system-description">${system.description}</div>
                    <div class="system-status ${statusClass}">${system.status.charAt(0).toUpperCase() + system.status.slice(1)}</div>
                `;
                
                systemGrid.appendChild(systemCard);
            });
            
            // Save default systems if none existed
            if (savedSystems.length === 0) {
                localStorage.setItem('systemsList', JSON.stringify(defaultSystems));
            }
        }

        // Apply saved icons and colors
        function applySavedIconsAndColors() {
            // This function is now handled by loadDynamicSystems()
            console.log('Icons and colors applied via dynamic system loading');
        }

        // Show Notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : 'exclamation'}"></i> ${message}`;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Icon Picker Functionality
        const availableIcons = [
            'fas fa-tachometer-alt', 'fas fa-briefcase', 'fas fa-cube', 'fas fa-shield-alt', 
            'fas fa-warehouse', 'fas fa-cog', 'fas fa-home', 'fas fa-user', 'fas fa-users',
            'fas fa-chart-bar', 'fas fa-chart-line', 'fas fa-chart-pie', 'fas fa-database',
            'fas fa-server', 'fas fa-cloud', 'fas fa-file', 'fas fa-folder', 'fas fa-inbox',
            'fas fa-truck', 'fas fa-shipping-fast', 'fas fa-boxes', 'fas fa-box',
            'fas fa-clipboard', 'fas fa-clipboard-list', 'fas fa-tasks', 'fas fa-calendar',
            'fas fa-bell', 'fas fa-envelope', 'fas fa-phone', 'fas fa-map-marker-alt',
            'fas fa-search', 'fas fa-filter', 'fas fa-sort', 'fas fa-plus',
            'fas fa-edit', 'fas fa-trash', 'fas fa-download', 'fas fa-upload',
            'fas fa-print', 'fas fa-share', 'fas fa-link', 'fas fa-star',
            'fas fa-heart', 'fas fa-bookmark', 'fas fa-flag', 'fas fa-tag'
        ];

        let currentIconInputId = '';

        function openIconPicker(inputId) {
            currentIconInputId = inputId;
            const picker = document.getElementById('iconPicker');
            const iconGrid = document.getElementById('iconGrid');
            
            // Clear previous icons
            iconGrid.innerHTML = '';
            
            // Populate icons
            availableIcons.forEach(iconClass => {
                const iconOption = document.createElement('div');
                iconOption.className = 'icon-option';
                iconOption.innerHTML = `<i class="${iconClass}"></i>`;
                iconOption.title = iconClass;
                
                iconOption.onclick = () => selectIcon(iconClass);
                iconGrid.appendChild(iconOption);
            });
            
            // Position the picker near the input
            const inputElement = document.getElementById(inputId);
            const rect = inputElement.getBoundingClientRect();
            picker.style.display = 'block';
            picker.style.left = rect.left + 'px';
            picker.style.top = (rect.bottom + 5) + 'px';
        }

        function selectIcon(iconClass) {
            document.getElementById(currentIconInputId).value = iconClass;
            document.getElementById('iconPicker').style.display = 'none';
            
            // Update preview if needed
            const previewIcon = document.querySelector(`#${currentIconInputId.replace('Icon', '')}Preview i`);
            if (previewIcon) {
                previewIcon.className = iconClass;
            }
        }

        // Close icon picker when clicking outside
        document.addEventListener('click', (e) => {
            const picker = document.getElementById('iconPicker');
            if (picker && !picker.contains(e.target) && !e.target.closest('[onclick*="openIconPicker"]')) {
                picker.style.display = 'none';
            }
        });

        // Modal Functions - Admin Panel Only
        function openAdminPanel() {
            document.getElementById('adminModal').style.display = 'block';
            document.getElementById('adminLogin').style.display = 'block';
            document.getElementById('adminContent').style.display = 'none';
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminPassword').focus();
        }

        function closeAdminModal() {
            document.getElementById('adminModal').style.display = 'none';
            document.getElementById('iconPicker').style.display = 'none'; // Close icon picker too
        }

        // Admin Panel Functions
        function openAdminPanel() {
            document.getElementById('adminModal').style.display = 'block';
            document.getElementById('adminLogin').style.display = 'block';
            document.getElementById('adminContent').style.display = 'none';
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminPassword').focus();
        }

        function closeAdminModal() {
            document.getElementById('adminModal').style.display = 'none';
        }

        function adminLogin() {
            const password = document.getElementById('adminPassword').value;
            if (password === '1234') {
                document.getElementById('adminLogin').style.display = 'none';
                document.getElementById('adminContent').style.display = 'block';
                loadAdminSettings();
                showNotification('Admin access granted!', 'success');
            } else {
                showNotification('Invalid admin password!', 'error');
                document.getElementById('adminPassword').value = '';
            }
        }

        function loadAdminSettings() {
            // Load saved settings or defaults
            const savedLinks = JSON.parse(localStorage.getItem('systemLinks') || '{}');
            const savedIcons = JSON.parse(localStorage.getItem('systemIcons') || '{}');
            const savedSystems = JSON.parse(localStorage.getItem('systemsList') || '[]');
            
            // Default systems if none saved
            if (savedSystems.length === 0) {
                const defaultSystems = [
                    { id: 'dashboard', name: 'Dashboard', description: 'Main control panel', link: 'simple-dashboard.html', icon: 'fas fa-tachometer-alt', color: '#3b82f6', status: 'online' },
                    { id: 'jobfile', name: 'Job File', description: 'Job management system', link: 'jobfile.html', icon: 'fas fa-briefcase', color: '#10b981', status: 'online' },
                    { id: 'pod', name: 'POD', description: 'Proof of delivery', link: 'pod (1).html', icon: 'fas fa-cube', color: '#8b5cf6', status: 'online' },
                    { id: 'backup', name: 'Backup', description: 'Data backup system', link: 'backup.html', icon: 'fas fa-shield-alt', color: '#f59e0b', status: 'maintenance' },
                    { id: 'wh', name: 'Warehouse', description: 'Inventory management', link: 'wh (1).html', icon: 'fas fa-warehouse', color: '#06b6d4', status: 'online' },
                    { id: 'admin', name: 'Admin', description: 'System administration', link: 'admin.html', icon: 'fas fa-cog', color: '#ef4444', status: 'online' }
                ];
                localStorage.setItem('systemsList', JSON.stringify(defaultSystems));
                renderSystemsEditor(defaultSystems);
            } else {
                renderSystemsEditor(savedSystems);
            }
        }

        function renderSystemsEditor(systems) {
            const managementEditor = document.getElementById('systemManagementEditor');
            const iconsEditor = document.getElementById('systemIconsEditor');
            
            managementEditor.innerHTML = '';
            iconsEditor.innerHTML = '';
            
            systems.forEach((system, index) => {
                // System management editor
                const systemDiv = document.createElement('div');
                systemDiv.className = 'system-editor';
                systemDiv.innerHTML = `
                    <h5>
                        <span><i class="${system.icon}"></i> ${system.name}</span>
                        ${systems.length > 1 ? `<button class="delete-system-btn" onclick="deleteSystem('${system.id}')">Delete</button>` : ''}
                    </h5>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="input-group">
                            <label>System Name</label>
                            <input type="text" id="${system.id}Name" class="input" value="${system.name}">
                        </div>
                        <div class="input-group">
                            <label>System ID</label>
                            <input type="text" id="${system.id}Id" class="input" value="${system.id}" readonly>
                        </div>
                        <div class="input-group">
                            <label>Description</label>
                            <input type="text" id="${system.id}Description" class="input" value="${system.description}">
                        </div>
                        <div class="input-group">
                            <label>File Link</label>
                            <input type="text" id="${system.id}Link" class="input" value="${system.link}">
                        </div>
                        <div class="input-group">
                            <label>Status</label>
                            <select id="${system.id}Status" class="input">
                                <option value="online" ${system.status === 'online' ? 'selected' : ''}>Online</option>
                                <option value="maintenance" ${system.status === 'maintenance' ? 'selected' : ''}>Maintenance</option>
                                <option value="offline" ${system.status === 'offline' ? 'selected' : ''}>Offline</option>
                            </select>
                        </div>
                    </div>
                `;
                managementEditor.appendChild(systemDiv);
                
                // Icon editor
                const iconDiv = document.createElement('div');
                iconDiv.className = 'input-group';
                iconDiv.style.minWidth = '200px';
                iconDiv.innerHTML = `
                    <label>${system.name} Icon</label>
                    <div style="position: relative;">
                        <input type="text" id="${system.id}Icon" class="input" value="${system.icon}" readonly>
                        <button type="button" onclick="openIconPicker('${system.id}Icon')" style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: #3b82f6; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Pick</button>
                    </div>
                    <input type="color" id="${system.id}Color" value="${system.color}" style="width: 100%; height: 40px; margin-top: 5px;">
                `;
                iconsEditor.appendChild(iconDiv);
            });
            
            // Make icons editor a grid
            iconsEditor.style.display = 'grid';
            iconsEditor.style.gridTemplateColumns = 'repeat(auto-fit, minmax(200px, 1fr))';
            iconsEditor.style.gap = '15px';
        }

        function saveAdminSettings() {
            const savedSystems = JSON.parse(localStorage.getItem('systemsList') || '[]');
            const updatedSystems = [];
            
            savedSystems.forEach(system => {
                const nameElement = document.getElementById(`${system.id}Name`);
                const descElement = document.getElementById(`${system.id}Description`);
                const linkElement = document.getElementById(`${system.id}Link`);
                const iconElement = document.getElementById(`${system.id}Icon`);
                const colorElement = document.getElementById(`${system.id}Color`);
                const statusElement = document.getElementById(`${system.id}Status`);
                
                if (nameElement && descElement && linkElement && iconElement && colorElement && statusElement) {
                    updatedSystems.push({
                        id: system.id,
                        name: nameElement.value,
                        description: descElement.value,
                        link: linkElement.value,
                        icon: iconElement.value,
                        color: colorElement.value,
                        status: statusElement.value
                    });
                }
            });
            
            // Save to localStorage
            localStorage.setItem('systemsList', JSON.stringify(updatedSystems));
            
            // Also save in old format for backward compatibility
            const systemLinks = {};
            const systemIcons = {};
            
            updatedSystems.forEach(system => {
                systemLinks[system.id] = system.link;
                systemIcons[system.id] = {
                    icon: system.icon,
                    color: system.color
                };
            });
            
            localStorage.setItem('systemLinks', JSON.stringify(systemLinks));
            localStorage.setItem('systemIcons', JSON.stringify(systemIcons));
            
            showNotification('Admin settings saved! Updating dashboard...', 'success');
            
            // Close admin panel and reload systems
            setTimeout(() => {
                closeAdminModal();
                loadDynamicSystems(); // Reload the dashboard systems
                loadLocalStats(); // Update stats with new system count
            }, 1000);
        }

        function addNewSystem() {
            const systems = JSON.parse(localStorage.getItem('systemsList') || '[]');
            const newId = `system${Date.now()}`;
            const newSystem = {
                id: newId,
                name: 'New System',
                description: 'Custom system',
                link: 'new-system.html',
                icon: 'fas fa-star',
                color: '#6366f1',
                status: 'online'
            };
            
            systems.push(newSystem);
            localStorage.setItem('systemsList', JSON.stringify(systems));
            renderSystemsEditor(systems);
            showNotification('New system added!', 'success');
        }

        function deleteSystem(systemId) {
            if (confirm('Are you sure you want to delete this system?')) {
                const systems = JSON.parse(localStorage.getItem('systemsList') || '[]');
                
                // Prevent deleting if only one system remains
                if (systems.length <= 1) {
                    showNotification('Cannot delete the last system!', 'error');
                    return;
                }
                
                const filteredSystems = systems.filter(system => system.id !== systemId);
                localStorage.setItem('systemsList', JSON.stringify(filteredSystems));
                renderSystemsEditor(filteredSystems);
                showNotification('System deleted!', 'warning');
            }
        }

        function resetToDefaults() {
            if (confirm('Reset to default systems? This will remove all custom systems.')) {
                const defaultSystems = [
                    { id: 'dashboard', name: 'Dashboard', description: 'Main control panel', link: 'simple-dashboard.html', icon: 'fas fa-tachometer-alt', color: '#6366f1', status: 'online' },
                    { id: 'jobfile', name: 'Job File', description: 'Job management system', link: 'jobfile.html', icon: 'fas fa-briefcase', color: '#059669', status: 'online' },
                    { id: 'pod', name: 'POD', description: 'Proof of delivery', link: 'pod (1).html', icon: 'fas fa-clipboard-check', color: '#dc2626', status: 'online' },
                    { id: 'backup', name: 'Backup', description: 'Data backup system', link: 'backup.html', icon: 'fas fa-save', color: '#7c3aed', status: 'online' },
                    { id: 'wh', name: 'Warehouse', description: 'Warehouse management', link: 'wh (1).html', icon: 'fas fa-warehouse', color: '#ea580c', status: 'online' },
                    { id: 'admin', name: 'Admin', description: 'System administration', link: '#', icon: 'fas fa-cog', color: '#374151', status: 'online' }
                ];
                
                localStorage.setItem('systemsList', JSON.stringify(defaultSystems));
                renderSystemsEditor(defaultSystems);
                showNotification('Reset to default systems!', 'success');
            }
        }

        function saveSettings() {
            // This function is no longer needed - Firebase config is hardcoded
            showNotification('Firebase config is hardcoded in the system', 'warning');
        }

        // Load saved config - now just applies local storage overrides if any
        function loadSavedConfig() {
            // Firebase config is now hardcoded, but we keep this for potential future use
            console.log('Using hardcoded Firebase config');
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeAdminModal();
            }
            if (e.ctrlKey && e.shiftKey && e.key === 'A') {
                e.preventDefault();
                openAdminPanel();
            }
        });

        // Click outside admin modal to close
        document.getElementById('adminModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                closeAdminModal();
            }
        });

        // Enter key for admin login
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && document.getElementById('adminLogin').style.display !== 'none') {
                adminLogin();
            }
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadSavedConfig();
            loadDynamicSystems(); // Load systems from localStorage or defaults
            initializeFirebase();
            
            // Auto-refresh Firebase data every 10 seconds with fresh server data
            setInterval(() => {
                if (db) {
                    loadGlobalData(true); // Force server refresh
                }
            }, 10000);
        });

        // Auto-retry Firebase connection and force refresh
        setInterval(() => {
            if (!db) {
                console.log('Retrying Firebase connection...');
                initializeFirebase();
            } else {
                // Force refresh data every 30 seconds
                loadGlobalData(true);
            }
        }, 30000);
    </script>
</body>
</html>
