<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job File Management System with Database</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --theme-color: #4f46e5; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: white;
            border-radius: 0.5rem;
            border-top: 5px solid var(--theme-color);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .input-field {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
            transition: border-color 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: var(--theme-color);
            box-shadow: 0 0 0 1px var(--theme-color);
        }
        .table-cell {
            border: 1px solid #d1d5db;
            padding: 0.75rem;
        }
        .table-cell input {
            width: 100%;
            border: none;
            padding: 0;
            background-color: transparent;
        }
        .table-cell input:focus {
            outline: none;
        }
        
        /* Modal, Loader, and Notification Styles */
        .overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5); display: flex;
            align-items: center; justify-content: center; z-index: 1000;
            opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
        }
        .overlay.visible {
            opacity: 1; visibility: visible;
        }
        .modal-content {
            background: white; padding: 2rem; border-radius: 0.5rem;
            max-width: 90%; width: 700px; max-height: 85vh; overflow-y: auto;
            transform: scale(0.9); transition: transform 0.3s;
        }
        .overlay.visible .modal-content {
            transform: scale(1);
        }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--theme-color);
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #notification {
            position: fixed; bottom: 20px; right: 20px;
            background-color: #2d3748; color: white;
            padding: 1rem 1.5rem; border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(100px); opacity: 0;
            transition: transform 0.5s, opacity 0.5s;
            z-index: 2000;
        }
        #notification.show {
            transform: translateY(0); opacity: 1;
        }

        /* Print-Specific Styles */
        @page { size: A4; margin: 0.5cm; }
        @media print {
            body { background-color: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            #main-container, .no-print { display: none !important; }
            #print-output { display: block !important; padding: 0 !important; margin: 0 !important; }
        }
        #print-output .print-table, #preview-modal .print-table, #analytics-modal .analytics-table { border-collapse: collapse; width: 100%; }
        #print-output .print-table th, #print-output .print-table td,
        #preview-modal .print-table th, #preview-modal .print-table td,
        #analytics-modal .analytics-table th, #analytics-modal .analytics-table td { border: 1px solid #d1d5db; padding: 0.5rem; text-align: left; }
        #analytics-modal .analytics-table th { background-color: #f3f4f6; font-weight: 600; }
        #print-output .print-field, #preview-modal .print-field { border: 1px solid #6b7280; padding: 0.3rem; min-height: 24px; word-break: break-all; }
        .admin-only, .checker-only, #signup-name-field { display: none; } /* Hide role-specific elements by default */
        
        /* Stamp Styles */
        .stamp {
            position: absolute;
            top: -10px; right: -10px;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
            transform: rotate(15deg);
            opacity: 0.8;
            display: none; /* Hidden by default */
        }
        .stamp-approved { border: 2px solid #16a34a; color: #16a34a; }
        .stamp-checked { border: 2px solid #2563eb; color: #2563eb; }
        .stamp-rejected { border: 2px solid #dc2626; color: #dc2626; }
    </style>
    <style id="print-styles"></style>
</head>
<body class="bg-gray-100">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <div>
                <div class="text-center text-5xl font-extrabold" style="color: #0E639C;">Q'go<span style="color: #4FB8AF;">Cargo</span></div>
                <h2 id="auth-title" class="mt-6 text-center text-3xl font-extrabold text-gray-900">Sign in to your account</h2>
            </div>
            <div class="mt-8 space-y-6 bg-white p-8 rounded-lg shadow-md">
                <div id="approval-message" class="hidden p-4 text-center text-yellow-800 bg-yellow-100 rounded-lg">
                    Your account is awaiting admin approval.
                </div>
                <div class="rounded-md shadow-sm -space-y-px">
                    <div id="signup-name-field">
                        <label for="full-name" class="sr-only">Full Name</label>
                        <input id="full-name" name="name" type="text" autocomplete="name" required class="input-field rounded-t-md" placeholder="Full Name">
                    </div>
                    <div>
                        <label for="email-address" class="sr-only">Email address</label>
                        <input id="email-address" name="email" type="email" autocomplete="email" required class="input-field" placeholder="Email address">
                    </div>
                    <div>
                        <label for="password" class="sr-only">Password</label>
                        <input id="password" name="password" type="password" autocomplete="current-password" required class="input-field rounded-b-md" placeholder="Password">
                    </div>
                </div>
                <div>
                    <button id="auth-btn" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Sign in
                    </button>
                </div>
                <p class="mt-2 text-center text-sm text-gray-600">
                    <a href="#" id="auth-link" class="font-medium text-indigo-600 hover:text-indigo-500">
                        Create a new account
                    </a>
                </p>
            </div>
        </div>
    </div>

    <!-- Main Application Container (Hidden by default) -->
    <div id="app-container" class="hidden">
        <div id="main-container" class="container">
            <!-- Header Section -->
            <header class="flex justify-between items-start mb-6">
                <div class="flex items-center">
                    <div id="logo-container" class="text-3xl font-bold mr-4" style="color: #0E639C;">Q'go<span style="color: #4FB8AF;">Cargo</span></div>
                    <h1 class="text-4xl font-bold text-gray-800 border-l-4 border-gray-300 pl-4">JOB FILE</h1>
                </div>
                <div class="text-right">
                    <div class="flex items-center mb-2">
                        <label for="date" class="mr-2 font-semibold text-gray-700">Date:</label>
                        <input type="date" id="date" class="input-field w-40">
                    </div>
                    <div class="flex items-center">
                        <label for="po-number" class="mr-2 font-semibold text-gray-700">P.O. #:</label>
                        <input type="text" id="po-number" class="input-field w-40">
                    </div>
                </div>
            </header>
            
            <!-- User Info and Logout -->
            <div class="flex justify-between items-center mb-4 bg-gray-50 p-2 rounded-md">
                <div>
                    Logged in as: <span id="user-display-name" class="font-bold"></span> (<span id="user-role" class="capitalize"></span>)
                </div>
                <div>
                    <button id="admin-panel-btn" class="admin-only bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded text-sm mr-2">Admin Panel</button>
                    <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded text-sm">Logout</button>
                </div>
            </div>
            
            <div id="rejection-banner" class="hidden p-3 mb-4 text-center text-red-800 bg-red-100 rounded-lg">
                <strong>This job file was rejected.</strong> Reason: <span id="rejection-reason"></span>
            </div>

            <!-- Form Fields -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div class="lg:col-span-2">
                    <label for="job-file-no" class="block mb-1 font-semibold text-gray-700">Job File No.:</label>
                    <input type="text" id="job-file-no" class="input-field" placeholder="Enter a unique ID here...">
                </div>
                <div>
                    <label for="type" class="block mb-1 font-semibold text-gray-700">Type:</label>
                    <input type="text" id="type" class="input-field">
                </div>
                <div class="flex space-x-6">
                    <div>
                        <span class="font-semibold text-gray-700">Clearance</span>
                        <div class="mt-2 space-y-1">
                            <label class="flex items-center"><input type="checkbox" class="mr-2" data-clearance="Export"> Export</label>
                            <label class="flex items-center"><input type="checkbox" class="mr-2" data-clearance="Import"> Import</label>
                            <label class="flex items-center"><input type="checkbox" class="mr-2" data-clearance="Clearance"> Clearance</label>
                            <label class="flex items-center"><input type="checkbox" class="mr-2" data-clearance="Local Move"> Local Move</label>
                        </div>
                    </div>
                    <div>
                        <span class="font-semibold text-gray-700">Product Type</span>
                        <div class="mt-2 space-y-1">
                            <label class="flex items-center"><input type="checkbox" class="mr-2" data-product="Air Freight"> Air Freight</label>
                            <label class="flex items-center"><input type="checkbox" class="mr-2" data-product="Sea Freight"> Sea Freight</label>
                            <label class="flex items-center"><input type="checkbox" class="mr-2" data-product="Land Freight"> Land Freight</label>
                            <label class="flex items-center"><input type="checkbox" class="mr-2" data-product="Others"> Others</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div><label for="invoice-no" class="block mb-1 font-semibold text-gray-700">Invoice No.:</label><input type="text" id="invoice-no" class="input-field"></div>
                <div><label for="billing-date" class="block mb-1 font-semibold text-gray-700">Billing Date:</label><input type="date" id="billing-date" class="input-field"></div>
                <div><label for="salesman" class="block mb-1 font-semibold text-gray-700">Salesman:</label><input type="text" id="salesman" class="input-field"></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div><label for="shipper-name" class="block mb-1 font-semibold text-gray-700">Shipper's Name:</label><input type="text" id="shipper-name" class="input-field"></div>
                <div><label for="consignee-name" class="block mb-1 font-semibold text-gray-700">Consignee's Name:</label><input type="text" id="consignee-name" class="input-field"></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div><label for="mawb" class="block mb-1 font-semibold text-gray-700">MAWB / OBL / TCN No.:</label><input type="text" id="mawb" class="input-field"></div>
                <div><label for="hawb" class="block mb-1 font-semibold text-gray-700">HAWB / HBL:</label><input type="text" id="hawb" class="input-field"></div>
                <div><label for="teams-of-shipping" class="block mb-1 font-semibold text-gray-700">Teams of Shipping:</label><input type="text" id="teams-of-shipping" class="input-field"></div>
                <div><label for="origin" class="block mb-1 font-semibold text-gray-700">Origin:</label><input type="text" id="origin" class="input-field"></div>
                <div><label for="no-of-pieces" class="block mb-1 font-semibold text-gray-700">No. of Pieces:</label><input type="text" id="no-of-pieces" class="input-field"></div>
                <div><label for="gross-weight" class="block mb-1 font-semibold text-gray-700">Gross Weight:</label><input type="text" id="gross-weight" class="input-field"></div>
                <div><label for="destination" class="block mb-1 font-semibold text-gray-700">Destination:</label><input type="text" id="destination" class="input-field"></div>
                <div><label for="volume-weight" class="block mb-1 font-semibold text-gray-700">Volume Weight:</label><input type="text" id="volume-weight" class="input-field"></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="lg:col-span-2"><label for="description" class="block mb-1 font-semibold text-gray-700">Description:</label><input type="text" id="description" class="input-field"></div>
                <div><label for="carrier" class="block mb-1 font-semibold text-gray-700">Carrier / Shipping Line / Trucking Co:</label><input type="text" id="carrier" class="input-field"></div>
                <div><label for="truck-no" class="block mb-1 font-semibold text-gray-700">Truck No. / Driver's Name:</label><input type="text" id="truck-no" class="input-field"></div>
                <div><label for="vessel-name" class="block mb-1 font-semibold text-gray-700">Vessel's Name:</label><input type="text" id="vessel-name" class="input-field"></div>
                <div><label for="flight-voyage-no" class="block mb-1 font-semibold text-gray-700">Flight / Voyage No.:</label><input type="text" id="flight-voyage-no" class="input-field"></div>
                <div><label for="container-no" class="block mb-1 font-semibold text-gray-700">Container No.:</label><input type="text" id="container-no" class="input-field"></div>
            </div>

            <!-- Charges Table -->
            <h2 class="text-xl font-semibold text-gray-800 mb-2">Charges</h2>
            <div class="mb-6 overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead><tr class="bg-gray-100"><th class="table-cell font-semibold w-2/5">Description</th><th class="table-cell font-semibold">Cost</th><th class="table-cell font-semibold">Selling</th><th class="table-cell font-semibold">Profit</th><th class="table-cell font-semibold">Notes</th></tr></thead>
                    <tbody id="charges-table-body"></tbody>
                </table>
            </div>

            <!-- Remarks Section -->
            <div class="mb-8">
                <label for="remarks" class="block font-semibold text-gray-700 mb-2">REMARKS:</label>
                <textarea id="remarks" rows="4" class="input-field w-full"></textarea>
            </div>

            <!-- Footer Section -->
            <footer class="grid grid-cols-1 md:grid-cols-3 gap-8 pt-6 border-t items-end">
                <div><label class="block mb-2 font-semibold text-gray-700">PREPARED BY</label><input type="text" id="prepared-by" class="input-field bg-gray-100" readonly></div>
                <div class="relative">
                    <div id="checked-stamp" class="stamp stamp-checked">Checked</div>
                    <label class="block mb-2 font-semibold text-gray-700">CHECKED BY</label>
                    <input type="text" id="checked-by" class="input-field bg-gray-100" readonly>
                    <button id="check-btn" class="checker-only mt-2 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Check Job File</button>
                </div>
                <div class="relative">
                    <div id="approved-stamp" class="stamp stamp-approved">Approved</div>
                    <div id="rejected-stamp" class="stamp stamp-rejected">Rejected</div>
                    <label class="block mb-2 font-semibold text-gray-700">APPROVED BY</label>
                    <input type="text" id="approved-by" class="input-field bg-gray-100" readonly>
                    <div id="approval-buttons" class="admin-only mt-2 w-full flex gap-2">
                        <button id="approve-btn" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">Approve</button>
                        <button id="reject-btn" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded">Reject</button>
                    </div>
                </div>
            </footer>

            <!-- Action Buttons -->
            <div class="text-center mt-10 no-print flex flex-wrap justify-center gap-2 sm:gap-4">
                 <button onclick="openAnalyticsDashboard()" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105">Analytics</button>
                 <button onclick="openFileManager()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105">File Manager</button>
                 <button onclick="saveJobFile()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105">Save to DB</button>
                 <button onclick="clearForm()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105">New Job</button>
                 <button onclick="printPage()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105">Print</button>
            </div>
        </div>
    </div>

    <!-- This container is hidden by default and will be populated for printing/preview -->
    <div id="print-output" class="hidden"></div>

    <!-- Modals -->
    <div id="loader-overlay" class="overlay"><div class="loader"></div></div>
    <div id="notification"></div>
    
    <!-- File Manager Modal -->
    <div id="file-manager-modal" class="overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">File Manager</h3>
                <button onclick="closeModal('file-manager-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <input type="text" id="search-bar" class="input-field w-full mb-4" placeholder="Search job files...">
            <div id="job-files-list" class="space-y-2 max-h-[60vh] overflow-y-auto"></div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="overlay">
        <div class="modal-content max-w-sm">
            <h3 class="text-lg font-bold mb-4" id="confirm-title">Confirm Deletion</h3>
            <p id="confirm-message" class="mb-4">Are you sure?</p>
            <div class="text-right mt-6 space-x-2">
                <button id="confirm-cancel" class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-4 rounded">Cancel</button>
                <button id="confirm-ok" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Delete</button>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="preview-modal" class="overlay">
        <div class="modal-content" style="max-width: 8.5in;">
            <div class="flex justify-between items-center mb-4 no-print">
                <h3 class="text-2xl font-bold">Job File Preview</h3>
                <button onclick="closeModal('preview-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div id="preview-body"></div>
        </div>
    </div>

    <!-- Analytics Modal -->
    <div id="analytics-modal" class="overlay">
        <div class="modal-content" style="max-width: 950px;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Analytics Dashboard</h3>
                <button onclick="closeModal('analytics-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div id="analytics-body" class="space-y-6"></div>
        </div>
    </div>

    <!-- Admin Panel Modal -->
    <div id="admin-panel-modal" class="overlay">
        <div class="modal-content" style="max-width: 600px;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Admin Panel - User Management</h3>
                <button onclick="closeModal('admin-panel-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div id="user-list" class="space-y-2 max-h-[60vh] overflow-y-auto"></div>
            <div class="text-right mt-4">
                <button onclick="saveUserChanges()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- Rejection Reason Modal -->
    <div id="reject-reason-modal" class="overlay">
        <div class="modal-content max-w-md">
            <h3 class="text-lg font-bold mb-4">Rejection Reason</h3>
            <p class="mb-4">Please provide a reason for rejecting this job file.</p>
            <textarea id="rejection-reason-input" class="input-field w-full" rows="3"></textarea>
            <div class="text-right mt-6 space-x-2">
                <button onclick="closeModal('reject-reason-modal')" class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-4 rounded">Cancel</button>
                <button id="confirm-reject-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Confirm Rejection</button>
            </div>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Global variables
        let db, auth;
        let currentUser = null;
        let jobFilesCache = []; // Cache for analytics
        let analyticsDataCache = null; // Cache for analytics data to re-sort

        // --- Firebase Initialization ---
        async function initializeFirebase() {
            try {
                // YOUR FIREBASE CONFIGURATION OBJECT
                const firebaseConfig = {
                  apiKey: "AIzaSyAAulR2nJQm-4QtNyEqKTnnDPw-iKW92Mc",
                  authDomain: "my-job-file-system.firebaseapp.com",
                  projectId: "my-job-file-system",
                  storageBucket: "my-job-file-system.firebasestorage.app",
                  messagingSenderId: "145307873304",
                  appId: "1:145307873304:web:d661ea6ec118801b4a136d",
                  measurementId: "G-8EHX5K7YHL"
                };

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Auth state listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        const userDocRef = doc(db, 'users', user.uid);
                        let userDoc = await getDoc(userDocRef);
                        
                        if (!userDoc.exists()) {
                            // This is a new user that needs a document in Firestore.
                            const usersCollectionRef = collection(db, 'users');
                            const userQuerySnapshot = await getDocs(usersCollectionRef);
                            const isFirstUser = userQuerySnapshot.size === 0;

                            const newUser = {
                                email: user.email,
                                displayName: user.displayName || user.email.split('@')[0],
                                role: isFirstUser ? 'admin' : 'user',
                                status: isFirstUser ? 'active' : 'inactive', // First user is active by default
                                createdAt: serverTimestamp()
                            };
                            await setDoc(userDocRef, newUser);
                            userDoc = await getDoc(userDocRef); // Re-fetch the doc
                        }
                        
                        currentUser = { uid: user.uid, email: user.email, ...userDoc.data() };
                        
                        if (currentUser.status === 'inactive') {
                            showLogin();
                            document.getElementById('approval-message').style.display = 'block';
                            signOut(auth);
                            return;
                        }
                        
                        console.log("User logged in:", currentUser);
                        showApp();
                        loadJobFiles();
                    } else {
                        currentUser = null;
                        console.log("User logged out");
                        showLogin();
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showNotification("Could not connect to the database.", true);
            }
        }

        // --- Authentication Logic ---
        async function handleSignUp(email, password, displayName) {
            showLoader();
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showNotification("Account created! Waiting for admin approval.", false);
            } catch (error) {
                console.error("Sign up error:", error);
                showNotification(error.message, true);
            }
            hideLoader();
        }

        async function handleLogin(email, password) {
            showLoader();
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login error:", error);
                showNotification("Invalid email or password.", true);
            }
            hideLoader();
        }

        function handleLogout() {
            signOut(auth);
        }

        // --- Data Handling (Firestore) ---
        window.saveJobFile = async function() {
            if (!db) { showNotification("Database not connected.", true); return; }
            showLoader();
            const jobFileNo = document.getElementById('job-file-no').value.trim();
            if (!jobFileNo) { hideLoader(); showNotification("Please enter a Job File No.", true); return; }

            const data = getFormData();
            data.totalCost = parseFloat(document.getElementById('total-cost').textContent) || 0;
            data.totalSelling = parseFloat(document.getElementById('total-selling').textContent) || 0;
            data.totalProfit = parseFloat(document.getElementById('total-profit').textContent) || 0;
            data.updatedAt = serverTimestamp();
            data.lastUpdatedBy = currentUser.displayName;

            try {
                const docRef = doc(db, 'jobfiles', jobFileNo);
                await setDoc(docRef, data, { merge: true });
                hideLoader();
                showNotification("Job file saved successfully!");
            } catch (error) {
                hideLoader();
                console.error("Error saving document: ", error);
                showNotification("Error saving job file.", true);
            }
        }
        
        window.checkJobFile = async function() {
            if (!currentUser || !['admin', 'checker'].includes(currentUser.role)) {
                showNotification("You do not have permission to check job files.", true);
                return;
            }
            const jobFileNo = document.getElementById('job-file-no').value.trim();
            if (!jobFileNo) {
                showNotification("Please save the job file first.", true);
                return;
            }
            
            showLoader();
            const checkData = {
                checkedBy: currentUser.displayName,
                checkedAt: serverTimestamp(),
                status: 'checked'
            };
            
            try {
                const docRef = doc(db, 'jobfiles', jobFileNo);
                await setDoc(docRef, checkData, { merge: true });
                populateFormFromData({...(await getDoc(docRef)).data()});
                hideLoader();
                showNotification("Job File Checked!");
            } catch (error) {
                hideLoader();
                console.error("Error checking document: ", error);
                showNotification("Error checking job file.", true);
            }
        }

        window.approveJobFile = async function() {
            if (currentUser.role !== 'admin') {
                showNotification("Only admins can approve job files.", true);
                return;
            }
            const jobFileNo = document.getElementById('job-file-no').value.trim();
            if (!jobFileNo) {
                showNotification("Please save the job file first.", true);
                return;
            }
            
            showLoader();
            const approvalData = {
                approvedBy: currentUser.displayName,
                approvedAt: serverTimestamp(),
                status: 'approved'
            };
            
            try {
                const docRef = doc(db, 'jobfiles', jobFileNo);
                await setDoc(docRef, approvalData, { merge: true });
                populateFormFromData({...(await getDoc(docRef)).data()});
                hideLoader();
                showNotification("Job File Approved!");
            } catch (error) {
                hideLoader();
                console.error("Error approving document: ", error);
                showNotification("Error approving job file.", true);
            }
        }

        window.rejectJobFile = async function() {
            const reason = document.getElementById('rejection-reason-input').value.trim();
            if (!reason) {
                showNotification("Rejection reason is required.", true);
                return;
            }

            const jobFileNo = document.getElementById('job-file-no').value.trim();
            showLoader();
            const rejectionData = {
                rejectedBy: currentUser.displayName,
                rejectedAt: serverTimestamp(),
                rejectionReason: reason,
                status: 'rejected'
            };

            try {
                const docRef = doc(db, 'jobfiles', jobFileNo);
                await setDoc(docRef, rejectionData, { merge: true });
                populateFormFromData({...(await getDoc(docRef)).data()});
                hideLoader();
                closeModal('reject-reason-modal');
                showNotification("Job File Rejected!");
            } catch (error) {
                hideLoader();
                console.error("Error rejecting document: ", error);
                showNotification("Error rejecting job file.", true);
            }
        }

        function loadJobFiles() {
            if (!db) return;
            const jobFilesCollection = collection(db, 'jobfiles');
            const q = query(jobFilesCollection);

            onSnapshot(q, (querySnapshot) => {
                jobFilesCache = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const list = document.getElementById('job-files-list');
                if (jobFilesCache.length === 0) {
                    list.innerHTML = `<p class="text-gray-500 text-center p-4">No saved job files found.</p>`;
                    return;
                }
                
                let filesHtml = '';
                const sortedDocs = [...jobFilesCache].sort((a,b) => (b.updatedAt?.toDate() ? b.updatedAt.toDate() : 0) - (a.updatedAt?.toDate() ? a.updatedAt.toDate() : 0));

                sortedDocs.forEach((docData) => {
                    const deleteButton = currentUser.role === 'admin' ? `<button onclick="confirmDelete('KD{docData.id}')" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded text-sm">Delete</button>` : '';
                    const lastUpdated = docData.updatedAt?.toDate ? docData.updatedAt.toDate().toLocaleString() : 'N/A';
                    filesHtml += `
                        <div class="job-file-item border p-3 rounded-lg flex justify-between items-center bg-gray-50 hover:bg-gray-100" 
                             data-search-term="KD{(docData.jfn || '').toLowerCase()} KD{(docData.sh || '').toLowerCase()} KD{(docData.co || '').toLowerCase()}">
                            <div>
                                <p class="font-bold text-indigo-700">KD{docData.jfn || 'No ID'}</p>
                                <p class="text-sm text-gray-600">Shipper: KD{docData.sh || 'N/A'} | Consignee: KD{docData.co || 'N/A'}</p>
                                <p class="text-xs text-gray-400">Last Updated: KD{lastUpdated}</p>
                            </div>
                            <div class="space-x-2 flex-shrink-0">
                                <button onclick="previewJobFileById('KD{docData.id}')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded text-sm">Preview</button>
                                <button onclick="loadJobFileById('KD{docData.id}')" class="bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded text-sm">Load</button>
                                KD{deleteButton}
                            </div>
                        </div>
                    `;
                });
                list.innerHTML = filesHtml;
            }, (error) => {
                console.error("Error fetching job files: ", error);
                showNotification("Error loading job files.", true);
            });
        }

        window.loadJobFileById = async function(docId) {
            showLoader();
            try {
                const docRef = doc(db, 'jobfiles', docId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    populateFormFromData(docSnap.data());
                    closeModal('file-manager-modal');
                    closeModal('analytics-modal');
                    showNotification("Job file loaded successfully.");
                } else {
                    showNotification("Document not found.", true);
                }
                hideLoader();
            } catch (error) {
                hideLoader();
                console.error("Error loading document:", error);
                showNotification("Error loading job file.", true);
            }
        }

        window.previewJobFileById = async function(docId) {
            showLoader();
            try {
                const docRef = doc(db, 'jobfiles', docId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const previewHtml = getPrintViewHtml(docSnap.data());
                    document.getElementById('preview-body').innerHTML = previewHtml;
                    closeModal('analytics-modal'); // Close analytics modal first
                    openModal('preview-modal');
                } else {
                    showNotification("Document not found.", true);
                }
                hideLoader();
            } catch (error) {
                hideLoader();
                console.error("Error previewing document:", error);
                showNotification("Error previewing job file.", true);
            }
        }
        
        async function deleteJobFile(docId) {
            showLoader();
            try {
                const docRef = doc(db, 'jobfiles', docId);
                await deleteDoc(docRef);
                hideLoader();
                showNotification("Job file has been deleted.");
            } catch (error) {
                hideLoader();
                console.error("Error deleting document:", error);
                showNotification("Error deleting job file.", true);
            }
        }

        // --- Confirmation Modal Logic ---
        window.confirmDelete = (docId) => {
            if (currentUser.role !== 'admin') {
                showNotification("Only admins can delete files.", true);
                return;
            }
            const modal = document.getElementById('confirm-modal');
            modal.querySelector('#confirm-message').textContent = `Are you sure you want to delete job file "KD{docId}"? This action cannot be undone.`;
            openModal('confirm-modal');

            const okButton = modal.querySelector('#confirm-ok');
            const cancelButton = modal.querySelector('#confirm-cancel');

            const onOk = () => {
                deleteJobFile(docId);
                closeConfirm();
            };
            const closeConfirm = () => {
                closeModal('confirm-modal');
                okButton.removeEventListener('click', onOk);
                cancelButton.removeEventListener('click', closeConfirm);
            };
            
            okButton.addEventListener('click', onOk, { once: true });
            cancelButton.addEventListener('click', closeConfirm, { once: true });
        }

        // --- Analytics Dashboard Logic ---
        window.openAnalyticsDashboard = function() {
            if (jobFilesCache.length === 0) {
                showNotification("No data available for analysis.", true);
                return;
            }

            // 1. Process Data
            let totalJobs = jobFilesCache.length;
            let totalRevenue = 0;
            let totalCost = 0;
            let totalProfit = 0;
            const profitByFile = [];
            const profitByShipper = {};
            const profitByConsignee = {};
            const monthlyProfit = {};

            jobFilesCache.forEach(job => {
                const profit = job.totalProfit || 0;
                const revenue = job.totalSelling || 0;
                const cost = job.totalCost || 0;
                let status = 'Pending Check';
                if (job.status === 'rejected') status = 'Rejected';
                else if (job.status === 'approved') status = 'Approved';
                else if (job.status === 'checked') status = 'Pending Approval';


                totalRevenue += revenue;
                totalCost += cost;
                totalProfit += profit;

                profitByFile.push({ id: job.id, jfn: job.jfn, shipper: job.sh, consignee: job.co, profit: profit, status: status, date: job.updatedAt?.toDate() || new Date(0) });

                if (job.sh) {
                    profitByShipper[job.sh] = (profitByShipper[job.sh] || 0) + profit;
                }
                if (job.co) {
                    profitByConsignee[job.co] = (profitByConsignee[job.co] || 0) + profit;
                }
                if (job.d) {
                    const month = job.d.substring(0, 7); // YYYY-MM
                    monthlyProfit[month] = (monthlyProfit[month] || 0) + profit;
                }
            });

            analyticsDataCache = {
                totalJobs, totalRevenue, totalCost, totalProfit, profitByFile,
                profitByShipper: Object.entries(profitByShipper).sort((a, b) => b[1] - a[1]),
                profitByConsignee: Object.entries(profitByConsignee).sort((a, b) => b[1] - a[1]),
                monthlyProfit: Object.entries(monthlyProfit).sort((a, b) => a[0].localeCompare(b[0]))
            };

            // 2. Display Data
            displayAnalytics(analyticsDataCache);
            openModal('analytics-modal');
        }

        function displayAnalytics(data, sortBy = 'profit-desc') {
            const body = document.getElementById('analytics-body');
            const deleteButtonHtml = (fileId) => currentUser.role === 'admin' ? `<button onclick="confirmDelete('KD{fileId}')" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded text-xs">Delete</button>` : '';
            
            // Sorting logic
            const sortedFiles = [...data.profitByFile];
            if (sortBy === 'profit-desc') {
                sortedFiles.sort((a, b) => b.profit - a.profit);
            } else if (sortBy === 'date-desc') {
                sortedFiles.sort((a, b) => b.date - a.date);
            } else if (sortBy === 'status') {
                const statusOrder = { 'Pending Check': 1, 'Pending Approval': 2, 'Approved': 3, 'Rejected': 4 };
                sortedFiles.sort((a, b) => statusOrder[a.status] - statusOrder[b.status]);
            }

            body.innerHTML = `
                <!-- Overall Summary -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <div class="bg-gray-100 p-4 rounded-lg"><p class="text-sm text-gray-600">Total Jobs</p><p class="text-2xl font-bold">KD{data.totalJobs}</p></div>
                    <div class="bg-blue-100 p-4 rounded-lg"><p class="text-sm text-blue-800">Total Revenue</p><p class="text-2xl font-bold text-blue-900">KDKD{data.totalRevenue.toFixed(2)}</p></div>
                    <div class="bg-red-100 p-4 rounded-lg"><p class="text-sm text-red-800">Total Cost</p><p class="text-2xl font-bold text-red-900">KDKD{data.totalCost.toFixed(2)}</p></div>
                    <div class="bg-green-100 p-4 rounded-lg"><p class="text-sm text-green-800">Total Profit</p><p class="text-2xl font-bold text-green-900">KDKD{data.totalProfit.toFixed(2)}</p></div>
                </div>

                <!-- Detailed Breakdowns -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Top Shippers & Consignees -->
                    <div>
                        <h4 class="text-lg font-semibold mb-2">Top Profitable Shippers</h4>
                        <table class="analytics-table"><thead><tr><th>Shipper</th><th>Total Profit</th></tr></thead>
                        <tbody>KD{data.profitByShipper.slice(0, 5).map(([name, profit]) => `<tr><td>KD{name}</td><td>KDKD{profit.toFixed(2)}</td></tr>`).join('')}</tbody></table>
                    </div>
                    <div>
                        <h4 class="text-lg font-semibold mb-2">Top Profitable Consignees</h4>
                        <table class="analytics-table"><thead><tr><th>Consignee</th><th>Total Profit</th></tr></thead>
                        <tbody>KD{data.profitByConsignee.slice(0, 5).map(([name, profit]) => `<tr><td>KD{name}</td><td>KDKD{profit.toFixed(2)}</td></tr>`).join('')}</tbody></table>
                    </div>
                     <!-- Monthly Profit -->
                    <div class="lg:col-span-2">
                        <h4 class="text-lg font-semibold mb-2">Monthly Profit</h4>
                        <table class="analytics-table"><thead><tr><th>Month</th><th>Total Profit</th></tr></thead>
                        <tbody>KD{data.monthlyProfit.map(([month, profit]) => `<tr><td>KD{month}</td><td>KDKD{profit.toFixed(2)}</td></tr>`).join('')}</tbody></table>
                    </div>
                </div>

                <!-- Profit by Job File -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-lg font-semibold">Profit by Job File</h4>
                        <div>
                            <label for="sort-analytics" class="text-sm mr-2">Sort by:</label>
                            <select id="sort-analytics" onchange="sortAnalyticsTable(this.value)" class="input-field w-auto inline-block">
                                <option value="profit-desc" KD{sortBy === 'profit-desc' ? 'selected' : ''}>Profit (High to Low)</option>
                                <option value="date-desc" KD{sortBy === 'date-desc' ? 'selected' : ''}>Date (Newest First)</option>
                                <option value="status" KD{sortBy === 'status' ? 'selected' : ''}>Status</option>
                            </select>
                            <button onclick="downloadAnalyticsCsv()" class="bg-gray-700 hover:bg-gray-800 text-white font-bold py-1 px-3 rounded text-sm ml-2">Download CSV</button>
                        </div>
                    </div>
                    <div class="max-h-64 overflow-y-auto">
                        <table class="analytics-table">
                            <thead><tr><th>Job File ID</th><th>Shipper</th><th>Profit</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody>KD{sortedFiles.map(file => `
                                <tr>
                                    <td>KD{file.jfn || file.id}</td>
                                    <td>KD{file.shipper || 'N/A'}</td>
                                    <td>KDKD{file.profit.toFixed(2)}</td>
                                    <td>KD{file.status}</td>
                                    <td class="space-x-1">
                                        <button onclick="previewJobFileById('KD{file.id}')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-2 rounded text-xs">Preview</button>
                                        <button onclick="loadJobFileById('KD{file.id}')" class="bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-2 rounded text-xs">Load</button>
                                        KD{deleteButtonHtml(file.id)}
                                    </td>
                                </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        window.sortAnalyticsTable = function(sortBy) {
            displayAnalytics(analyticsDataCache, sortBy);
        }
        
        window.downloadAnalyticsCsv = function() {
            let csvContent = "data:text/csv;charset=utf-8,Job File ID,Shipper,Consignee,Profit,Status\n";
            const sortedFiles = [...analyticsDataCache.profitByFile].sort((a,b) => (b.profit || 0) - (a.profit || 0));

            sortedFiles.forEach(job => {
                const row = [job.jfn, job.shipper || 'N/A', job.consignee || 'N/A', (job.profit || 0).toFixed(2), job.status].join(",");
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "job_file_analytics.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- Admin Panel Logic ---
        async function openAdminPanel() {
            if (currentUser.role !== 'admin') {
                showNotification("Access denied.", true);
                return;
            }
            showLoader();
            const usersCollectionRef = collection(db, 'users');
            const userQuerySnapshot = await getDocs(usersCollectionRef);
            const userListDiv = document.getElementById('user-list');
            let userListHtml = '';

            userQuerySnapshot.forEach(doc => {
                const userData = doc.data();
                const userId = doc.id;
                userListHtml += `
                    <div class="grid grid-cols-3 gap-4 items-center p-2 border-b">
                        <input type="text" data-uid="KD{userId}" class="display-name-input input-field col-span-1" value="KD{userData.displayName}">
                        <select data-uid="KD{userId}" class="role-select input-field col-span-1">
                            <option value="user" KD{userData.role === 'user' ? 'selected' : ''}>User</option>
                            <option value="checker" KD{userData.role === 'checker' ? 'selected' : ''}>Checker</option>
                            <option value="admin" KD{userData.role === 'admin' ? 'selected' : ''}>Admin</option>
                        </select>
                        <select data-uid="KD{userId}" class="status-select input-field col-span-1">
                            <option value="active" KD{userData.status === 'active' ? 'selected' : ''}>Active</option>
                            <option value="inactive" KD{userData.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                        </select>
                    </div>
                `;
            });
            userListDiv.innerHTML = userListHtml;
            hideLoader();
            openModal('admin-panel-modal');
        }

        async function saveUserChanges() {
            showLoader();
            const batch = writeBatch(db);
            const userRows = document.querySelectorAll('#user-list > div');
            
            userRows.forEach(row => {
                const nameInput = row.querySelector('.display-name-input');
                const roleSelect = row.querySelector('.role-select');
                const statusSelect = row.querySelector('.status-select');
                const uid = nameInput.dataset.uid;
                const newName = nameInput.value;
                const newRole = roleSelect.value;
                const newStatus = statusSelect.value;
                
                const userDocRef = doc(db, 'users', uid);
                batch.update(userDocRef, { 
                    displayName: newName,
                    role: newRole,
                    status: newStatus
                });
            });

            try {
                await batch.commit();
                hideLoader();
                showNotification("User details updated successfully!");
                closeModal('admin-panel-modal');
            } catch (error) {
                hideLoader();
                console.error("Error updating roles: ", error);
                showNotification("Failed to update user details.", true);
            }
        }


        // --- UI Functions ---
        function showLogin() {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('approval-message').style.display = 'none';
        }

        function showApp() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            document.getElementById('user-display-name').textContent = currentUser.displayName;
            document.getElementById('user-role').textContent = currentUser.role;

            // Show/hide role-specific elements
            const adminElements = document.querySelectorAll('.admin-only');
            const checkerElements = document.querySelectorAll('.checker-only');
            
            if (currentUser.role === 'admin') {
                adminElements.forEach(el => el.style.display = 'block');
                checkerElements.forEach(el => el.style.display = 'block');
            } else if (currentUser.role === 'checker') {
                adminElements.forEach(el => el.style.display = 'none');
                checkerElements.forEach(el => el.style.display = 'block');
            } else {
                adminElements.forEach(el => el.style.display = 'none');
                checkerElements.forEach(el => el.style.display = 'none');
            }
        }

        window.openModal = (id) => document.getElementById(id).classList.add('visible');
        window.closeModal = (id) => document.getElementById(id).classList.remove('visible');
        window.openFileManager = () => openModal('file-manager-modal');
        
        window.clearForm = () => {
            const form = document.querySelector('#main-container');
            const inputs = form.querySelectorAll('input[type="text"], input[type="date"], textarea');
            const checkboxes = form.querySelectorAll('input[type="checkbox"]');
            inputs.forEach(input => input.value = '');
            checkboxes.forEach(checkbox => checkbox.checked = false);
            document.getElementById('date').valueAsDate = new Date();
            populateTable();
            calculate();
            
            // Set prepared by
            document.getElementById('prepared-by').value = currentUser.displayName;

            // Reset approval and check fields
            const approveBtn = document.getElementById('approve-btn');
            const checkBtn = document.getElementById('check-btn');
            document.getElementById('approved-by').value = '';
            document.getElementById('checked-by').value = '';
            approveBtn.disabled = false;
            document.getElementById('approval-buttons').style.display = 'flex'; // Show both buttons
            checkBtn.disabled = false;
            checkBtn.textContent = 'Check Job File';

            // Hide all stamps and banners
            document.getElementById('checked-stamp').style.display = 'none';
            document.getElementById('approved-stamp').style.display = 'none';
            document.getElementById('rejected-stamp').style.display = 'none';
            document.getElementById('rejection-banner').style.display = 'none';


            showNotification("Form cleared. Ready for a new job file.");
        }

        function showLoader() { document.getElementById('loader-overlay').classList.add('visible'); }
        function hideLoader() { document.getElementById('loader-overlay').classList.remove('visible'); }

        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.backgroundColor = isError ? '#c53030' : '#2d3748';
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Search functionality for file manager
        document.getElementById('search-bar').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            document.querySelectorAll('.job-file-item').forEach(item => {
                const itemSearchTerm = item.dataset.searchTerm;
                if (itemSearchTerm.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        });

        // Initialize Firebase on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            
            // Auth Event Listeners
            const authBtn = document.getElementById('auth-btn');
            const authLink = document.getElementById('auth-link');
            const logoutBtn = document.getElementById('logout-btn');
            const approveBtn = document.getElementById('approve-btn');
            const rejectBtn = document.getElementById('reject-btn');
            const confirmRejectBtn = document.getElementById('confirm-reject-btn');
            const checkBtn = document.getElementById('check-btn');
            const adminPanelBtn = document.getElementById('admin-panel-btn');

            let isLogin = true;

            authLink.addEventListener('click', (e) => {
                e.preventDefault();
                isLogin = !isLogin;
                const nameField = document.getElementById('signup-name-field');
                const emailField = document.getElementById('email-address');
                
                document.getElementById('auth-title').textContent = isLogin ? 'Sign in to your account' : 'Create a new account';
                authBtn.textContent = isLogin ? 'Sign in' : 'Sign up';
                authLink.textContent = isLogin ? 'Create a new account' : 'Already have an account? Sign in';
                nameField.style.display = isLogin ? 'none' : 'block';
                emailField.classList.toggle('rounded-t-md', !isLogin);
            });

            authBtn.addEventListener('click', () => {
                const email = document.getElementById('email-address').value;
                const password = document.getElementById('password').value;
                if (isLogin) {
                    handleLogin(email, password);
                } else {
                    const displayName = document.getElementById('full-name').value;
                     if (!email || !password || !displayName) {
                        showNotification("Please fill all fields to sign up.", true);
                        return;
                    }
                    handleSignUp(email, password, displayName);
                }
            });
            
            logoutBtn.addEventListener('click', handleLogout);
            approveBtn.addEventListener('click', approveJobFile);
            rejectBtn.addEventListener('click', () => openModal('reject-reason-modal'));
            confirmRejectBtn.addEventListener('click', rejectJobFile);
            checkBtn.addEventListener('click', checkJobFile);
            adminPanelBtn.addEventListener('click', openAdminPanel);
            
            // Make saveUserRoles globally accessible for the button's onclick
            window.saveUserChanges = saveUserChanges;
        });
    </script>

    <script>
        // --- Data Handling (Local Form) ---
        function getFormData() {
            const getVal = id => document.getElementById(id).value || '';
            const getChecked = query => Array.from(document.querySelectorAll(query)).filter(el => el.checked).map(el => el.dataset.clearance || el.dataset.product);

            const charges = [];
            document.querySelectorAll('#charges-table-body tr').forEach(row => {
                if (row.id === 'total-row') return;
                charges.push({
                    l: row.cells[0].textContent.trim(), // label
                    c: row.querySelector('.cost-input').value || '0', // cost
                    s: row.querySelector('.selling-input').value || '0', // selling
                    n: row.querySelector('.notes-input').value || '' // notes
                });
            });

            return {
                d: getVal('date'), po: getVal('po-number'), jfn: getVal('job-file-no'), t: getVal('type'),
                cl: getChecked('[data-clearance]:checked'), pt: getChecked('[data-product]:checked'),
                in: getVal('invoice-no'), bd: getVal('billing-date'), sm: getVal('salesman'),
                sh: getVal('shipper-name'), co: getVal('consignee-name'),
                mawb: getVal('mawb'), hawb: getVal('hawb'), ts: getVal('teams-of-shipping'), or: getVal('origin'),
                pc: getVal('no-of-pieces'), gw: getVal('gross-weight'), de: getVal('destination'), vw: getVal('volume-weight'),
                dsc: getVal('description'), ca: getVal('carrier'), tn: getVal('truck-no'),
                vn: getVal('vessel-name'), fv: getVal('flight-voyage-no'), cn: getVal('container-no'),
                ch: charges,
                re: getVal('remarks'),
                pb: getVal('prepared-by'),
                // checkedBy and approvedBy are handled by their respective systems
            };
        }

        function populateFormFromData(data) {
            const setVal = (id, value) => { if (document.getElementById(id)) document.getElementById(id).value = value || ''; };
            const setChecked = (type, values) => {
                document.querySelectorAll(`[data-KD{type}]`).forEach(el => {
                    el.checked = (values || []).includes(el.dataset[type]);
                });
            };

            setVal('date', data.d); setVal('po-number', data.po); setVal('job-file-no', data.jfn);
            setVal('type', data.t); setVal('invoice-no', data.in); setVal('billing-date', data.bd);
            setVal('salesman', data.sm); setVal('shipper-name', data.sh); setVal('consignee-name', data.co);
            setVal('mawb', data.mawb); setVal('hawb', data.hawb); setVal('teams-of-shipping', data.ts);
            setVal('origin', data.or); setVal('no-of-pieces', data.pc); setVal('gross-weight', data.gw);
            setVal('destination', data.de); setVal('volume-weight', data.vw); setVal('description', data.dsc);
            setVal('carrier', data.ca); setVal('truck-no', data.tn); setVal('vessel-name', data.vn);
            setVal('flight-voyage-no', data.fv); setVal('container-no', data.cn);
            setVal('remarks', data.re); setVal('prepared-by', data.pb);
            
            // Handle check status
            const checkBtn = document.getElementById('check-btn');
            const checkedStamp = document.getElementById('checked-stamp');
            if (data.checkedBy) {
                const checkedDate = data.checkedAt?.toDate() ? ` on KD{data.checkedAt.toDate().toLocaleDateString()}` : '';
                setVal('checked-by', `KD{data.checkedBy}KD{checkedDate}`);
                checkBtn.disabled = true;
                checkBtn.textContent = 'Checked';
                checkedStamp.style.display = 'block';
            } else {
                setVal('checked-by', 'Pending Check');
                checkBtn.disabled = false;
                checkBtn.textContent = 'Check Job File';
                checkedStamp.style.display = 'none';
            }
            
            // Handle approval/rejection status
            const approveBtn = document.getElementById('approve-btn');
            const rejectBtn = document.getElementById('reject-btn');
            const approvedStamp = document.getElementById('approved-stamp');
            const rejectedStamp = document.getElementById('rejected-stamp');
            const rejectionBanner = document.getElementById('rejection-banner');

            approvedStamp.style.display = 'none';
            rejectedStamp.style.display = 'none';
            rejectionBanner.style.display = 'none';
            document.getElementById('approval-buttons').style.display = 'flex';

            if (data.status === 'approved') {
                const approvedDate = data.approvedAt?.toDate() ? ` on KD{data.approvedAt.toDate().toLocaleDateString()}` : '';
                setVal('approved-by', `KD{data.approvedBy}KD{approvedDate}`);
                document.getElementById('approval-buttons').style.display = 'none';
                approvedStamp.style.display = 'block';
            } else if (data.status === 'rejected') {
                const rejectedDate = data.rejectedAt?.toDate() ? ` on KD{data.rejectedAt.toDate().toLocaleDateString()}` : '';
                setVal('approved-by', `Rejected by KD{data.rejectedBy}KD{rejectedDate}`);
                document.getElementById('approval-buttons').style.display = 'none';
                rejectedStamp.style.display = 'block';
                rejectionBanner.style.display = 'block';
                document.getElementById('rejection-reason').textContent = data.rejectionReason;
            } else {
                setVal('approved-by', 'Pending Approval');
            }


            setChecked('clearance', data.cl);
            setChecked('product', data.pt);

            if (data.ch) {
                populateTable(); // First clear and build the table structure
                const rows = document.querySelectorAll('#charges-table-body tr:not(#total-row)');
                rows.forEach((row, index) => {
                    const chargeKey = row.cells[0].textContent.trim();
                    const chargeData = data.ch.find(c => c.l === chargeKey);
                    if (chargeData) {
                        row.querySelector('.cost-input').value = chargeData.c;
                        row.querySelector('.selling-input').value = chargeData.s;
                        row.querySelector('.notes-input').value = chargeData.n;
                    }
                });
            }
            calculate();
        }
        
        // --- Print and Calculation Logic ---
        function getPrintViewHtml(data) {
            let totalCost = 0, totalSelling = 0, totalProfit = 0;
            (data.ch || []).forEach(c => {
                const cost = parseFloat(c.c) || 0;
                const selling = parseFloat(c.s) || 0;
                totalCost += cost;
                totalSelling += selling;
                totalProfit += (selling - cost);
            });
            
            const checkedByText = data.checkedBy ? `KD{data.checkedBy} on KD{data.checkedAt?.toDate().toLocaleDateString()}` : 'Pending';
            let approvedByText = 'Pending Approval';
            if (data.status === 'approved') {
                approvedByText = `KD{data.approvedBy} on KD{data.approvedAt?.toDate().toLocaleDateString()}`;
            } else if (data.status === 'rejected') {
                approvedByText = `REJECTED: KD{data.rejectionReason}`;
            }

            const checkedSymbol = '';
            const uncheckedSymbol = '';
            const printHTML = `
                <div class="border border-gray-700 p-2 bg-white">
                    <div class="grid grid-cols-12 gap-px bg-gray-700" style="border: 1px solid #374151;">
                         <div class="col-span-3 bg-white p-1 flex items-center" style="border: 1px solid #374151;">
                            <div id="print-logo-container" class="text-xl font-bold" style="color: #0E639C;">Q'go<span style="color: #4FB8AF;">Cargo</span></div>
                        </div>
                        <div class="col-span-6 bg-white flex items-center justify-center text-xl font-bold" style="border: 1px solid #374151;">JOB FILE</div>
                        <div class="col-span-3 bg-white p-1 text-xs" style="border: 1px solid #374151;"><div><strong>Date:</strong> KD{data.d || ''}</div><div><strong>P.O. #:</strong> KD{data.po || ''}</div></div>
                        
                        <div class="col-span-8 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Job File No.:</strong> KD{data.jfn || ''}</div>
                        <div class="col-span-4 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Type:</strong> KD{data.t || ''}</div>

                        <div class="col-span-12 bg-white p-1 grid grid-cols-4 gap-2 text-xs" style="border: 1px solid #374151;">
                            <div><strong>Clearance</strong><br>KD{(data.cl || []).includes('Export') ? checkedSymbol : uncheckedSymbol} Export<br>KD{(data.cl || []).includes('Import') ? checkedSymbol : uncheckedSymbol} Import<br>KD{(data.cl || []).includes('Clearance') ? checkedSymbol : uncheckedSymbol} Clearance<br>KD{(data.cl || []).includes('Local Move') ? checkedSymbol : uncheckedSymbol} Local Move</div>
                            <div><strong>Product Type</strong><br>KD{(data.pt || []).includes('Air Freight') ? checkedSymbol : uncheckedSymbol} Air<br>KD{(data.pt || []).includes('Sea Freight') ? checkedSymbol : uncheckedSymbol} Sea<br>KD{(data.pt || []).includes('Land Freight') ? checkedSymbol : uncheckedSymbol} Land<br>KD{(data.pt || []).includes('Others') ? checkedSymbol : uncheckedSymbol} Others</div>
                        </div>

                        <div class="col-span-6 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Invoice No.:</strong><div class="print-field">KD{data.in || ''}</div></div>
                        <div class="col-span-6 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Billing Date:</strong><div class="print-field">KD{data.bd || ''}</div></div>
                        <div class="col-span-12 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Salesman:</strong><div class="print-field">KD{data.sm || ''}</div></div>

                        <div class="col-span-6 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Shipper's Name:</strong><div class="print-field">KD{data.sh || ''}</div></div>
                        <div class="col-span-6 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Consignee's Name:</strong><div class="print-field">KD{data.co || ''}</div></div>
                        
                        <div class="col-span-6 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>MAWB/OBL/TCN:</strong><div class="print-field">KD{data.mawb || ''}</div></div>
                        <div class="col-span-6 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Teams of Shipping:</strong><div class="print-field">KD{data.ts || ''}</div></div>
                        <div class="col-span-6 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>HAWB/HBL:</strong><div class="print-field">KD{data.hawb || ''}</div></div>
                        <div class="col-span-3 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Origin:</strong><div class="print-field">KD{data.or || ''}</div></div>
                        <div class="col-span-3 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Destination:</strong><div class="print-field">KD{data.de || ''}</div></div>
                        <div class="col-span-3 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>No. of Pieces:</strong><div class="print-field">KD{data.pc || ''}</div></div>
                        <div class="col-span-3 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Gross Wt:</strong><div class="print-field">KD{data.gw || ''}</div></div>
                        <div class="col-span-6 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Volume Wt:</strong><div class="print-field">KD{data.vw || ''}</div></div>
                        
                        <div class="col-span-12 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Description:</strong><div class="print-field">KD{data.dsc || ''}</div></div>
                        <div class="col-span-6 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Carrier/Line/Trucking:</strong><div class="print-field">KD{data.ca || ''}</div></div>
                        <div class="col-span-6 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Truck/Driver:</strong><div class="print-field">KD{data.tn || ''}</div></div>
                        <div class="col-span-4 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Vessel:</strong><div class="print-field">KD{data.vn || ''}</div></div>
                        <div class="col-span-4 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Flight/Voyage:</strong><div class="print-field">KD{data.fv || ''}</div></div>
                        <div class="col-span-4 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Container No:</strong><div class="print-field">KD{data.cn || ''}</div></div>

                        <div class="col-span-12 bg-white p-0" style="border: 1px solid #374151;">
                            <table class="print-table w-full text-xs">
                                <thead><tr><th>Description</th><th>Cost</th><th>Selling</th><th>Profit</th><th>Notes</th></tr></thead>
                                <tbody>
                                    KD{(data.ch || []).map(c => `<tr><td>KD{c.l}</td><td>KD{c.c}</td><td>KD{c.s}</td><td>KD{(parseFloat(c.s || 0) - parseFloat(c.c || 0)).toFixed(2)}</td><td>KD{c.n}</td></tr>`).join('')}
                                    <tr class="font-bold bg-gray-100"><td>TOTAL:</td><td>KD{totalCost.toFixed(2)}</td><td>KD{totalSelling.toFixed(2)}</td><td>KD{totalProfit.toFixed(2)}</td><td></td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="col-span-12 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>REMARKS:</strong><div class="print-field h-20">KD{(data.re || '').replace(/\n/g, '<br>')}</div></div>
                        <div class="col-span-3 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>PREPARED BY:</strong><div class="print-field">KD{data.pb || ''}</div></div>
                        <div class="col-span-3 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>CHECKED BY:</strong><div class="print-field">KD{checkedByText}</div></div>
                        <div class="col-span-3 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>APPROVED BY:</strong><div class="print-field">KD{approvedByText}</div></div>
                        <div class="col-span-3 bg-white p-1 flex items-center justify-center" style="border: 1px solid #374151;"><div class="qrcode-container"></div></div>
                    </div>
                </div>`;
            
            // Create a temporary div to generate QR code
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = printHTML;
            const qrText = `JobFile No: KD{data.jfn}\nDate: KD{data.d}\nShipper: KD{data.sh}\nConsignee: KD{data.co}`;
            new QRCode(tempDiv.querySelector('.qrcode-container'), { text: qrText, width: 96, height: 96, correctLevel: QRCode.CorrectLevel.H });
            
            return tempDiv.innerHTML;
        }

        function generatePrintView() {
            const data = getFormData();
            const printHTML = getPrintViewHtml(data);
            const printContainer = document.getElementById('print-output');
            printContainer.innerHTML = printHTML;
        }

        function saveAsPdf() {
            showLoader();
            const data = getFormData();
            const element = document.createElement('div');
            element.innerHTML = getPrintViewHtml(data);
            
            const jobFileNo = data.jfn || 'JobFile';
            const date = data.d || new Date().toISOString().slice(0,10);
            const opt = { margin: 0.2, filename: `KD{jobFileNo}_KD{date}.pdf`, image: { type: 'jpeg', quality: 1.0 }, html2canvas:  { scale: 3 }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } };
            setTimeout(() => { html2pdf().from(element).set(opt).save().then(hideLoader); }, 500);
        }

        function printPage() {
            document.getElementById('main-container').classList.add('hidden');
            const printContainer = document.getElementById('print-output');
            printContainer.classList.remove('hidden');
            generatePrintView();
            setTimeout(() => { window.print(); }, 500);
        }

        function calculate() {
            let totalCost = 0, totalSelling = 0, totalProfit = 0;
            document.querySelectorAll('#charges-table-body tr:not(#total-row)').forEach(row => {
                const cost = parseFloat(row.querySelector('.cost-input').value) || 0;
                const selling = parseFloat(row.querySelector('.selling-input').value) || 0;
                const profit = selling - cost;
                row.cells[3].textContent = profit.toFixed(2);
                totalCost += cost; totalSelling += selling; totalProfit += profit;
            });
            document.getElementById('total-cost').textContent = totalCost.toFixed(2);
            document.getElementById('total-selling').textContent = totalSelling.toFixed(2);
            document.getElementById('total-profit').textContent = totalProfit.toFixed(2);
        }
        
        function populateTable() {
            const chargeKeys = ["Ex-works Charges:", "Land/Air / Sea Freight:", "Fuell Security / War Surcharge:", "Formalities:", "Delivery Order Fee:", "Transportation Charges:", "Inspection / Computer Print Charges:", "Handling Charges:", "Labor / Forklift Charges:", "Documentation Charges:", "Clearance Charges:", "Customs Duty:", "Terminal Handling Charges:", "Legalization Charges:", "Demurrage Charges:", "Loading / Offloading Charges:", "Destination Clearance Charges:", "Packing Charges:", "Port Charges:", "Other Charges:", "PAI Approval :", "Insurance Fee :", "EPA Charges :"];
            const tableBody = document.getElementById('charges-table-body');
            let rowsHtml = chargeKeys.map(key => `<tr><td class="table-cell font-medium text-gray-700">KD{key}</td><td class="table-cell"><input type="text" class="cost-input input-field"></td><td class="table-cell"><input type="text" class="selling-input input-field"></td><td class="table-cell profit-output bg-gray-50"></td><td class="table-cell"><input type="text" class="notes-input input-field"></td></tr>`).join('');
            rowsHtml += `<tr id="total-row" class="bg-gray-100 font-bold"><td class="table-cell text-right">TOTAL:</td><td id="total-cost" class="table-cell"></td><td id="total-selling" class="table-cell"></td><td id="total-profit" class="table-cell"></td><td class="table-cell"></td></tr>`;
            tableBody.innerHTML = rowsHtml;
        }
        
        function setupEventListeners() {
            document.getElementById('charges-table-body').addEventListener('input', e => {
                if (e.target.classList.contains('cost-input') || e.target.classList.contains('selling-input')) {
                    calculate();
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            populateTable();
            setupEventListeners();
            calculate();
            document.getElementById('date').valueAsDate = new Date();
        });
    </script>
</body>
</html>
