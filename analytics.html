<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - Q'go Cargo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <div class="text-2xl font-bold" style="color: #0E639C;">
                        Q'go<span style="color: #4FB8AF;">Cargo</span>
                    </div>
                    <span class="text-gray-400">|</span>
                    <span class="text-lg font-semibold text-gray-700">Analytics Dashboard</span>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="index.html" class="text-gray-600 hover:text-gray-900">Dashboard</a>
                    <a href="job-file.html" class="text-gray-600 hover:text-gray-900">Job Files</a>
                    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md text-sm">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div class="px-4 py-6 sm:px-0">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-900">Analytics Dashboard</h1>
                <p class="mt-2 text-gray-600">Monitor your job files performance and analytics</p>
            </div>

            <!-- Analytics Content -->
            <div id="analytics-body" class="space-y-6">
                <div class="text-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"></div>
                    <p class="mt-4 text-gray-600">Loading analytics data...</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAAulR2nJQm-4QtNyEqKTnnDPw-iKW92Mc",
            authDomain: "my-job-file-system.firebaseapp.com",
            projectId: "my-job-file-system",
            storageBucket: "my-job-file-system.appspot.com",
            messagingSenderId: "145307873304",
            appId: "1:145307873304:web:d661ea6ec118801b4a136d",
            measurementId: "G-8EHX5K7YHL"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let jobFilesCache = [];
        let currentFilteredJobs = [];
        let profitChartInstance = null;

        // Check authentication
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
            const userDocRef = doc(db, 'users', user.uid);
            const userDoc = await getDoc(userDocRef);
            
            if (!userDoc.exists() || userDoc.data().status === 'inactive') {
                window.location.href = 'login.html';
                return;
            }

            currentUser = { uid: user.uid, email: user.email, ...userDoc.data() };
            loadJobFiles();
        });

        async function loadJobFiles() {
            try {
                const jobFilesQuery = query(collection(db, 'jobfiles'), orderBy('createdAt', 'desc'));
                const querySnapshot = await getDocs(jobFilesQuery);
                
                jobFilesCache = [];
                querySnapshot.forEach(doc => {
                    jobFilesCache.push({ id: doc.id, ...doc.data() });
                });

                filterAnalyticsByTimeframe('all', 'bd');
            } catch (error) {
                console.error('Error loading job files:', error);
                document.getElementById('analytics-body').innerHTML = '<div class="text-center py-12 text-red-600">Error loading analytics data</div>';
            }
        }

        function filterAnalyticsByTimeframe(timeframe, dateType = 'bd') {
            currentFilteredJobs = jobFilesCache;
            const now = new Date();
            const currentYear = now.getFullYear();
            const lastYear = currentYear - 1;

            if (timeframe !== 'all') {
                currentFilteredJobs = jobFilesCache.filter(job => {
                    const dateField = dateType === 'bd' ? job.bd : job.d;
                    if (!dateField) return false;
                    const jobDate = new Date(dateField);
                    if (timeframe === 'thisYear') {
                        return jobDate.getFullYear() === currentYear;
                    }
                    if (timeframe === 'lastYear') {
                        return jobDate.getFullYear() === lastYear;
                    }
                    if (timeframe.includes('-')) {
                        const [year, month] = timeframe.split('-').map(Number);
                        return jobDate.getFullYear() === year && jobDate.getMonth() === month - 1;
                    }
                    return true;
                });
            }
            calculateAndDisplayAnalytics(currentFilteredJobs);
        }

        function calculateAndDisplayAnalytics(jobs) {
            const body = document.getElementById('analytics-body');
            if (jobs.length === 0) {
                body.innerHTML = `
                    <div class="space-y-3">
                        <div class="flex items-center justify-center gap-4">
                            <label for="analytics-date-type" class="text-sm font-medium">Report Date Type:</label>
                            <select id="analytics-date-type" class="border border-gray-300 rounded-md px-3 py-2">
                                <option value="bd">Billing Date</option>
                                <option value="d">Opening Date</option>
                            </select>
                        </div>
                        <div class="flex justify-center flex-wrap gap-2">
                            <button data-timeframe="all" class="timeframe-btn bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded">All Time</button>
                            <button data-timeframe="thisYear" class="timeframe-btn bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded">This Year</button>
                            <button data-timeframe="lastYear" class="timeframe-btn bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded">Last Year</button>
                        </div>
                    </div>
                    <p class="text-center text-gray-500 mt-8">No data available for the selected period.</p>`;
                
                setupEventListeners();
                return;
            }

            let totalJobs = jobs.length;
            let totalRevenue = 0;
            let totalCost = 0;
            let totalProfit = 0;
            const profitByFile = [];
            const profitByShipper = {};
            const profitByConsignee = {};
            const monthlyStatsByBilling = {};
            const monthlyStatsByOpening = {};
            const profitByUser = {};
            const profitBySalesman = {};

            jobs.forEach(job => {
                const profit = job.totalProfit || 0;
                const revenue = job.totalSelling || 0;
                const cost = job.totalCost || 0;
                const creator = job.createdBy || 'Unknown';
                const salesman = job.sm || 'N/A';
                let status = 'Pending Check';
                if (job.status === 'rejected') status = 'Rejected';
                else if (job.status === 'approved') status = 'Approved';
                else if (job.status === 'checked') status = 'Checked';

                totalRevenue += revenue;
                totalCost += cost;
                totalProfit += profit;

                profitByFile.push({ 
                    id: job.id, 
                    jfn: job.jfn, 
                    shipper: job.sh, 
                    consignee: job.co, 
                    profit: profit, 
                    status: status, 
                    date: job.updatedAt?.toDate() || new Date(0), 
                    cost: cost, 
                    dsc: job.dsc, 
                    mawb: job.mawb, 
                    createdBy: creator 
                });

                if (job.sh) {
                    profitByShipper[job.sh] = (profitByShipper[job.sh] || 0) + profit;
                }
                if (job.co) {
                    profitByConsignee[job.co] = (profitByConsignee[job.co] || 0) + profit;
                }
                if (job.bd) {
                    const month = job.bd.substring(0, 7);
                    if (!monthlyStatsByBilling[month]) {
                        monthlyStatsByBilling[month] = { profit: 0, count: 0, jobs: [] };
                    }
                    monthlyStatsByBilling[month].profit += profit;
                    monthlyStatsByBilling[month].count++;
                    monthlyStatsByBilling[month].jobs.push(job);
                }
                if (job.d) {
                    const month = job.d.substring(0, 7);
                    if (!monthlyStatsByOpening[month]) {
                        monthlyStatsByOpening[month] = { profit: 0, count: 0, jobs: [] };
                    }
                    monthlyStatsByOpening[month].profit += profit;
                    monthlyStatsByOpening[month].count++;
                    monthlyStatsByOpening[month].jobs.push(job);
                }
                
                if (!profitByUser[creator]) {
                    profitByUser[creator] = { count: 0, profit: 0, jobs: [] };
                }
                profitByUser[creator].count++;
                profitByUser[creator].profit += profit;
                profitByUser[creator].jobs.push(job);

                if (salesman !== 'N/A') {
                    if (!profitBySalesman[salesman]) {
                        profitBySalesman[salesman] = { count: 0, profit: 0, jobs: [] };
                    }
                    profitBySalesman[salesman].count++;
                    profitBySalesman[salesman].profit += profit;
                    profitBySalesman[salesman].jobs.push(job);
                }
            });

            const analyticsData = {
                totalJobs, totalRevenue, totalCost, totalProfit, profitByFile,
                profitByShipper: Object.entries(profitByShipper).sort((a, b) => b[1] - a[1]),
                profitByConsignee: Object.entries(profitByConsignee).sort((a, b) => b[1] - a[1]),
                monthlyStatsByBilling: Object.entries(monthlyStatsByBilling).sort((a, b) => a[0].localeCompare(b[0])),
                monthlyStatsByOpening: Object.entries(monthlyStatsByOpening).sort((a, b) => a[0].localeCompare(b[0])),
                profitByUser: Object.entries(profitByUser).sort((a, b) => b[1].profit - a[1].profit),
                profitBySalesman: Object.entries(profitBySalesman).sort((a, b) => b[1].profit - a[1].profit)
            };

            displayAnalytics(analyticsData);
        }

        function displayAnalytics(data, sortBy = 'profit-desc', searchTerm = '', monthlyReportType = 'billing') {
            const body = document.getElementById('analytics-body');
            
            let filteredFiles = data.profitByFile;

            if (searchTerm) {
                const lowerCaseSearchTerm = searchTerm.toLowerCase();
                filteredFiles = data.profitByFile.filter(file => 
                    (file.jfn || '').toLowerCase().includes(lowerCaseSearchTerm) ||
                    (file.shipper || '').toLowerCase().includes(lowerCaseSearchTerm) ||
                    (file.consignee || '').toLowerCase().includes(lowerCaseSearchTerm) ||
                    (file.mawb || '').toLowerCase().includes(lowerCaseSearchTerm) ||
                    (file.createdBy || '').toLowerCase().includes(lowerCaseSearchTerm)
                );
            }
            
            const monthlyStats = monthlyReportType === 'billing' ? data.monthlyStatsByBilling : data.monthlyStatsByOpening;
            const monthlyReportTitle = monthlyReportType === 'billing' ? 'Profit By Month (Billing Date)' : 'Profit By Month (Opening Date)';

            const now = new Date();
            const currentYear = now.getFullYear();
            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            let monthButtons = '';
            for(let i=0; i < 12; i++) {
                const monthStr = `${currentYear}-${String(i + 1).padStart(2, '0')}`;
                monthButtons += `<button data-timeframe="${monthStr}" class="timeframe-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-1 px-3 rounded text-sm">${months[i]}</button>`;
            }

            const sortedFiles = [...filteredFiles];
            if (sortBy === 'profit-desc') {
                sortedFiles.sort((a, b) => b.profit - a.profit);
            } else if (sortBy === 'date-desc') {
                sortedFiles.sort((a, b) => b.date - a.date);
            } else if (sortBy === 'status') {
                const statusOrder = { 'Pending Check': 1, 'Checked': 2, 'Approved': 3, 'Rejected': 4 };
                sortedFiles.sort((a, b) => (statusOrder[a.status] || 99) - (statusOrder[b.status] || 99));
            } else if (sortBy === 'user') {
                sortedFiles.sort((a, b) => (a.createdBy || '').localeCompare(b.createdBy || ''));
            }

            body.innerHTML = `
                <!-- Timeframe Filters -->
                <div class="space-y-3">
                    <div class="flex items-center justify-center gap-4">
                         <label for="analytics-date-type" class="text-sm font-medium">Report Date Type:</label>
                         <select id="analytics-date-type" class="border border-gray-300 rounded-md px-3 py-2">
                            <option value="bd" ${monthlyReportType === 'bd' ? 'selected' : ''}>Billing Date</option>
                            <option value="d" ${monthlyReportType === 'd' ? 'selected' : ''}>Opening Date</option>
                        </select>
                    </div>
                    <div class="flex justify-center flex-wrap gap-2">
                        <button data-timeframe="all" class="timeframe-btn bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded">All Time</button>
                        <button data-timeframe="thisYear" class="timeframe-btn bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded">This Year</button>
                        <button data-timeframe="lastYear" class="timeframe-btn bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded">Last Year</button>
                    </div>
                    <div class="flex justify-center flex-wrap gap-1">
                        ${monthButtons}
                    </div>
                </div>

                <!-- Overall Summary -->
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 text-center mt-6">
                    <div class="bg-white p-6 rounded-lg shadow"><p class="text-sm text-gray-600">Total Jobs</p><p class="text-2xl font-bold">${data.totalJobs}</p></div>
                    <div class="bg-white p-6 rounded-lg shadow"><p class="text-sm text-blue-800">Total Revenue</p><p class="text-2xl font-bold text-blue-900">KD ${data.totalRevenue.toFixed(2)}</p></div>
                    <div class="bg-white p-6 rounded-lg shadow"><p class="text-sm text-red-800">Total Cost</p><p class="text-2xl font-bold text-red-900">KD ${data.totalCost.toFixed(2)}</p></div>
                    <div class="bg-white p-6 rounded-lg shadow"><p class="text-sm text-green-800">Total Profit</p><p class="text-2xl font-bold text-green-900">KD ${data.totalProfit.toFixed(2)}</p></div>
                </div>

                <!-- Profit Chart -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-semibold mb-4">Monthly Profit Chart</h3>
                    <div style="position: relative; height:300px;">
                        <canvas id="profit-chart"></canvas>
                    </div>
                </div>

                <!-- Detailed Breakdowns -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h4 class="text-lg font-semibold mb-4">Top Profitable Shippers</h4>
                        <div class="space-y-2">
                            ${data.profitByShipper.slice(0, 5).map(([name, profit]) => `
                                <div class="flex justify-between">
                                    <span class="text-sm">${name}</span>
                                    <span class="text-sm font-semibold">KD ${profit.toFixed(2)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h4 class="text-lg font-semibold mb-4">Top Profitable Consignees</h4>
                        <div class="space-y-2">
                            ${data.profitByConsignee.slice(0, 5).map(([name, profit]) => `
                                <div class="flex justify-between">
                                    <span class="text-sm">${name}</span>
                                    <span class="text-sm font-semibold">KD ${profit.toFixed(2)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h4 class="text-lg font-semibold mb-4">Top Users by Profit</h4>
                        <div class="space-y-2">
                            ${data.profitByUser.slice(0, 5).map(([name, stats]) => `
                                <div class="flex justify-between">
                                    <span class="text-sm">${name} (${stats.count})</span>
                                    <span class="text-sm font-semibold">KD ${stats.profit.toFixed(2)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>

                <!-- Job File Details -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                        <h4 class="text-lg font-semibold">Job File Details</h4>
                        <div class="flex items-center gap-4 w-full sm:w-auto">
                            <input type="text" id="analytics-search-bar" class="border border-gray-300 rounded-md px-3 py-2 flex-grow sm:w-64" placeholder="Search files..." value="${searchTerm}">
                            <select id="sort-analytics" class="border border-gray-300 rounded-md px-3 py-2">
                                <option value="profit-desc" ${sortBy === 'profit-desc' ? 'selected' : ''}>Profit (High to Low)</option>
                                <option value="date-desc" ${sortBy === 'date-desc' ? 'selected' : ''}>Date (Newest First)</option>
                                <option value="status" ${sortBy === 'status' ? 'selected' : ''}>Status</option>
                                <option value="user" ${sortBy === 'user' ? 'selected' : ''}>User</option>
                            </select>
                            <button onclick="downloadAnalyticsCsv()" class="bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded">CSV</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job Details</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cost / Profit</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${sortedFiles.length > 0 ? sortedFiles.map(file => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm font-medium text-gray-900">${file.jfn || file.id}</div>
                                            <div class="text-sm text-gray-500">Shipper: ${file.shipper || 'N/A'}</div>
                                            <div class="text-sm text-gray-500">Consignee: ${file.consignee || 'N/A'}</div>
                                            <div class="text-sm text-gray-500">Created by: ${file.createdBy || 'N/A'}</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm font-medium text-green-600">KD ${file.profit.toFixed(2)}</div>
                                            <div class="text-sm text-red-600">Cost: KD ${file.cost.toFixed(2)}</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                                file.status === 'Approved' ? 'bg-green-100 text-green-800' :
                                                file.status === 'Rejected' ? 'bg-red-100 text-red-800' :
                                                file.status === 'Checked' ? 'bg-blue-100 text-blue-800' :
                                                'bg-yellow-100 text-yellow-800'
                                            }">
                                                ${file.status}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                            <a href="job-file.html" class="text-indigo-600 hover:text-indigo-900">View</a>
                                        </td>
                                    </tr>
                                `).join('') : `<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No files match your search.</td></tr>`}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            renderProfitChart(data, monthlyReportType);
            setupEventListeners();
        }

        function renderProfitChart(data, monthlyReportType) {
            if (profitChartInstance) {
                profitChartInstance.destroy();
            }

            const ctx = document.getElementById('profit-chart')?.getContext('2d');
            if (!ctx) return;
            
            const monthlyStats = monthlyReportType === 'billing' ? data.monthlyStatsByBilling : data.monthlyStatsByOpening;
            
            let year = new Date().getFullYear();
            if (currentFilteredJobs.length > 0) {
                const dateField = monthlyReportType === 'billing' ? currentFilteredJobs[0].bd : currentFilteredJobs[0].d;
                if(dateField) year = new Date(dateField).getFullYear();
            }

            const labels = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const profits = Array(12).fill(0);
            
            monthlyStats.forEach(([monthStr, stats]) => {
                const [statYear, statMonth] = monthStr.split('-').map(Number);
                if (statYear === year) {
                    profits[statMonth - 1] = stats.profit;
                }
            });

            const maxProfit = Math.max(...profits.map(p => Math.abs(p)));

            const backgroundColors = profits.map(p => {
                if (p === 0) return 'rgba(201, 203, 207, 0.6)';
                const alpha = Math.max(0.2, Math.abs(p) / (maxProfit || 1));
                return p > 0 ? `rgba(75, 192, 192, ${alpha})` : `rgba(255, 99, 132, ${alpha})`;
            });

            profitChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Monthly Profit for ${year}`,
                        data: profits,
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors.map(c => c.replace('0.6', '1').replace('0.2','1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'KD ' + value;
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'KD ' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }

        function setupEventListeners() {
            document.getElementById('analytics-search-bar')?.addEventListener('input', (e) => {
                // Re-render with search term
                const currentData = getCurrentAnalyticsData();
                if (currentData) {
                    displayAnalytics(currentData, document.getElementById('sort-analytics')?.value || 'profit-desc', e.target.value, document.getElementById('analytics-date-type')?.value || 'billing');
                }
            });

            document.getElementById('sort-analytics')?.addEventListener('change', (e) => {
                const currentData = getCurrentAnalyticsData();
                if (currentData) {
                    displayAnalytics(currentData, e.target.value, document.getElementById('analytics-search-bar')?.value || '', document.getElementById('analytics-date-type')?.value || 'billing');
                }
            });

            document.getElementById('analytics-date-type')?.addEventListener('change', (e) => {
                const activeTimeframeButton = document.querySelector('.timeframe-btn.bg-indigo-700') || document.querySelector('[data-timeframe="all"]');
                filterAnalyticsByTimeframe(activeTimeframeButton?.dataset.timeframe || 'all', e.target.value);
            });

            document.querySelectorAll('.timeframe-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.timeframe-btn').forEach(b => {
                        b.classList.remove('bg-indigo-700', 'text-white');
                        if(!b.classList.contains('bg-gray-200')) {
                           b.classList.add('bg-indigo-500');
                        }
                    });
                    e.target.classList.remove('bg-indigo-500', 'bg-gray-200');
                    e.target.classList.add('bg-indigo-700', 'text-white');
                    const timeframe = e.target.dataset.timeframe;
                    const dateType = document.getElementById('analytics-date-type')?.value || 'bd';
                    filterAnalyticsByTimeframe(timeframe, dateType);
                });
            });
        }

        function getCurrentAnalyticsData() {
            // This would need to be stored globally or recalculated
            // For now, we'll recalculate from currentFilteredJobs
            if (currentFilteredJobs.length === 0) return null;
            
            // Recalculate analytics data
            let totalJobs = currentFilteredJobs.length;
            let totalRevenue = 0;
            let totalCost = 0;
            let totalProfit = 0;
            const profitByFile = [];

            currentFilteredJobs.forEach(job => {
                const profit = job.totalProfit || 0;
                const revenue = job.totalSelling || 0;
                const cost = job.totalCost || 0;
                const creator = job.createdBy || 'Unknown';
                let status = 'Pending Check';
                if (job.status === 'rejected') status = 'Rejected';
                else if (job.status === 'approved') status = 'Approved';
                else if (job.status === 'checked') status = 'Checked';

                totalRevenue += revenue;
                totalCost += cost;
                totalProfit += profit;

                profitByFile.push({ 
                    id: job.id, 
                    jfn: job.jfn, 
                    shipper: job.sh, 
                    consignee: job.co, 
                    profit: profit, 
                    status: status, 
                    date: job.updatedAt?.toDate() || new Date(0), 
                    cost: cost, 
                    dsc: job.dsc, 
                    mawb: job.mawb, 
                    createdBy: creator 
                });
            });

            return {
                totalJobs, totalRevenue, totalCost, totalProfit, profitByFile,
                profitByShipper: [],
                profitByConsignee: [],
                monthlyStatsByBilling: [],
                monthlyStatsByOpening: [],
                profitByUser: [],
                profitBySalesman: []
            };
        }

        window.downloadAnalyticsCsv = function() {
            let csvContent = "data:text/csv;charset=utf-8,Job File ID,Shipper,Consignee,Profit,Status,Cost,Description,AWB/MAWB,Created By\n";
            
            currentFilteredJobs.forEach(job => {
                const rowData = [
                    job.jfn || job.id, 
                    job.sh || 'N/A', 
                    job.co || 'N/A', 
                    (job.totalProfit || 0).toFixed(2), 
                    job.status || 'Pending', 
                    (job.totalCost || 0).toFixed(2), 
                    job.dsc || 'N/A', 
                    job.mawb || 'N/A', 
                    job.createdBy || 'N/A'
                ];
                const row = rowData.map(d => `"${String(d).replace(/"/g, '""')}"`).join(",");
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "job_file_analytics.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        window.logout = async function() {
            await signOut(auth);
            window.location.href = 'login.html';
        };
    </script>
</body>
</html>