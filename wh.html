<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QGO - Live Logistics & Warehouse System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --theme-color: #4f46e5; }
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .container { max-width: 1200px; margin: 1rem auto; padding: 1rem; background-color: white; border-radius: 0.75rem; border-top: 5px solid var(--theme-color); box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; padding: 1rem; }
        .overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background: white; padding: 1.5rem; border-radius: 0.5rem; width: 100%; max-width: 800px; max-height: 90vh; overflow-y: auto; transform: scale(0.9); transition: transform 0.3s; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--theme-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #2d3748; color: white; padding: 1rem 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 2000; text-align: center; transition: transform 0.5s, opacity 0.5s; transform: translateY(100px); opacity: 0; }
        #notification.show { transform: translateY(0); opacity: 1; }
        #signature-pad { border: 2px dashed #d1d5db; border-radius: 0.5rem; cursor: crosshair; width: 100%; height: 200px; }
        .pod-view-section { border: 1px solid #e5e7eb; padding: 1rem; border-radius: 0.5rem; }
        .dashboard-tab { cursor: pointer; padding: 0.5rem 1rem; border-bottom: 2px solid transparent; color: #6b7280; }
        .dashboard-tab-active { border-color: var(--theme-color); color: var(--theme-color); font-weight: 600; }
        .job-category-header { font-size: 1.25rem; font-weight: 700; color: #374151; margin-top: 1.5rem; margin-bottom: 0.75rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem; }
        .job-card { background-color: #ffffff; border: 1px solid #e5e7eb; border-left-width: 4px; padding: 1rem; border-radius: 0.5rem; margin-bottom: 0.75rem; display: flex; flex-direction: column; sm:flex-direction: row; justify-content: space-between; align-items: flex-start; sm:align-items: center; gap: 1rem; transition: box-shadow 0.2s; }
        .job-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .stat-card { background-color: #f9fafb; padding: 1rem; border-radius: 0.5rem; text-align: center; border: 1px solid #e5e7eb; }
        .input-field { border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.5rem 0.75rem; width: 100%; }
        @media print { 
            body * { visibility: hidden; } 
            #pod-document, #pod-document * { visibility: visible; } 
            #pod-document { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; border: none; box-shadow: none; border-radius: 0; }
            .no-print { display: none !important; }
            @page { size: A4; margin: 15mm; } 
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="login-screen" class="hidden min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <div>
                <div class="text-center text-5xl font-extrabold" style="color: #0E639C;">Q'go<span style="color: #4FB8AF;">Cargo</span></div>
                <h2 id="auth-title" class="mt-6 text-center text-3xl font-extrabold text-gray-900">Sign in to your account</h2>
            </div>
            <div class="mt-8 space-y-6 bg-white p-8 rounded-lg shadow-md">
                <div id="approval-message" class="hidden p-4 text-center text-yellow-800 bg-yellow-100 rounded-lg">Your account is awaiting admin approval.</div>
                <div class="rounded-md shadow-sm -space-y-px">
                    <div id="signup-name-field" style="display: none;"><input id="full-name" type="text" class="input-field rounded-t-md" placeholder="Full Name"></div>
                    <div><input id="email-address" type="email" autocomplete="email" required class="input-field" placeholder="Email address"></div>
                    <div><input id="password" type="password" autocomplete="current-password" required class="input-field rounded-b-md" placeholder="Password"></div>
                </div>
                <div><button id="auth-btn" class="w-full flex justify-center py-2 px-4 border rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Sign in</button></div>
                <p class="mt-2 text-center text-sm text-gray-600"><a href="#" id="auth-link" class="font-medium text-indigo-600 hover:text-indigo-500">Create a new account</a></p>
            </div>
        </div>
    </div>

    <div id="app-container" class="container hidden"></div>
    
    <div id="worker-delivery-page" class="hidden"></div>
    <div id="final-pod-page" class="hidden"></div>
    <div id="public-pod-view" class="hidden bg-white p-8 min-h-screen"></div>
    
    <div id="loader-overlay" class="overlay hidden"><div class="loader"></div></div>
    <div id="notification"></div>
    <div id="view-pod-modal" class="overlay"><div id="view-pod-modal-content" class="modal-content"></div></div>
    <div id="assign-worker-modal" class="overlay"><div class="modal-content" style="max-width: 400px;"></div></div>
    <div id="inventory-modal" class="overlay"><div class="modal-content" style="max-width: 500px;"></div></div>
    <div id="job-details-modal" class="overlay"><div class="modal-content"></div></div>
    <div id="confirm-modal" class="overlay"><div class="modal-content" style="max-width: 400px;"></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, getDocs, writeBatch, serverTimestamp, addDoc, runTransaction, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL, uploadBytes } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAAulR2nJQm-4QtNyEqKTnnDPw-iKW92Mc", authDomain: "my-job-file-system.firebaseapp.com", projectId: "my-job-file-system",
            storageBucket: "my-job-file-system.appspot.com", messagingSenderId: "145307873304", appId: "1:145307873304:web:d661ea6ec118801b4a136d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const auth = getAuth(app);
        
        let currentUser;
        let currentView = 'admin';
        let signaturePad;
        let inventoryCache = [];
        let jobsCache = [];
        let usersCache = [];
        let workersCache = [];

        // --- UI HELPER FUNCTIONS ---
        const showLoader = () => document.getElementById('loader-overlay').classList.add('visible');
        const hideLoader = () => document.getElementById('loader-overlay').classList.remove('visible');
        const openModal = (id) => document.getElementById(id).classList.add('visible');
        window.closeModal = (id) => document.getElementById(id).classList.remove('visible');
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.innerHTML = message;
            notification.style.backgroundColor = isError ? '#c53030' : '#2d3748';
            notification.classList.add('show');
            setTimeout(() => { notification.classList.remove('show'); }, 5000);
        }

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDocRef = doc(db, 'users', user.uid);
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists() && userDoc.data().status === 'active') {
                    currentUser = { uid: user.uid, ...userDoc.data() };
                    if (!currentUser.pod_role) {
                        currentUser.pod_role = (currentUser.role === 'admin' || currentUser.role === 'supervisor') ? 'supervisor' : 'worker';
                    }
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('app-container').style.display = 'block';
                    loadInitialData();
                } else {
                    document.getElementById('approval-message').style.display = 'block';
                    signOut(auth);
                }
            } else {
                currentUser = null;
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('app-container').style.display = 'none';
            }
        });
        
        async function loadInitialData() {
            const usersQuery = query(collection(db, 'users'));
            const userSnapshot = await getDocs(usersQuery);
            usersCache = userSnapshot.docs.map(doc => {
                const userData = doc.data();
                if (!userData.pod_role) {
                    userData.pod_role = (userData.role === 'admin' || userData.role === 'supervisor') ? 'supervisor' : 'worker';
                }
                return { id: doc.id, ...userData };
            });
            workersCache = usersCache.filter(u => u.pod_role === 'worker').map(u => u.displayName);
            renderUIBasedOnRole();
        }

        function renderUIBasedOnRole() {
            const appContainer = document.getElementById('app-container');
            if (currentUser.pod_role === 'supervisor') {
                appContainer.innerHTML = getAdminDashboardShell();
                document.getElementById('dashboard-tab-btn').addEventListener('click', () => switchTab('dashboard'));
                document.getElementById('warehouse-tab-btn').addEventListener('click', () => switchTab('warehouse'));
                document.getElementById('admin-tab-btn').addEventListener('click', () => switchTab('admin'));
                document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
                switchTab('dashboard');
            } else { // Worker
                appContainer.innerHTML = getWorkerDashboardShell();
                document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
                listenForJobFiles();
            }
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.dashboard-tab').forEach(t => t.classList.remove('dashboard-tab-active'));
            document.getElementById(`${tabName}-tab-btn`).classList.add('dashboard-tab-active');
            
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            document.getElementById(`${tabName}-content`).style.display = 'block';

            if (tabName === 'dashboard') {
                document.getElementById('user-display-name').textContent = currentUser.displayName;
                document.getElementById('user-role-display').textContent = currentUser.pod_role;
                document.getElementById('admin-view-btn').addEventListener('click', () => renderTable('admin'));
                document.getElementById('worker-view-btn').addEventListener('click', () => renderTable('worker'));
                document.getElementById('job-search-input').addEventListener('input', (e) => listenForJobFiles(e.target.value));
                renderTable('admin');
            } else if (tabName === 'warehouse') {
                document.getElementById('add-item-btn').style.display = currentUser.canManageWarehouse ? 'block' : 'none';
                listenForInventory();
            } else if (tabName === 'admin') {
                displayAdminPanel();
            }
        }
        
        function displayAdminPanel() {
            const container = document.getElementById('admin-content');
            container.innerHTML = usersCache.map(user => {
                const isCurrentUser = user.id === currentUser.uid;
                return `
                <div class="job-card">
                    <div><p class="font-bold">${user.displayName}</p><p class="text-sm capitalize text-gray-500">Main Role: ${user.role}</p></div>
                    <div class="flex items-center space-x-4">
                        <select data-userid="${user.id}" onchange="updateUserPodRole(this)" class="p-2 border rounded-md text-sm" ${isCurrentUser ? 'disabled' : ''}>
                            <option value="supervisor" ${user.pod_role === 'supervisor' ? 'selected' : ''}>Supervisor</option>
                            <option value="worker" ${user.pod_role === 'worker' ? 'selected' : ''}>Worker</option>
                        </select>
                        <label class="flex items-center text-sm"><input type="checkbox" data-userid="${user.id}" onchange="toggleWarehousePermission(this)" class="mr-2" ${user.canManageWarehouse ? 'checked' : ''} ${isCurrentUser ? 'disabled' : ''}> Can Manage Warehouse</label>
                    </div>
                </div>`;
            }).join('');
        }

        window.updateUserPodRole = async (select) => {
            const userId = select.dataset.userid;
            const newRole = select.value;
            showLoader();
            try {
                await updateDoc(doc(db, 'users', userId), { pod_role: newRole });
                const userInCache = usersCache.find(u => u.id === userId);
                if (userInCache) userInCache.pod_role = newRole;
                showNotification(`POD System Role updated for ${userInCache.displayName}.`);
            } catch (error) {
                 showNotification("Failed to update role.", true);
            } finally {
                hideLoader();
            }
        };

        window.toggleWarehousePermission = async (checkbox) => {
            const userId = checkbox.dataset.userid;
            const canManage = checkbox.checked;
            showLoader();
            try {
                await updateDoc(doc(db, 'users', userId), { canManageWarehouse: canManage });
                const userInCache = usersCache.find(u => u.id === userId);
                if (userInCache) userInCache.canManageWarehouse = canManage;
                showNotification(`Permissions updated for ${userInCache.displayName}.`);
            } catch (error) {
                 showNotification("Failed to update permissions.", true);
                 checkbox.checked = !canManage;
            } finally {
                hideLoader();
            }
        };

        function listenForInventory() {
            const q = query(collection(db, "inventory"));
            onSnapshot(q, (snapshot) => {
                inventoryCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                displayInventory();
            });
        }

        function displayInventory() {
            const container = document.getElementById('inventory-list');
            const canManage = currentUser.canManageWarehouse;
            container.innerHTML = inventoryCache.length === 0 ? `<p class="text-center text-gray-500 p-4">No inventory items found.</p>` : inventoryCache.map(item => `
                <div class="job-card" style="border-left-color: #6b7280;">
                    <div>
                        <p class="font-bold text-lg">${item.name} <span class="text-sm font-normal text-gray-500">${item.sku || ''}</span></p>
                        <p class="text-xs text-gray-500">Category: ${item.category || 'N/A'} | Supplier: ${item.supplier || 'N/A'} | Cost: ${item.cost || 0} KWD</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <p class="text-2xl font-bold">${item.quantity} <span class="text-sm font-normal text-gray-500">${item.unit || 'units'}</span></p>
                        ${canManage ? `<button onclick="openUpdateStockModal('${item.id}', '${item.name}', ${item.quantity})" class="bg-gray-200 hover:bg-gray-300 text-black font-bold py-2 px-4 rounded">Update Stock</button>` : ''}
                    </div>
                </div>`).join('');
        }
        
        window.openUpdateStockModal = (itemId, itemName, currentQty) => {
            const modal = document.getElementById('inventory-modal');
            modal.querySelector('.modal-content').innerHTML = `
                <h3 class="text-lg font-bold mb-4">Update Stock for ${itemName}</h3>
                <p class="text-sm mb-4">Current Stock: <strong>${currentQty}</strong>.</p>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium">Add Stock</label><input type="number" id="add-stock-input" class="w-full p-2 border rounded-md" placeholder="e.g., 50"></div>
                    <div><label class="block text-sm font-medium">Remove Stock</label><input type="number" id="remove-stock-input" class="w-full p-2 border rounded-md" placeholder="e.g., 5"></div>
                </div>
                <div class="text-right mt-6 space-x-2">
                    <button onclick="closeModal('inventory-modal')" class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-4 rounded">Cancel</button>
                    <button onclick="updateStock('${itemId}')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Save Changes</button>
                </div>`;
            openModal('inventory-modal');
        };

        window.openAddItemModal = () => {
             const modal = document.getElementById('inventory-modal');
            modal.querySelector('.modal-content').innerHTML = `
                <h3 class="text-lg font-bold mb-4">Add New Inventory Item</h3>
                <div class="space-y-4">
                    <div><label class="block text-sm">Item Name</label><input type="text" id="new-item-name" class="w-full p-2 border rounded-md" placeholder="e.g., Cardboard Box (Large)"></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm">Item Code / SKU</label><input type="text" id="new-item-sku" class="w-full p-2 border rounded-md"></div>
                        <div><label class="block text-sm">Category</label><input type="text" id="new-item-category" class="w-full p-2 border rounded-md" placeholder="e.g., Boxes"></div>
                    </div>
                     <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm">Initial Quantity</label><input type="number" id="new-item-qty" class="w-full p-2 border rounded-md" value="0"></div>
                        <div><label class="block text-sm">Unit</label><input type="text" id="new-item-unit" class="w-full p-2 border rounded-md" placeholder="e.g., pieces, rolls"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm">Supplier</label><input type="text" id="new-item-supplier" class="w-full p-2 border rounded-md"></div>
                        <div><label class="block text-sm">Cost per Unit (KWD)</label><input type="number" id="new-item-cost" class="w-full p-2 border rounded-md" placeholder="e.g., 1.250"></div>
                    </div>
                </div>
                <div class="text-right mt-6 space-x-2">
                    <button onclick="closeModal('inventory-modal')" class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-4 rounded">Cancel</button>
                    <button onclick="addNewItem()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Add Item</button>
                </div>`;
            openModal('inventory-modal');
        }

        window.updateStock = async (itemId) => {
            const add = parseInt(document.getElementById('add-stock-input').value) || 0;
            const remove = parseInt(document.getElementById('remove-stock-input').value) || 0;
            const change = add - remove;
            if(change === 0) { closeModal('inventory-modal'); return; }
            showLoader();
            try {
                await runTransaction(db, async (transaction) => {
                    const itemRef = doc(db, "inventory", itemId);
                    const itemDoc = await transaction.get(itemRef);
                    if (!itemDoc.exists()) throw "Document does not exist!";
                    const newQuantity = (itemDoc.data().quantity || 0) + change;
                    transaction.update(itemRef, { quantity: newQuantity });
                });
                showNotification("Stock updated successfully!");
                closeModal('inventory-modal');
            } catch (e) { console.error("Transaction failed: ", e); showNotification("Failed to update stock.", true);
            } finally { hideLoader(); }
        };

        window.addNewItem = async () => {
            const name = document.getElementById('new-item-name').value.trim();
            if(!name) { showNotification("Item name is required.", true); return; }
            const newItem = {
                name, 
                quantity: parseInt(document.getElementById('new-item-qty').value) || 0,
                unit: document.getElementById('new-item-unit').value.trim(),
                sku: document.getElementById('new-item-sku').value.trim(),
                category: document.getElementById('new-item-category').value.trim(),
                supplier: document.getElementById('new-item-supplier').value.trim(),
                cost: parseFloat(document.getElementById('new-item-cost').value) || 0,
            };
            showLoader();
            try {
                await addDoc(collection(db, "inventory"), newItem);
                showNotification("New item added to inventory.");
                closeModal('inventory-modal');
            } catch(e) { console.error("Error adding item:", e); showNotification("Failed to add new item.", true);
            } finally { hideLoader(); }
        }
        
        window.openJobDetailsModal = (jobId) => {
            const job = jobsCache.find(j => j.id === jobId);
            if (!job) { showNotification("Job details not found.", true); return; }
            const modal = document.getElementById('job-details-modal');
            let materialsHtml = inventoryCache.map(item => `
                <div class="grid grid-cols-3 items-center gap-2"><label class="text-sm">${item.name}</label><input type="number" data-item-id="${item.id}" class="w-full p-1 border rounded-md text-sm" placeholder="Qty" value="${job.materialsUsed?.[item.id] || ''}"><span class="text-xs text-gray-500">In Stock: ${item.quantity}</span></div>`).join('');
            modal.querySelector('.modal-content').innerHTML = `<h3 class="text-lg font-bold mb-4">Manage Job: ${job.jfn}</h3><div class="pod-view-section bg-gray-50 mb-4"><p><strong>Shipper:</strong> ${job.sh || 'N/A'}</p><p><strong>Consignee:</strong> ${job.co || 'N/A'}</p></div><h4 class="font-semibold mb-2">Packing Materials Used</h4><div class="space-y-2 max-h-48 overflow-y-auto pr-2">${materialsHtml}</div><div class="text-right mt-6 space-x-2"><button onclick="closeModal('job-details-modal')" class="bg-gray-300 hover:bg-gray-400 text-black py-2 px-4 rounded">Cancel</button><button onclick="saveJobMaterials('${jobId}')" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded">Save & Update Stock</button></div>`;
            openModal('job-details-modal');
        };

        window.saveJobMaterials = async (jobId) => {
            const inputs = document.querySelectorAll('#job-details-modal input[data-item-id]');
            const materialsUsed = {};
            const stockUpdates = [];

            inputs.forEach(input => {
                const qtyUsed = parseInt(input.value) || 0;
                if (qtyUsed > 0) {
                    const itemId = input.dataset.itemId;
                    materialsUsed[itemId] = qtyUsed;
                    stockUpdates.push({ id: itemId, change: -qtyUsed });
                }
            });

            showLoader();
            try {
                await runTransaction(db, async (transaction) => {
                    const jobDocRef = doc(db, 'jobfiles', jobId);
                    transaction.update(jobDocRef, { materialsUsed });
                    
                    for (const update of stockUpdates) {
                        const itemRef = doc(db, "inventory", update.id);
                        const itemDoc = await transaction.get(itemRef);
                        if (!itemDoc.exists()) throw `Inventory item ${update.id} not found!`;
                        const newQuantity = (itemDoc.data().quantity || 0) + update.change;
                        if (newQuantity < 0) throw `Not enough stock for ${itemDoc.data().name}.`;
                        transaction.update(itemRef, { quantity: newQuantity });
                    }
                });
                showNotification("Job materials saved and stock updated.");
                closeModal('job-details-modal');
            } catch (e) { console.error("Transaction failed: ", e); showNotification(`Error: ${e}`, true);
            } finally { hideLoader(); }
        };

        function renderTable(view) {
            currentView = view;
            if ((currentUser.role === 'admin' || currentUser.role === 'supervisor') && document.getElementById('admin-view-btn')) {
                document.getElementById('admin-view-btn').classList.toggle('bg-white', view === 'admin');
                document.getElementById('worker-view-btn').classList.toggle('bg-white', view === 'worker');
            }
            listenForJobFiles();
        }

        function listenForJobFiles(searchTerm = '') {
            const q = query(collection(db, 'jobfiles'));
            onSnapshot(q, (snapshot) => {
                jobsCache = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                jobsCache.sort((a,b) => (b.updatedAt?.toDate()?.getTime() || 0) - (a.updatedAt?.toDate()?.getTime() || 0));
                
                let jobsToDisplay = [...jobsCache];

                if (currentUser.role === 'admin' || currentUser.role === 'supervisor') {
                    if(currentView === 'worker') {
                        jobsToDisplay = jobsToDisplay.filter(job => job.status === 'Out for Delivery');
                        displayWorkerView(jobsToDisplay, true);
                    } else {
                        displayAdminView(jobsToDisplay, searchTerm.toLowerCase());
                    }
                } else { // Worker role
                    jobsToDisplay = jobsToDisplay.filter(job => job.status === 'Out for Delivery' && job.assignedTo === currentUser.displayName);
                    displayWorkerView(jobsToDisplay);
                }
            });
        }
        
        function displayAdminView(jobs, searchTerm) {
            const container = document.getElementById('job-list-container');
            const todayStart = new Date(); todayStart.setHours(0,0,0,0);
            
            if (searchTerm) jobs = jobs.filter(j => (j.jfn || '').toLowerCase().includes(searchTerm) || (j.sh || '').toLowerCase().includes(searchTerm) || (j.co || '').toLowerCase().includes(searchTerm));

            const ready = jobs.filter(j => ['approved', 'checked'].includes(j.status));
            const out = jobs.filter(j => j.status === 'Out for Delivery');
            const completed = jobs.filter(j => j.status === 'Completed-POD' && j.updatedAt?.toDate() >= todayStart);
            const pending = jobs.filter(j => j.status === 'pending');
            
            document.getElementById('ready-count').textContent = ready.length;
            document.getElementById('transit-count').textContent = out.length;
            document.getElementById('completed-count').textContent = completed.length;

            let html = createCategorySection('Ready for Delivery', ready, '#2563eb');
            html += createCategorySection('Out for Delivery', out, '#d97706');
            html += createCategorySection('Completed Today', completed, '#16a34a');
            html += createCategorySection('Pending Approval', pending, '#78716c');
            container.innerHTML = html;
        }

        function displayWorkerView(jobs, isAdminViewing = false) {
            const container = document.getElementById('job-list-container');
            const title = isAdminViewing ? "All Out for Delivery Jobs" : "Your Assigned Deliveries";
            container.innerHTML = jobs.length === 0 ? `<p class="p-8 text-center text-gray-500">No jobs are currently out for delivery.</p>` : `<h2 class="job-category-header">${title} (${jobs.length})</h2>` + jobs.map(job => createJobCardHtml(job, '#059669')).join('');
        }

        function createCategorySection(title, jobs, color) {
            let content = `<h2 class="job-category-header">${title} (${jobs.length})</h2>`;
            content += jobs.length === 0 ? `<p class="text-sm text-gray-500 italic">No jobs in this category.</p>` : jobs.map(job => createJobCardHtml(job, color)).join('');
            return content;
        }

        function createJobCardHtml(job, color = '#78716c') {
            const status = job.status || 'pending';
            let actionButtons = '';
            const deleteBtn = `<button onclick='confirmDeletePod("${job.jfn}")' class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded text-sm ml-2">Delete POD</button>`;
            const cancelBtn = `<button onclick='confirmCancelDelivery("${job.jfn}")' class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded text-sm ml-2">Cancel Delivery</button>`;

            if (currentUser.role === 'admin' || currentUser.role === 'supervisor') {
                const manageBtn = `<button onclick='openJobDetailsModal("${job.id}")' class="bg-gray-200 hover:bg-gray-300 text-black font-bold py-2 px-4 rounded text-sm">Manage Job</button>`;
                if (status === 'approved' || status === 'checked') actionButtons = manageBtn + `<button onclick='openAssignWorkerModal("${job.id}")' class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded text-sm ml-2">Prepare Delivery</button>`;
                else if (status === 'Out for Delivery') actionButtons = `<button onclick='openViewPodModal("${job.jfn}")' class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded text-sm">View Order</button>` + cancelBtn;
                else if (status === 'Completed-POD') actionButtons = `<button onclick='openViewPodModal("${job.jfn}")' class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded text-sm">View Order</button>` + deleteBtn;
                else actionButtons = manageBtn;
            } else { // Worker
                actionButtons = `<button onclick='openWorkerDeliveryPage("${job.jfn}")' class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded text-sm">Complete Delivery</button>`;
            }
            return `<div class="job-card" style="border-left-color: ${color};"><div><p class="font-bold text-indigo-700">${job.jfn || 'N/A'}</p><p class="text-sm text-gray-600"><strong>Shipper:</strong> ${job.sh || 'N/A'}</p><p class="text-sm text-gray-600"><strong>Consignee:</strong> ${job.co || 'N/A'}</p></div><div class="text-right space-x-2">${actionButtons}<p class="text-xs text-gray-400 mt-2">Last Updated: ${job.updatedAt?.toDate().toLocaleString() || 'N/A'}</p></div></div>`;
        }
        
        window.confirmDeletePod = (jobFileNo) => {
            const modal = document.getElementById('confirm-modal');
            modal.querySelector('.modal-content').innerHTML = `
                <h3 class="text-lg font-bold mb-4">Confirm POD Deletion</h3>
                <p>Are you sure you want to delete the POD for job <strong>${jobFileNo}</strong>? This will revert the job's status to 'approved' and allow it to be re-assigned.</p>
                <div class="text-right mt-6 space-x-2">
                    <button onclick="closeModal('confirm-modal')" class="bg-gray-300 hover:bg-gray-400 text-black py-2 px-4 rounded">Cancel</button>
                    <button onclick="deletePod('${jobFileNo}')" class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded">Confirm Deletion</button>
                </div>`;
            openModal('confirm-modal');
        };
        
        window.confirmCancelDelivery = (jobFileNo) => {
            const modal = document.getElementById('confirm-modal');
            modal.querySelector('.modal-content').innerHTML = `
                <h3 class="text-lg font-bold mb-4">Confirm Delivery Cancellation</h3>
                <p>Are you sure you want to cancel the delivery for job <strong>${jobFileNo}</strong>? This will delete the POD record and return the job to the 'approved' state.</p>
                <div class="text-right mt-6 space-x-2">
                    <button onclick="closeModal('confirm-modal')" class="bg-gray-300 hover:bg-gray-400 text-black py-2 px-4 rounded">Cancel</button>
                    <button onclick="deletePod('${jobFileNo}')" class="bg-yellow-600 hover:bg-yellow-700 text-white py-2 px-4 rounded">Confirm Cancellation</button>
                </div>`;
            openModal('confirm-modal');
        };

        window.deletePod = async (jobFileNo) => {
             showLoader();
            try {
                const pod = await findPodByJobFileNo(jobFileNo);
                if(!pod) throw new Error("POD document not found");

                const batch = writeBatch(db);
                batch.delete(doc(db, 'pods', pod.id));
                batch.update(doc(db, 'jobfiles', jobFileNo.replace(/\//g, '_')), { status: 'approved', assignedTo: null });
                await batch.commit();
                
                showNotification("POD deleted and job status reverted.");
                closeModal('confirm-modal');
            } catch (error) { console.error("Error deleting POD:", error); showNotification("Error deleting POD.", true);
            } finally { hideLoader(); }
        };

        window.openAssignWorkerModal = (docId) => {
            const modal = document.getElementById('assign-worker-modal');
            modal.querySelector('.modal-content').innerHTML = `<h3 class="text-lg font-bold mb-4">Assign Worker</h3><select id="worker-select" class="w-full p-2 border rounded-md">${workersCache.map(w => `<option value="${w}">${w}</option>`).join('')}</select><div class="text-right mt-6 space-x-2"><button onclick="closeModal('assign-worker-modal')" class="bg-gray-300 hover:bg-gray-400 text-black py-2 px-4 rounded">Cancel</button><button onclick="preparePodDocument('${docId}')" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded">Confirm</button></div>`;
            openModal('assign-worker-modal');
        };

        window.preparePodDocument = async (docId) => {
            const workerName = document.getElementById('worker-select').value;
            if (!workerName) { showNotification("Please select a worker.", true); return; }
            showLoader();
            try {
                const jobDocRef = doc(db, 'jobfiles', docId);
                const jobDocSnap = await getDoc(jobDocRef);
                if (!jobDocSnap.exists()) throw new Error("Job file not found!");
                const jobData = jobDocSnap.data();
                const podData = {
                    jobFileNo: jobData.jfn, shipperName: jobData.sh, consigneeName: jobData.co,
                    description: jobData.dsc, mawb: jobData.mawb, hawb: jobData.hawb,
                    origin: jobData.or, destination: jobData.de, pieces: jobData.pc,
                    grossWeight: jobData.gw, podStatus: 'Out for Delivery',
                    preparedBy: currentUser.displayName, preparedAt: serverTimestamp(),
                    assignedTo: workerName
                };
                const batch = writeBatch(db);
                batch.set(doc(collection(db, 'pods')), podData);
                batch.update(jobDocRef, { status: 'Out for Delivery', assignedTo: workerName, updatedAt: serverTimestamp() });
                await batch.commit();
                showNotification(`Delivery assigned to ${workerName}.`);
                closeModal('assign-worker-modal');
            } catch (error) { console.error("Error preparing POD:", error); showNotification("Error preparing document.", true);
            } finally { hideLoader(); }
        };

        async function findPodByJobFileNo(jobFileNo) {
            const q = query(collection(db, 'pods'), where('jobFileNo', '==', jobFileNo));
            const snapshot = await getDocs(q);
            if (snapshot.empty) return null;
            return { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
        }
        
        async function findPodById(podId) {
            const docRef = doc(db, 'pods', podId);
            const docSnap = await getDoc(docRef);
            return docSnap.exists() ? { id: docSnap.id, ...docSnap.data() } : null;
        }

        window.openViewPodModal = async (jobFileNo) => {
            const modalContent = document.getElementById('view-pod-modal-content');
            modalContent.innerHTML = getAdminViewPodModalHtml(null);
            openModal('view-pod-modal');
            const pod = await findPodByJobFileNo(jobFileNo);
            modalContent.innerHTML = getAdminViewPodModalHtml(pod);
        };

        window.openWorkerDeliveryPage = async (jobFileNo) => {
            showLoader();
            const pod = await findPodByJobFileNo(jobFileNo);
            if (!pod) { 
                showNotification("Could not find delivery details.", true);
                hideLoader();
                return;
            }

            document.getElementById('app-container').style.display = 'none';
            const deliveryPage = document.getElementById('worker-delivery-page');
            deliveryPage.innerHTML = getWorkerPodCapturePageHtml(pod);
            deliveryPage.style.display = 'block';

            const canvas = document.getElementById('signature-pad');
            canvas.width = canvas.offsetWidth;
            signaturePad = new SignaturePad(canvas);
            document.getElementById('clear-signature').addEventListener('click', () => signaturePad.clear());
            document.getElementById('submit-pod-btn').addEventListener('click', () => submitPod(pod.id));
            document.getElementById('back-to-tasks-btn').addEventListener('click', () => {
                deliveryPage.style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
            });
            hideLoader();
        };
        
        async function submitPod(podId) {
            const receiverName = document.getElementById('receiver-name').value.trim();
            const photoFile = document.getElementById('pod-photo').files[0];
            if (signaturePad.isEmpty() || !receiverName) {
                showNotification("Receiver name and signature are required.", true);
                return;
            }
            showLoader();
            try {
                const podDocRef = doc(db, 'pods', podId);
                const pod = await findPodById(podId);
                
                const signatureRef = ref(storage, `pod_signatures/${pod.jobFileNo}_${Date.now()}.png`);
                await uploadString(signatureRef, signaturePad.toDataURL(), 'data_url');
                const signatureUrl = await getDownloadURL(signatureRef);
                
                let photoUrl = null;
                if (photoFile) {
                    const photoRef = ref(storage, `pod_photos/${pod.jobFileNo}_${Date.now()}`);
                    await uploadBytes(photoRef, photoFile);
                    photoUrl = await getDownloadURL(photoRef);
                }
                
                const batch = writeBatch(db);
                batch.update(podDocRef, { podStatus: 'Completed-POD', receiverName, signatureUrl, photoUrl, podTimestamp: serverTimestamp(), deliveredBy: currentUser.displayName });
                batch.update(doc(db, 'jobfiles', pod.jobFileNo.replace(/\//g, '_')), { status: 'Completed-POD', updatedAt: serverTimestamp() });
                await batch.commit();

                showNotification("POD Submitted Successfully!");
                document.getElementById('worker-delivery-page').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';

            } catch(error) { console.error("Error submitting POD:", error); showNotification("Failed to submit POD.", true);
            } finally { hideLoader(); }
        }

        function getAdminViewPodModalHtml(pod) {
            const content = pod ? getProfessionalPodHtml(pod) : '<div class="flex justify-center p-8"><div class="loader"></div></div>';
            return `<div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">Delivery Note & POD</h2><div><button onclick="printPod()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1 px-3 rounded text-sm mr-2">Print</button><button onclick="closeModal('view-pod-modal')" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button></div></div><div id="pod-details-content">${content}</div>`;
        }
        
        function getProfessionalPodHtml(pod) {
            let podCompletionDetails = '';
            if (pod.podStatus === 'Completed-POD') {
                const podDate = pod.podTimestamp?.toDate().toLocaleString('en-KW') || 'N/A';
                const photoHtml = pod.photoUrl ? `<a href="${pod.photoUrl}" target="_blank"><img src="${pod.photoUrl}" alt="Photo" class="mt-1 rounded-md border-2 p-1 bg-white max-h-48"></a>` : '<p class="text-xs italic text-gray-500">No photo provided.</p>';
                podCompletionDetails = `<div class="mt-4 pod-view-section bg-green-50"><h3 class="text-green-700">Proof of Delivery - Completed</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><p><strong>Receiver:</strong> ${pod.receiverName || 'N/A'}</p><p><strong>Received On:</strong> ${podDate}</p><p><strong>Delivered By:</strong> ${pod.deliveredBy || 'N/A'}</p><p class="mt-2"><strong>Signature:</strong></p><img src="${pod.signatureUrl}" alt="Signature" class="mt-1 rounded-md border-2 p-1 bg-white"></div><div><p><strong>Photo Evidence:</strong></p>${photoHtml}</div></div></div>`;
            } else {
                podCompletionDetails = `<div class="mt-4 text-center font-semibold text-yellow-700 bg-yellow-100 p-3 rounded-md">Status: Out for Delivery</div>`;
            }

            return `<div id="professional-pod-view" class="text-sm"><div class="flex justify-between items-start pb-4 mb-4 border-b-2 border-black"><div><div class="text-3xl font-extrabold" style="color: #0E639C;">Q'go<span style="color: #4FB8AF;">Cargo</span></div><p class="text-xs text-gray-500 mt-1">Salmiya, Kuwait<br>+965 1234 5678 | info@qgocargo.com</p></div><div class="text-right"><h2 class="text-2xl font-bold text-gray-700">DELIVERY NOTE</h2><p><strong>Job No:</strong> ${pod.jobFileNo}</p><svg id="barcode"></svg></div></div><div class="grid grid-cols-2 gap-4 mb-4"><div class="pod-view-section"><h3>Shipper</h3><p>${pod.shipperName || 'N/A'}</p><p><strong>Origin:</strong> ${pod.origin || 'N/A'}</p></div><div class="pod-view-section"><h3>Consignee</h3><p>${pod.consigneeName || 'N/A'}</p><p><strong>Destination:</strong> ${pod.destination || 'N/A'}</p></div></div><div class="pod-view-section mb-4"><h3>Shipment Information</h3><p><strong>Description:</strong> ${pod.description || 'N/A'}</p><div class="grid grid-cols-2 gap-4 mt-2"><div><p><strong>MAWB/OBL:</strong> ${pod.mawb || 'N/A'}</p><p><strong>HAWB/HBL:</strong> ${pod.hawb || 'N/A'}</p></div><div><p><strong>Pieces:</strong> ${pod.pieces || 'N/A'}</p><p><strong>Weight:</strong> ${pod.grossWeight || 'N/A'}</p></div></div></div>${podCompletionDetails}<div class="flex justify-between items-end pt-4 mt-4 border-t"><p class="text-xs text-gray-400">Prepared By: ${pod.preparedBy || 'N/A'}</p><div id="qrcode" class="w-20 h-20"></div></div></div>`;
        }

        function getWorkerPodCapturePageHtml(pod) {
            return `
                <div class="container">
                     <div class="flex justify-between items-center mb-4">
                        <h1 class="text-2xl font-bold">Complete Delivery</h1>
                        <button id="back-to-tasks-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Back to Task List</button>
                    </div>
                    <div class="mt-4 max-h-[75vh] overflow-y-auto pr-2">
                        ${getProfessionalPodHtml(pod)}
                        <div class="mt-4 pod-view-section bg-blue-50">
                            <h3 class="text-blue-700">Proof of Delivery - Capture</h3>
                            <div class="space-y-4 mt-2">
                                <div><label for="receiver-name" class="block text-sm font-medium text-gray-700">Receiver Full Name</label><input type="text" id="receiver-name" class="w-full mt-1 p-2 border rounded-md" required></div>
                                <div><label class="block text-sm font-medium text-gray-700">Receiver Signature</label><canvas id="signature-pad"></canvas><button id="clear-signature" type="button" class="text-xs text-indigo-600 mt-1">Clear Signature</button></div>
                                <div><label for="pod-photo" class="block text-sm font-medium text-gray-700">Photo Evidence (Optional)</label><input type="file" id="pod-photo" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"></div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6">
                        <button id="submit-pod-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">Submit POD</button>
                    </div>
                </div>
            `;
        }
        
        function getAdminDashboardShell() {
            return `<div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4"><div><h1 class="text-3xl font-bold" style="color: var(--theme-color);">QGO Logistics Platform</h1><p class="text-sm text-gray-500">Logged in as: <span id="user-display-name" class="font-bold"></span> (<span id="user-role-display" class="capitalize"></span>)</p></div><button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Logout</button></div><div class="border-b border-gray-200 mb-4"><nav class="-mb-px flex space-x-8" aria-label="Tabs"><button id="dashboard-tab-btn" class="dashboard-tab">Dashboard</button><button id="warehouse-tab-btn" class="dashboard-tab">Warehouse</button><button id="admin-tab-btn" class="dashboard-tab">Admin</button></nav></div><div id="dashboard-content" class="tab-content hidden"><div class="flex items-center justify-between mb-4"><div id="view-toggle-container" class="flex items-center space-x-2 bg-gray-200 p-1 rounded-lg"><button id="admin-view-btn" class="px-4 py-1 text-sm font-semibold rounded-md">Admin View</button><button id="worker-view-btn" class="px-4 py-1 text-sm font-semibold rounded-md">Worker View</button></div></div><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"><div class="stat-card"><p class="text-sm text-gray-500">Ready for Delivery</p><p id="ready-count" class="text-3xl font-bold text-blue-600">0</p></div><div class="stat-card"><p class="text-sm text-gray-500">In Transit</p><p id="transit-count" class="text-3xl font-bold text-amber-600">0</p></div><div class="stat-card"><p class="text-sm text-gray-500">Completed Today</p><p id="completed-count" class="text-3xl font-bold text-green-600">0</p></div></div><div><input type="text" id="job-search-input" placeholder="Search by Job No, Shipper, Consignee..." class="w-full p-2 border rounded-md mb-4"></div><div id="job-list-container"></div></div><div id="warehouse-content" class="tab-content hidden"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">Warehouse Inventory</h2><button id="add-item-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Add New Item</button></div><div id="inventory-list"></div></div><div id="admin-content" class="tab-content hidden"><h2 class="text-2xl font-bold mb-4">User Permissions</h2></div>`;
        }
        
        function getWorkerDashboardShell() {
             return `<div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4"><div><h1 class="text-3xl font-bold" style="color: var(--theme-color);">Your Delivery Tasks</h1><p class="text-sm text-gray-500">Logged in as: <span id="user-display-name" class="font-bold"></span> (<span id="user-role-display" class="capitalize"></span>)</p></div><button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Logout</button></div><div id="job-list-container"></div>`;
        }
        
        window.printPod = () => {
            const modalContent = document.querySelector('#view-pod-modal-content #professional-pod-view');
            if(modalContent) {
                const podView = document.getElementById('print-area');
                podView.innerHTML = modalContent.innerHTML;
                JsBarcode("#print-area #barcode", modalContent.querySelector('p:last-child').textContent.split(': ')[1], { format: "CODE128" });
                window.print();
            }
        };
        
        async function checkPublicView() {
            const params = new URLSearchParams(window.location.search);
            const podToView = params.get('viewpod');
            if (podToView) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-container').style.display = 'none';
                const publicView = document.getElementById('public-pod-view');
                publicView.innerHTML = '<div class="flex justify-center p-8"><div class="loader"></div></div>';
                publicView.style.display = 'block';
                const pod = await findPodByJobFileNo(podToView);
                if(pod) {
                    publicView.innerHTML = getProfessionalPodHtml(pod);
                    JsBarcode("#public-pod-view #barcode", pod.jobFileNo, { format: "CODE128", lineColor: "#000", width: 2, height: 40, displayValue: false });
                    new QRCode(document.querySelector("#public-pod-view #qrcode"), { text: window.location.href, width: 80, height: 80 });
                } else {
                    publicView.innerHTML = '<p class="text-center font-bold text-red-600">Proof of Delivery not found.</p>';
                }
            } else {
                document.getElementById('login-screen').style.display = 'flex';
            }
        }
        
        let isLogin = true;
        document.getElementById('auth-link').addEventListener('click', (e) => {
            e.preventDefault();
            isLogin = !isLogin;
            document.getElementById('auth-title').textContent = isLogin ? 'Sign in to your account' : 'Create a new account';
            document.getElementById('auth-btn').textContent = isLogin ? 'Sign in' : 'Sign up';
            document.getElementById('auth-link').textContent = isLogin ? 'Create a new account' : 'Already have an account? Sign in';
            document.getElementById('signup-name-field').style.display = isLogin ? 'none' : 'block';
        });

        document.getElementById('auth-btn').addEventListener('click', async () => {
            const email = document.getElementById('email-address').value;
            const password = document.getElementById('password').value;
            showLoader();
            try {
                if (isLogin) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    const displayName = document.getElementById('full-name').value;
                    if (!displayName) throw new Error("Full name is required for sign up.");
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await setDoc(doc(db, 'users', userCredential.user.uid), {
                        displayName, email, role: 'worker', status: 'inactive', createdAt: serverTimestamp()
                    });
                    showNotification("Account created. Please wait for admin approval.");
                    signOut(auth);
                }
            } catch (error) { showNotification(error.message, true);
            } finally { hideLoader(); }
        });
        
        checkPublicView();

    </script>
</body>
</html>

