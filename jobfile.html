<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job File Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
        }
        .input-field {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
            transition: border-color 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 1px #4f46e5;
        }
        .table-cell {
            border: 1px solid #d1d5db;
            padding: 0.75rem;
            text-align: left;
        }
        .table-cell input {
            width: 100%;
            border: none;
            padding: 0;
            background-color: transparent;
        }
        .table-cell input:focus {
            outline: none;
        }
        
        /* Modal and Loader Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5); display: flex;
            align-items: center; justify-content: center; z-index: 1000;
        }
        .modal-content {
            background: white; padding: 2rem; border-radius: 0.5rem;
            max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;
        }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Print-Specific Styles */
        @page {
            size: A4;
            margin: 0.5cm;
        }
        @media print {
            body { 
                background-color: white !important; 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
                font-size: 9px;
            }
            #main-container, .no-print { display: none !important; }
            #print-output { display: block !important; padding: 0 !important; margin: 0 !important; }
            #print-output .print-table th, #print-output .print-table td {
                padding: 0.15rem 0.2rem;
                font-size: 8px;
            }
             #print-output .print-field {
                padding: 0.15rem 0.2rem;
                min-height: 22px;
                font-size: 8px;
            }
            #print-output .text-xl { font-size: 1rem; }
            #print-output .text-xs { font-size: 0.65rem; }
            #qrcode img { width: 96px !important; height: 96px !important; }
        }
        
        /* Styles for the print-friendly output */
        #print-output .print-table { border-collapse: collapse; width: 100%; }
        #print-output .print-table th, #print-output .print-table td {
            border: 1px solid #6b7280;
            padding: 0.3rem;
            font-size: 0.7rem;
        }
        #print-output .print-table th { background-color: #f3f4f6; font-weight: 600; }
        #print-output .print-field { border: 1px solid #6b7280; padding: 0.3rem; min-height: 30px; }
    </style>
</head>
<body>

    <div id="main-container" class="container">
        <!-- Header Section -->
        <header class="flex justify-between items-start mb-6">
            <div class="flex items-center">
                <div class="text-3xl font-bold mr-4" style="color: #0E639C;">Q'go<span style="color: #4FB8AF;">Cargo</span></div>
                <h1 class="text-4xl font-bold text-gray-800 border-l-4 border-gray-300 pl-4">JOB FILE</h1>
            </div>
            <div class="text-right">
                <div class="flex items-center mb-2">
                    <label for="date" class="mr-2 font-semibold text-gray-700">Date:</label>
                    <input type="date" id="date" class="input-field w-40">
                </div>
                <div class="flex items-center">
                    <label for="po-number" class="mr-2 font-semibold text-gray-700">P.O. #:</label>
                    <input type="text" id="po-number" class="input-field w-40">
                </div>
            </div>
        </header>
        
        <div id="offline-message" class="hidden text-center text-red-600 bg-red-100 p-2 rounded-md mb-4">
            AI features are disabled. Please connect to the internet to use them.
        </div>

        <!-- Top Form Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <div class="lg:col-span-2">
                <label for="job-file-no" class="block mb-1 font-semibold text-gray-700">Job File No.:</label>
                <input type="text" id="job-file-no" class="input-field">
            </div>
            <div>
                <label for="type" class="block mb-1 font-semibold text-gray-700">Type:</label>
                <input type="text" id="type" class="input-field">
            </div>
            <div class="flex space-x-6">
                <div>
                    <span class="font-semibold text-gray-700">Clearance</span>
                    <div class="mt-2 space-y-1">
                        <label class="flex items-center"><input type="checkbox" class="mr-2" data-clearance="Export"> Export</label>
                        <label class="flex items-center"><input type="checkbox" class="mr-2" data-clearance="Import"> Import</label>
                        <label class="flex items-center"><input type="checkbox" class="mr-2" data-clearance="Clearance"> Clearance</label>
                        <label class="flex items-center"><input type="checkbox" class="mr-2" data-clearance="Local Move"> Local Move</label>
                    </div>
                </div>
                <div>
                    <span class="font-semibold text-gray-700">Product Type</span>
                    <div class="mt-2 space-y-1">
                        <label class="flex items-center"><input type="checkbox" class="mr-2" data-product="Air Freight"> Air Freight</label>
                        <label class="flex items-center"><input type="checkbox" class="mr-2" data-product="Sea Freight"> Sea Freight</label>
                        <label class="flex items-center"><input type="checkbox" class="mr-2" data-product="Land Freight"> Land Freight</label>
                        <label class="flex items-center"><input type="checkbox" class="mr-2" data-product="Others"> Others</label>
                    </div>
                </div>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div><label for="invoice-no" class="block mb-1 font-semibold text-gray-700">Invoice No.:</label><input type="text" id="invoice-no" class="input-field"></div>
            <div><label for="billing-date" class="block mb-1 font-semibold text-gray-700">Billing Date:</label><input type="date" id="billing-date" class="input-field"></div>
            <div><label for="salesman" class="block mb-1 font-semibold text-gray-700">Salesman:</label><input type="text" id="salesman" class="input-field"></div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div><label for="shipper-name" class="block mb-1 font-semibold text-gray-700">Shipper's Name:</label><input type="text" id="shipper-name" class="input-field"></div>
            <div><label for="consignee-name" class="block mb-1 font-semibold text-gray-700">Consignee's Name:</label><input type="text" id="consignee-name" class="input-field"></div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <div><label for="mawb" class="block mb-1 font-semibold text-gray-700">MAWB / OBL / TCN No.:</label><input type="text" id="mawb" class="input-field"></div>
            <div><label for="hawb" class="block mb-1 font-semibold text-gray-700">HAWB / HBL:</label><input type="text" id="hawb" class="input-field"></div>
            <div><label for="teams-of-shipping" class="block mb-1 font-semibold text-gray-700">Teams of Shipping:</label><input type="text" id="teams-of-shipping" class="input-field"></div>
            <div><label for="origin" class="block mb-1 font-semibold text-gray-700">Origin:</label><input type="text" id="origin" class="input-field"></div>
            <div><label for="no-of-pieces" class="block mb-1 font-semibold text-gray-700">No. of Pieces:</label><input type="text" id="no-of-pieces" class="input-field"></div>
            <div><label for="gross-weight" class="block mb-1 font-semibold text-gray-700">Gross Weight:</label><input type="text" id="gross-weight" class="input-field"></div>
            <div><label for="destination" class="block mb-1 font-semibold text-gray-700">Destination:</label><input type="text" id="destination" class="input-field"></div>
            <div><label for="volume-weight" class="block mb-1 font-semibold text-gray-700">Volume Weight:</label><input type="text" id="volume-weight" class="input-field"></div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="lg:col-span-2"><label for="description" class="block mb-1 font-semibold text-gray-700">Description:</label><input type="text" id="description" class="input-field"></div>
            <div><label for="carrier" class="block mb-1 font-semibold text-gray-700">Carrier / Shipping Line / Trucking Co:</label><input type="text" id="carrier" class="input-field"></div>
            <div><label for="truck-no" class="block mb-1 font-semibold text-gray-700">Truck No. / Driver's Name:</label><input type="text" id="truck-no" class="input-field"></div>
            <div><label for="vessel-name" class="block mb-1 font-semibold text-gray-700">Vessel's Name:</label><input type="text" id="vessel-name" class="input-field"></div>
            <div><label for="flight-voyage-no" class="block mb-1 font-semibold text-gray-700">Flight / Voyage No.:</label><input type="text" id="flight-voyage-no" class="input-field"></div>
            <div><label for="container-no" class="block mb-1 font-semibold text-gray-700">Container No.:</label><input type="text" id="container-no" class="input-field"></div>
        </div>

        <!-- Charges Table -->
        <div class="flex justify-between items-center mb-2">
            <h2 class="text-xl font-semibold text-gray-800">Charges</h2>
            <button id="analyze-costs-btn" onclick="analyzeCosts()" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 no-print disabled:opacity-50 disabled:cursor-not-allowed">
                ✨ Analyze Costs
            </button>
        </div>
        <div class="mb-6">
            <table class="w-full border-collapse">
                <thead><tr class="bg-gray-100"><th class="table-cell font-semibold w-2/5">Description</th><th class="table-cell font-semibold">Cost</th><th class="table-cell font-semibold">Selling</th><th class="table-cell font-semibold">Profit</th><th class="table-cell font-semibold">Notes</th></tr></thead>
                <tbody id="charges-table-body"></tbody>
            </table>
        </div>

        <!-- Remarks Section -->
        <div class="mb-8">
            <div class="flex justify-between items-center mb-2"><label for="remarks" class="block font-semibold text-gray-700">REMARKS:</label><button id="generate-remarks-btn" onclick="generateRemarks()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 no-print disabled:opacity-50 disabled:cursor-not-allowed">✨ Generate Remarks</button></div>
            <textarea id="remarks" rows="4" class="input-field w-full"></textarea>
        </div>

        <!-- Footer Section -->
        <footer class="grid grid-cols-1 md:grid-cols-3 gap-8 pt-6 border-t">
            <div><label class="block mb-2 font-semibold text-gray-700">PREPARED BY</label><input type="text" id="prepared-by" class="input-field"></div>
            <div><label class="block mb-2 font-semibold text-gray-700">CHECKED BY</label><input type="text" id="checked-by" class="input-field"></div>
            <div><label class="block mb-2 font-semibold text-gray-700">APPROVED BY</label><input type="text" id="approved-by" class="input-field"></div>
        </footer>

        <!-- Action Buttons -->
        <div class="text-center mt-10 no-print space-x-4">
             <button id="preview-btn" onclick="previewPage()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105">Preview</button>
             <button onclick="saveAsPdf()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105">Save as PDF</button>
            <button onclick="printPage()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105">Print Job File</button>
        </div>
    </div>

    <!-- This container is hidden by default and will be populated for printing/preview -->
    <div id="print-output" class="hidden"></div>

    <!-- Modal for AI Analysis -->
    <div id="ai-modal" class="modal-overlay hidden"><div class="modal-content"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">✨ Cost Analysis</h3><button onclick="closeModal()" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button></div><div id="modal-body"></div></div></div>
    <div id="loader-overlay" class="modal-overlay hidden"><div class="loader"></div></div>

    <script>
        // --- Gemini API Call Function ---
        async function callGemini(prompt) {
            if (window.location.protocol === 'file:') {
                showModal(`<p class="text-red-500">AI features are not available when running the file locally. Please host this file on a web server to enable AI functionality.</p>`);
                return "Error: Local file access";
            }
            const apiKey = ""; // Provided by Canvas
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                if (!response.ok) {
                    showModal(`<p class="text-red-500">Error: Could not connect to the AI service. Please check your internet connection and try again.</p>`);
                    throw new Error(`API call failed: ${response.status}`);
                }
                const result = await response.json();
                return result.candidates?.[0]?.content?.parts?.[0]?.text || "Error: Could not parse AI response.";
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                showModal(`<p class="text-red-500">Error: Could not connect to the AI service. Please check your internet connection and try again.</p>`);
                return `Error: ${error.message}`;
            }
        }

        // --- AI Feature Functions ---
        async function generateRemarks() {
            showLoader();
            const data = getFormData();
            const prompt = `Generate a concise, professional remark for a logistics job file with these details: Job Description: ${data.dsc}, Shipper: ${data.sh}, Consignee: ${data.co}, Origin: ${data.or}, Destination: ${data.de}. Generate only the remark text.`;
            const remarksText = await callGemini(prompt);
            if (!remarksText.startsWith("Error:")) {
                document.getElementById('remarks').value = remarksText;
            }
            hideLoader();
        }

        async function analyzeCosts() {
            showLoader();
            const data = getFormData();
            if (data.ch.length === 0) {
                showModal("Please enter some costs before analyzing.");
                hideLoader();
                return;
            }
            const costBreakdown = data.ch.map(c => `- ${c.l} $${c.c}`).join('\n');
            const prompt = `As a logistics cost analyst, review this cost breakdown for a ${data.pt.join(', ')} shipment:\n${costBreakdown}\nProvide a brief analysis identifying unusual costs and suggesting savings. Format as simple HTML paragraphs.`;
            const analysisHtml = await callGemini(prompt);
             if (!analysisHtml.startsWith("Error:")) {
                showModal(analysisHtml);
            }
            hideLoader();
        }

        // --- Data Handling ---
        function getFormData() {
            const getVal = id => document.getElementById(id).value || '';
            const getChecked = query => Array.from(document.querySelectorAll(query)).filter(el => el.checked).map(el => el.dataset.clearance || el.dataset.product);

            const charges = [];
            document.querySelectorAll('#charges-table-body tr').forEach(row => {
                if (row.id === 'total-row') return;
                charges.push({
                    l: row.cells[0].textContent.trim(), // label
                    c: row.querySelector('.cost-input').value || '0', // cost
                    s: row.querySelector('.selling-input').value || '0', // selling
                    n: row.cells[4].querySelector('input').value || '' // notes
                });
            });

            return {
                d: getVal('date'), po: getVal('po-number'), jfn: getVal('job-file-no'), t: getVal('type'),
                cl: getChecked('[data-clearance]:checked'), pt: getChecked('[data-product]:checked'),
                in: getVal('invoice-no'), bd: getVal('billing-date'), sm: getVal('salesman'),
                sh: getVal('shipper-name'), co: getVal('consignee-name'),
                mawb: getVal('mawb'), hawb: getVal('hawb'), ts: getVal('teams-of-shipping'), or: getVal('origin'),
                pc: getVal('no-of-pieces'), gw: getVal('gross-weight'), de: getVal('destination'), vw: getVal('volume-weight'),
                dsc: getVal('description'), ca: getVal('carrier'), tn: getVal('truck-no'),
                vn: getVal('vessel-name'), fv: getVal('flight-voyage-no'), cn: getVal('container-no'),
                ch: charges,
                re: getVal('remarks'),
                pb: getVal('prepared-by'), cb: getVal('checked-by'), ab: getVal('approved-by'),
            };
        }

        function populateFormFromData(data) {
            const setVal = (id, value) => { if (document.getElementById(id)) document.getElementById(id).value = value || ''; };
            const setChecked = (type, values) => {
                document.querySelectorAll(`[data-${type}]`).forEach(el => {
                    el.checked = values.includes(el.dataset[type]);
                });
            };

            setVal('date', data.d); setVal('po-number', data.po); setVal('job-file-no', data.jfn);
            setVal('type', data.t); setVal('invoice-no', data.in); setVal('billing-date', data.bd);
            setVal('salesman', data.sm); setVal('shipper-name', data.sh); setVal('consignee-name', data.co);
            setVal('mawb', data.mawb); setVal('hawb', data.hawb); setVal('teams-of-shipping', data.ts);
            setVal('origin', data.or); setVal('no-of-pieces', data.pc); setVal('gross-weight', data.gw);
            setVal('destination', data.de); setVal('volume-weight', data.vw); setVal('description', data.dsc);
            setVal('carrier', data.ca); setVal('truck-no', data.tn); setVal('vessel-name', data.vn);
            setVal('flight-voyage-no', data.fv); setVal('container-no', data.cn);
            setVal('remarks', data.re); setVal('prepared-by', data.pb); setVal('checked-by', data.cb);
            setVal('approved-by', data.ab);

            setChecked('clearance', data.cl || []);
            setChecked('product', data.pt || []);

            if (data.ch) {
                const rows = document.querySelectorAll('#charges-table-body tr');
                rows.forEach((row, index) => {
                    if (index < data.ch.length) {
                        const chargeData = data.ch[index];
                        row.querySelector('.cost-input').value = chargeData.c;
                        row.querySelector('.selling-input').value = chargeData.s;
                        row.querySelector('input[type="text"]:not([class])').value = chargeData.n;
                    }
                });
            }
            calculate();
        }

        // --- Print, Preview, and PDF Logic ---
        function generatePrintView() {
            const data = getFormData();
            const totals = {
                cost: document.getElementById('total-cost').textContent,
                selling: document.getElementById('total-selling').textContent,
                profit: document.getElementById('total-profit').textContent,
            };
            const checkedSymbol = '☑';
            const uncheckedSymbol = '☐';
            const printHTML = `
                <div class="p-4">
                    <div class="no-print text-center mb-4">
                        <button onclick="previewPage()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg">Back to Form</button>
                    </div>
                    <div class="border border-gray-700 p-2">
                        <div class="grid grid-cols-12 gap-px bg-gray-700" style="border: 1px solid #374151;">
                            <div class="col-span-3 bg-white p-1 flex items-center" style="border: 1px solid #374151;">
                                <div class="text-xl font-bold" style="color: #0E639C;">Q'go<span style="color: #4FB8AF;">Cargo</span></div>
                            </div>
                            <div class="col-span-6 bg-white flex items-center justify-center text-xl font-bold" style="border: 1px solid #374151;">JOB FILE</div>
                            <div class="col-span-3 bg-white p-1 text-xs" style="border: 1px solid #374151;"><div><strong>Date:</strong> ${data.d}</div><div><strong>P.O. #:</strong> ${data.po}</div></div>
                            
                            <div class="col-span-8 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Job File No.:</strong> ${data.jfn}</div>
                            <div class="col-span-4 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Type:</strong> ${data.t}</div>

                            <div class="col-span-12 bg-white p-1 grid grid-cols-4 gap-2 text-xs" style="border: 1px solid #374151;">
                                <div><strong>Clearance</strong><br>${data.cl.includes('Export') ? checkedSymbol : uncheckedSymbol} Export<br>${data.cl.includes('Import') ? checkedSymbol : uncheckedSymbol} Import<br>${data.cl.includes('Clearance') ? checkedSymbol : uncheckedSymbol} Clearance<br>${data.cl.includes('Local Move') ? checkedSymbol : uncheckedSymbol} Local Move</div>
                                <div><strong>Product Type</strong><br>${data.pt.includes('Air Freight') ? checkedSymbol : uncheckedSymbol} Air<br>${data.pt.includes('Sea Freight') ? checkedSymbol : uncheckedSymbol} Sea<br>${data.pt.includes('Land Freight') ? checkedSymbol : uncheckedSymbol} Land<br>${data.pt.includes('Others') ? checkedSymbol : uncheckedSymbol} Others</div>
                                <div class="col-span-2"></div>
                            </div>

                            <div class="col-span-6 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Invoice No.:</strong> ${data.in}</div>
                            <div class="col-span-6 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Billing Date:</strong> ${data.bd}</div>
                            <div class="col-span-12 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Salesman:</strong> ${data.sm}</div>

                            <div class="col-span-6 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Shipper's Name:</strong><div class="print-field">${data.sh}</div></div>
                            <div class="col-span-6 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Consignee's Name:</strong><div class="print-field">${data.co}</div></div>
                            
                            <div class="col-span-6 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>MAWB/OBL/TCN:</strong><div class="print-field">${data.mawb}</div></div>
                            <div class="col-span-6 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Teams of Shipping:</strong><div class="print-field">${data.ts}</div></div>
                            <div class="col-span-6 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>HAWB/HBL:</strong><div class="print-field">${data.hawb}</div></div>
                            <div class="col-span-3 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Origin:</strong><div class="print-field">${data.or}</div></div>
                            <div class="col-span-3 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Destination:</strong><div class="print-field">${data.de}</div></div>
                            <div class="col-span-3 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>No. of Pieces:</strong><div class="print-field">${data.pc}</div></div>
                            <div class="col-span-3 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Gross Wt:</strong><div class="print-field">${data.gw}</div></div>
                            <div class="col-span-6 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Volume Wt:</strong><div class="print-field">${data.vw}</div></div>
                            
                            <div class="col-span-12 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Description:</strong><div class="print-field">${data.dsc}</div></div>
                            <div class="col-span-6 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Carrier/Line/Trucking:</strong><div class="print-field">${data.ca}</div></div>
                            <div class="col-span-6 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Truck/Driver:</strong><div class="print-field">${data.tn}</div></div>
                            <div class="col-span-4 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Vessel:</strong><div class="print-field">${data.vn}</div></div>
                            <div class="col-span-4 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Flight/Voyage:</strong><div class="print-field">${data.fv}</div></div>
                            <div class="col-span-4 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Container No:</strong><div class="print-field">${data.cn}</div></div>

                            <div class="col-span-12 bg-white p-0" style="border: 1px solid #374151;">
                                <table class="print-table">
                                    <thead><tr><th>Description</th><th>Cost</th><th>Selling</th><th>Profit</th><th>Notes</th></tr></thead>
                                    <tbody>
                                        ${data.ch.map(c => `<tr><td>${c.l}</td><td>${c.c}</td><td>${c.s}</td><td>${(parseFloat(c.s) - parseFloat(c.c)).toFixed(2)}</td><td>${c.n}</td></tr>`).join('')}
                                        <tr class="font-bold bg-gray-100"><td>TOTAL:</td><td>${totals.cost}</td><td>${totals.selling}</td><td>${totals.profit}</td><td></td></tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="col-span-12 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>REMARKS:</strong><div class="print-field h-20">${data.re.replace(/\n/g, '<br>')}</div></div>
                            
                            <div class="col-span-3 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>PREPARED BY:</strong><div class="print-field">${data.pb}</div></div>
                            <div class="col-span-3 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>CHECKED BY:</strong><div class="print-field">${data.cb}</div></div>
                            <div class="col-span-3 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>APPROVED BY:</strong><div class="print-field">${data.ab}</div></div>
                            <div class="col-span-3 bg-white p-1 flex items-center justify-center" style="border: 1px solid #374151;"><div id="qrcode"></div></div>
                        </div>
                    </div>
                </div>
            `;
            const printContainer = document.getElementById('print-output');
            printContainer.innerHTML = printHTML;

            const compressedData = LZString.compressToEncodedURIComponent(JSON.stringify(data));
            const url = `${window.location.href.split('?')[0]}?data=${compressedData}`;
            
            const qrCodeContainer = printContainer.querySelector('#qrcode');
            qrCodeContainer.innerHTML = "";
            new QRCode(qrCodeContainer, {
                text: url,
                width: 128,
                height: 128,
                correctLevel: QRCode.CorrectLevel.H
            });
        }

        function previewPage() {
            const mainContainer = document.getElementById('main-container');
            const printContainer = document.getElementById('print-output');
            
            if (mainContainer.classList.contains('hidden')) {
                mainContainer.classList.remove('hidden');
                printContainer.classList.add('hidden');
            } else {
                generatePrintView();
                mainContainer.classList.add('hidden');
                printContainer.classList.remove('hidden');
            }
        }
        
        function saveAsPdf() {
            showLoader();
            generatePrintView();
            const element = document.getElementById('print-output').querySelector('.border');
            const jobFileNo = document.getElementById('job-file-no').value || 'JobFile';
            const opt = {
              margin:       0.2,
              filename:     `${jobFileNo}.pdf`,
              image:        { type: 'jpeg', quality: 1.0 },
              html2canvas:  { scale: 3 },
              jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            setTimeout(() => {
                html2pdf().from(element).set(opt).save().then(hideLoader);
            }, 500);
        }

        function printPage() {
            generatePrintView();
            setTimeout(() => { window.print(); }, 500);
        }

        // --- UI Functions ---
        function showLoader() { document.getElementById('loader-overlay').classList.remove('hidden'); }
        function hideLoader() { document.getElementById('loader-overlay').classList.add('hidden'); }
        function showModal(content) { document.getElementById('modal-body').innerHTML = content; document.getElementById('ai-modal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('ai-modal').classList.add('hidden'); }

        // --- Calculation and Table Population ---
        function calculate() {
            let totalCost = 0, totalSelling = 0, totalProfit = 0;
            document.querySelectorAll('#charges-table-body tr').forEach(row => {
                if (row.id === 'total-row') return;
                const cost = parseFloat(row.querySelector('.cost-input').value) || 0;
                const selling = parseFloat(row.querySelector('.selling-input').value) || 0;
                const profit = selling - cost;
                row.cells[3].textContent = profit.toFixed(2);
                row.cells[3].className = 'table-cell profit-output bg-gray-50';
                if (profit < 0) row.cells[3].classList.add('text-red-600');
                else if (profit > 0) row.cells[3].classList.add('text-green-600');
                totalCost += cost; totalSelling += selling; totalProfit += profit;
            });
            document.getElementById('total-cost').textContent = totalCost.toFixed(2);
            document.getElementById('total-selling').textContent = totalSelling.toFixed(2);
            const totalProfitCell = document.getElementById('total-profit');
            totalProfitCell.textContent = totalProfit.toFixed(2);
            totalProfitCell.className = 'table-cell';
            if (totalProfit < 0) totalProfitCell.classList.add('text-red-600');
            else if (totalProfit > 0) totalProfitCell.classList.add('text-green-600');
        }
        
        function populateTable() {
            const chargeLabels = ["Ex-works Charges:", "Land/Air / Sea Freight:", "Fuell Security / War Surcharge:", "Formalities:", "Delivery Order Fee:", "Transportation Charges:", "Inspection / Computer Print Charges:", "Handling Charges:", "Labor / Forklift Charges:", "Documentation Charges:", "Clearance Charges:", "Customs Duty:", "Terminal Handling Charges:", "Legalization Charges:", "Demurrage Charges:", "Loading / Offloading Charges:", "Destination Clearance Charges:", "Packing Charges:", "Port Charges:", "Other Charges:", "PAI Approval :", "Insurance Fee :", "EPA Charges :"];
            const tableBody = document.getElementById('charges-table-body');
            let rowsHtml = chargeLabels.map(label => `<tr><td class="table-cell font-medium text-gray-700">${label}</td><td class="table-cell"><input type="text" class="cost-input"></td><td class="table-cell"><input type="text" class="selling-input"></td><td class="table-cell profit-output bg-gray-50"></td><td class="table-cell"><input type="text"></td></tr>`).join('');
            rowsHtml += `<tr id="total-row" class="bg-gray-100 font-bold"><td class="table-cell text-right">TOTAL:</td><td id="total-cost" class="table-cell"></td><td id="total-selling" class="table-cell"></td><td id="total-profit" class="table-cell"></td><td class="table-cell"></td></tr>`;
            tableBody.innerHTML = rowsHtml;
        }
        
        function setupEventListeners() {
            document.getElementById('charges-table-body').addEventListener('input', e => {
                if (e.target.classList.contains('cost-input') || e.target.classList.contains('selling-input')) {
                    calculate();
                }
            });
        }

        function loadDataFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const dataParam = urlParams.get('data');
            if (dataParam) {
                try {
                    const decompressed = LZString.decompressFromEncodedURIComponent(dataParam);
                    const jsonData = JSON.parse(decompressed);
                    populateFormFromData(jsonData);
                    // Automatically go to preview mode if data is loaded from URL
                    previewPage();
                } catch (e) {
                    console.error("Failed to parse data from URL", e);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            populateTable();
            setupEventListeners();
            calculate();
            loadDataFromUrl();
        });
    </script>
</body>
</html>
