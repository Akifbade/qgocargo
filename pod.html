<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POD Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --qgo-blue: #0E639C;
            --qgo-teal: #4FB8AF;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        body.loading > * {
            visibility: hidden;
        }
        .qg-logo {
            font-weight: 800;
            color: var(--qgo-blue);
        }
        .qg-logo span {
            color: var(--qgo-teal);
        }
        .input-field {
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
            background-color: #fff;
        }
        .input-field:focus {
            outline: none;
            border-color: var(--qgo-blue);
            box-shadow: 0 0 0 3px rgba(14, 99, 156, 0.2);
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06);
            border: 1px solid transparent;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }
        .btn-primary { background-color: var(--qgo-blue); color: white; }
        .btn-primary:hover { background-color: #0c5383; }
        .btn-secondary { background-color: #e2e8f0; color: #1e293b; border-color: #cbd5e1 }
        .btn-secondary:hover { background-color: #cbd5e1; }
        .btn-success { background-color: var(--qgo-teal); color: white; }
        .btn-success:hover { background-color: #429e96; }
        .btn-danger { background-color: #dc2626; color: white; }
        .btn-danger:hover { background-color: #b91c1c; }

        .overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.6); display: flex;
            align-items: center; justify-content: center; z-index: 1000;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            padding: 1rem;
        }
        .overlay.visible {
            opacity: 1; visibility: visible;
        }
        .modal-content {
            background: white; padding: 1.5rem; border-radius: 0.75rem;
            width: 100%; max-width: 600px;
            max-height: 90vh; overflow-y: auto;
            transform: scale(0.95); transition: transform 0.3s ease-in-out;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        .overlay.visible .modal-content {
            transform: scale(1);
        }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--qgo-blue);
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #notification {
            position: fixed; bottom: 20px; left: 50%;
            transform: translateX(-50%);
            background-color: #1e293b; color: white;
            padding: 1rem 1.5rem; border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            transform: translate(-50%, 150%); opacity: 0;
            transition: transform 0.4s ease-out, opacity 0.4s ease-out;
            z-index: 2000; text-align: center;
        }
        #notification.show {
            transform: translate(-50%, 0); opacity: 1;
        }

        .suggestions-container {
            position: absolute;
            width: 100%;
            background-color: white;
            border: 1px solid #d1d5db;
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            z-index: 50;
        }
        .suggestion-item {
            padding: 0.75rem;
            cursor: pointer;
        }
        .suggestion-item:hover {
            background-color: #f3f4f6;
        }
        
        .signature-pad-canvas {
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
        }
        
        @keyframes fadeInFromBottom {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .delivery-card {
            animation: fadeInFromBottom 0.5s ease-out forwards;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .delivery-card:hover {
            transform: translateY(-3px) scale(1.01);
            box-shadow: 0 8px 16px -4px rgba(0,0,0,0.1);
        }
        
        .rating-stars {
            display: inline-flex;
            flex-direction: row-reverse;
            justify-content: center;
        }
        .rating-stars input[type="radio"] {
            display: none;
        }
        .rating-stars label {
            font-size: 2.5rem;
            color: #d1d5db;
            cursor: pointer;
            transition: color 0.2s;
        }
        .rating-stars input[type="radio"]:checked ~ label,
        .rating-stars label:hover,
        .rating-stars label:hover ~ label {
            color: #f59e0b;
        }


    </style>
</head>
<body class="bg-gray-100 loading">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex flex-col items-center justify-center bg-gray-50 p-4">
        <div class="max-w-md w-full space-y-8">
            <div class="text-center">
                <h1 class="qg-logo text-5xl">Q'go<span>Cargo</span></h1>
                <h2 class="mt-4 text-center text-2xl font-bold text-gray-700">Delivery Management Portal</h2>
            </div>
            <div class="mt-8 space-y-6 bg-white p-8 rounded-xl shadow-lg">
                <div class="space-y-4">
                    <input id="email-address" name="email" type="email" autocomplete="email" class="input-field" placeholder="Email address">
                    <input id="password" name="password" type="password" autocomplete="current-password" class="input-field" placeholder="Password">
                </div>
                <div class="flex items-center justify-between text-sm">
                    <a href="#" id="forgot-password-link" class="font-medium text-indigo-600 hover:text-indigo-500">Forgot your password?</a>
                </div>
                <div>
                    <button id="auth-btn" class="btn btn-primary w-full text-lg">Sign in</button>
                </div>
                <div class="text-center text-sm text-gray-600">
                    <p>New Driver? <a href="#" id="driver-signup-link" class="font-medium text-indigo-600 hover:text-indigo-500">Sign up here</a></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Public POD View -->
    <div id="public-pod-view" class="hidden"></div>

    <!-- Public Feedback View -->
    <div id="public-feedback-view" class="hidden min-h-screen flex flex-col items-center justify-center bg-gray-50 p-4">
        <div class="max-w-lg w-full space-y-6 bg-white p-8 rounded-xl shadow-lg text-center">
            <h1 class="qg-logo text-4xl">Q'go<span>Cargo</span></h1>
            <div id="feedback-form-container">
                <h2 class="text-2xl font-bold text-gray-800">Rate Your Delivery</h2>
                <p class="text-gray-500 mt-2">Job File: <span id="feedback-job-no" class="font-medium"></span></p>
                <p class="text-gray-500">Driver: <span id="feedback-driver-name" class="font-medium"></span></p>
                <form id="feedback-form" class="mt-6 space-y-6">
                    <input type="hidden" id="feedback-delivery-id">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Your Rating</label>
                        <div class="rating-stars">
                            <input type="radio" id="star5" name="rating" value="5" /><label for="star5" title="5 stars">★</label>
                            <input type="radio" id="star4" name="rating" value="4" /><label for="star4" title="4 stars">★</label>
                            <input type="radio" id="star3" name="rating" value="3" /><label for="star3" title="3 stars">★</label>
                            <input type="radio" id="star2" name="rating" value="2" /><label for="star2" title="2 stars">★</label>
                            <input type="radio" id="star1" name="rating" value="1" /><label for="star1" title="1 star">★</label>
                        </div>
                    </div>
                    <div>
                        <label for="feedback-comment" class="block text-sm font-medium text-gray-700">Comments (Optional)</label>
                        <textarea id="feedback-comment" rows="4" class="input-field mt-1" placeholder="Tell us about your experience..."></textarea>
                    </div>
                    <div>
                        <button type="submit" class="btn btn-primary w-full">Submit Feedback</button>
                    </div>
                </form>
            </div>
            <div id="feedback-thanks-message" class="hidden">
                <h2 class="text-2xl font-bold text-gray-800">Thank You!</h2>
                <p class="text-gray-600 mt-2">Your feedback has been submitted successfully.</p>
            </div>
        </div>
    </div>


    <!-- Main Application Container (Hidden by default) -->
    <div id="app-container" class="hidden container mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header -->
        <header class="flex flex-col sm:flex-row justify-between items-center mb-6 pb-4 border-b border-gray-200">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Delivery System</h1>
                <p id="header-subtitle" class="text-gray-500 mt-1">Assign, track, and manage all job file deliveries.</p>
            </div>
            <div class="text-sm mt-4 sm:mt-0 text-right">
                <p class="font-medium">Welcome, <span id="user-display-name" class="font-bold text-gray-800"></span> (<span id="user-role" class="capitalize text-gray-600"></span>)</p>
                <div class="flex items-center justify-end gap-4 mt-2">
                    <button id="driver-dashboard-btn" class="btn btn-secondary text-xs hidden">Driver Dashboard</button>
                    <button id="admin-panel-btn" class="btn btn-primary text-xs hidden">Admin Panel</button>
                    <button id="logout-btn" class="btn btn-secondary text-xs">Logout</button>
                </div>
            </div>
        </header>

        <!-- Admin / Staff View -->
        <div id="admin-staff-view" class="hidden space-y-12">
            <!-- 1. Dashboard / Overview -->
            <section id="dashboard-section" class="space-y-6">
                <!-- Stat Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center gap-5 border-l-4 border-yellow-400 delivery-card">
                        <div class="bg-yellow-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                        <div><p class="text-base text-gray-500">Pending</p><p id="stat-pending" class="text-3xl font-extrabold text-gray-800">0</p></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center gap-5 border-l-4 border-green-400 delivery-card">
                        <div class="bg-green-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                        <div><p class="text-base text-gray-500">Completed</p><p id="stat-completed" class="text-3xl font-extrabold text-gray-800">0</p></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md flex items-center gap-5 border-l-4 border-blue-400 delivery-card">
                        <div class="bg-blue-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10l2 2h8a1 1 0 001-1z" /></svg></div>
                        <div><p class="text-base text-gray-500">Total Deliveries</p><p id="stat-total" class="text-3xl font-extrabold text-gray-800">0</p></div>
                    </div>
                </div>
            </section>
            
            <!-- 2. Assign New Delivery -->
            <section class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg>
                    <span>Assign New Delivery</span>
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8">
                    <div class="space-y-4">
                        <div class="relative">
                            <label for="job-file-search" class="block text-sm font-medium text-gray-700 mb-1">Search Job File</label>
                            <input type="text" id="job-file-search" class="input-field" placeholder="Job No, Shipper, or Consignee...">
                            <div id="job-file-suggestions" class="suggestions-container hidden"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Job Details</label>
                            <div class="p-3 bg-gray-50 rounded-md text-sm border">
                                <p><strong>Job No:</strong> <span id="form-job-file-no">Select a job</span></p>
                                <p><strong>Details:</strong> <span id="form-job-shipper-consignee">N/A</span></p>
                            </div>
                        </div>
                    </div>
                    <form id="delivery-form" class="space-y-4" novalidate>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="delivery-origin" class="block text-sm font-medium text-gray-700 mb-1">Country of Origin</label>
                                <input type="text" id="delivery-origin" class="input-field" placeholder="Auto-filled from Job">
                            </div>
                            <div>
                                <label for="delivery-destination" class="block text-sm font-medium text-gray-700 mb-1">Destination</label>
                                <input type="text" id="delivery-destination" class="input-field" placeholder="Auto-filled from Job">
                            </div>
                            <div>
                                <label for="delivery-airlines" class="block text-sm font-medium text-gray-700 mb-1">Airlines</label>
                                <input type="text" id="delivery-airlines" class="input-field" placeholder="Auto-filled from Job">
                            </div>
                            <div>
                                <label for="delivery-mawb" class="block text-sm font-medium text-gray-700 mb-1">AWB / MAWB</label>
                                <input type="text" id="delivery-mawb" class="input-field" placeholder="Auto-filled from Job">
                            </div>
                            <div class="col-span-2">
                                <label for="delivery-inv" class="block text-sm font-medium text-gray-700 mb-1">Invoice No.</label>
                                <input type="text" id="delivery-inv" class="input-field" placeholder="Auto-filled from Job">
                            </div>
                        </div>

                        <div>
                            <label for="delivery-location" class="block text-sm font-medium text-gray-700 mb-1">Delivery Location</label>
                            <textarea id="delivery-location" rows="2" class="input-field" placeholder="Enter the full delivery address"></textarea>
                        </div>
                        <div>
                            <label for="additional-notes" class="block text-sm font-medium text-gray-700 mb-1">Additional Notes (Optional)</label>
                            <textarea id="additional-notes" rows="2" class="input-field" placeholder="e.g., Contact person, delivery instructions"></textarea>
                        </div>
                        <div>
                            <label for="driver-select" class="block text-sm font-medium text-gray-700 mb-1">Assign Driver</label>
                            <select id="driver-select" class="input-field">
                                <option value="">-- Select a Driver --</option>
                            </select>
                        </div>
                        <div class="text-right">
                            <button type="submit" class="btn btn-primary">Assign Delivery</button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- 3. Delivery Lists -->
            <section class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-3">
                       <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                       <span>Pending Deliveries</span>
                    </h2>
                    <input type="text" id="pending-search" class="input-field mb-4" placeholder="Search pending deliveries...">
                    <div id="pending-deliveries-list" class="space-y-4 max-h-96 overflow-y-auto"></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <span>Completed Deliveries</span>
                    </h2>
                    <input type="text" id="completed-search" class="input-field mb-4" placeholder="Search completed deliveries...">
                    <div id="completed-deliveries-list" class="space-y-4 max-h-96 overflow-y-auto"></div>
                </div>
            </section>
        </div>

        <!-- Driver View -->
        <div id="driver-view" class="hidden">
            <section class="bg-white p-6 rounded-xl shadow-md">
                <div class="flex justify-between items-center mb-6 pb-4 border-b">
                    <h2 class="text-2xl font-bold text-gray-800">My Dashboard</h2>
                    <button id="my-feedback-btn" class="btn btn-primary text-sm">My Feedback & Ratings</button>
                </div>
                <div id="driver-performance-summary" class="mb-6">
                    <!-- Driver performance summary will be loaded here -->
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-4">My Assigned Deliveries</h3>
                <div id="driver-tasks-list" class="space-y-4"></div>
            </section>
        </div>
    </div>

    <!-- Modals -->
    <div id="loader-overlay" class="overlay"><div class="loader"></div></div>
    <div id="notification"></div>
    
    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="overlay">
        <div class="modal-content max-w-sm">
            <h3 class="text-lg font-bold mb-4" id="confirm-title">Confirm Action</h3>
            <div id="confirm-message" class="mb-4 text-sm">Are you sure?</div>
            <div class="text-right mt-6 space-x-2">
                <button id="confirm-cancel" class="btn btn-secondary">Cancel</button>
                <button id="confirm-ok" class="btn btn-danger">Confirm</button>
            </div>
        </div>
    </div>
    
    <!-- Admin Panel Modal -->
    <div id="admin-panel-modal" class="overlay">
        <div class="modal-content max-w-3xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">User Management</h3>
                <button onclick="closeModal('admin-panel-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div class="space-y-4">
                <div id="user-list-admin" class="space-y-2 max-h-[60vh] overflow-y-auto">
                    <!-- User list will be populated here -->
                </div>
                <div class="text-right">
                    <button onclick="saveUserChanges()" class="btn btn-success">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delivery Completion Modal (for Driver) -->
    <div id="delivery-completion-modal" class="overlay">
        <div class="modal-content max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Complete Delivery</h3>
                <button onclick="closeModal('delivery-completion-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div id="completion-form-wrapper">
                <form id="completion-form" class="space-y-4" novalidate>
                    <input type="hidden" id="delivery-id-input">
                    <div class="p-4 bg-gray-50 rounded-md">
                        <p><strong>Job File:</strong> <span id="modal-job-no"></span></p>
                        <p><strong>Location:</strong> <span id="modal-location"></span></p>
                    </div>
                    <div>
                        <label for="receiver-name" class="block text-sm font-medium text-gray-700">Receiver's Name</label>
                        <input type="text" id="receiver-name" class="input-field mt-1">
                    </div>
                    <div>
                        <label for="receiver-mobile" class="block text-sm font-medium text-gray-700">Receiver's Mobile Number</label>
                        <input type="tel" id="receiver-mobile" class="input-field mt-1">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Receiver's Signature</label>
                        <div class="relative w-full h-48 mt-1">
                            <canvas id="completion-signature-pad" class="signature-pad-canvas absolute top-0 left-0 w-full h-full"></canvas>
                        </div>
                        <div class="text-right mt-1">
                            <button type="button" id="clear-completion-signature-btn" class="btn btn-secondary text-xs">Clear</button>
                        </div>
                    </div>
                    <div>
                        <button type="button" id="get-location-btn" class="btn btn-secondary text-sm w-full">Get Current Location</button>
                        <p id="location-status" class="text-xs text-gray-500 mt-1 text-center"></p>
                    </div>
                    <div class="flex justify-end items-center gap-4 pt-4">
                        <button type="submit" class="btn btn-success">Mark as Delivered</button>
                    </div>
                </form>
            </div>
            <!-- This new section will show the QR code after delivery is completed -->
            <div id="post-delivery-qr-wrapper" class="hidden text-center">
                <h3 class="text-xl font-bold text-gray-800">Delivery Complete!</h3>
                <p class="text-gray-600 mt-2 mb-4">Please ask the customer to scan this QR code to rate their delivery experience.</p>
                <div class="flex justify-center my-4">
                    <div id="feedback-qrcode-container" class="p-2 bg-white border rounded-lg inline-block"></div>
                </div>
                <p class="text-xs text-gray-500">The customer will use their own device to provide feedback.</p>
                <div class="mt-6 text-center">
                    <button onclick="closeModal('delivery-completion-modal')" class="btn btn-primary">Finish & Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Receipt Modal (For Viewing Receipts) -->
    <div id="receipt-modal" class="overlay">
        <div class="modal-content max-w-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 id="receipt-modal-title" class="text-2xl font-bold">View Receipt</h3>
                <button onclick="closeModal('receipt-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            
            <div id="receipt-view">
                <div id="receipt-content" class="p-4 border rounded-md">
                    <!-- Receipt content will be generated here -->
                </div>
                <div class="text-right mt-4 flex justify-end gap-2">
                    <button id="copy-link-btn" class="btn btn-secondary">Copy Link</button>
                    <button id="share-btn" class="btn btn-primary">Share</button>
                    <button id="pdf-receipt-btn" class="btn btn-secondary">PDF</button>
                    <button id="print-receipt-btn" class="btn btn-primary">Print</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Driver Signup Modal -->
    <div id="signup-modal" class="overlay">
        <div class="modal-content max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Driver Registration</h3>
                <button onclick="closeModal('signup-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <form id="signup-form" class="space-y-4">
                <div>
                    <label for="signup-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                    <input type="text" id="signup-name" class="input-field mt-1" required>
                </div>
                <div>
                    <label for="signup-email" class="block text-sm font-medium text-gray-700">Email Address</label>
                    <input type="email" id="signup-email" class="input-field mt-1" required>
                </div>
                <div>
                    <label for="signup-password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="signup-password" class="input-field mt-1" required>
                </div>
                <div class="text-right pt-4">
                    <button type="submit" class="btn btn-primary">Create Account</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Forgot Password Modal -->
    <div id="forgot-password-modal" class="overlay">
        <div class="modal-content max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Reset Password</h3>
                <button onclick="closeModal('forgot-password-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <form id="forgot-password-form" class="space-y-4">
                <p class="text-sm text-gray-600">Enter your email address and we will send you a link to reset your password.</p>
                <div>
                    <label for="forgot-email" class="block text-sm font-medium text-gray-700">Email Address</label>
                    <input type="email" id="forgot-email" class="input-field mt-1" required>
                </div>
                <div class="text-right pt-4">
                    <button type="submit" class="btn btn-primary">Send Reset Link</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Driver Performance Modal -->
    <div id="driver-performance-modal" class="overlay">
        <div class="modal-content max-w-4xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Driver Performance Dashboard</h3>
                <button onclick="closeModal('driver-performance-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div id="driver-performance-body" class="space-y-6">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <canvas id="driver-chart"></canvas>
                </div>
                <div id="driver-stats-list" class="space-y-4 max-h-[50vh] overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <!-- User-Specific Jobs Modal (For showing driver deliveries) -->
    <div id="user-jobs-modal" class="overlay">
        <div class="modal-content max-w-5xl">
            <div class="flex justify-between items-center mb-4">
                <h3 id="user-jobs-modal-title" class="text-2xl font-bold">Deliveries</h3>
                <button onclick="closeModal('user-jobs-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div id="user-jobs-list" class="space-y-2 max-h-[70vh] overflow-y-auto">
                <!-- JS will populate this list -->
            </div>
        </div>
    </div>

    <!-- View Feedback Modal -->
    <div id="view-feedback-modal" class="overlay">
        <div class="modal-content max-w-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 id="feedback-modal-title" class="text-2xl font-bold">Driver Feedback</h3>
                <button onclick="closeModal('view-feedback-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div id="feedback-list" class="space-y-3 max-h-[60vh] overflow-y-auto">
                <!-- Feedback list will be populated here -->
            </div>
        </div>
    </div>


    <!-- Firebase SDK and App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, serverTimestamp, getDocs, writeBatch, addDoc, updateDoc, deleteDoc, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Global variables ---
        let db, auth;
        let currentUser = null;
        let jobFilesCache = [];
        let allUsersCache = [];
        let deliveriesCache = [];
        let feedbackCache = [];
        let selectedJobFile = null;
        let currentGeolocation = null;
        let deliveriesUnsubscribe = () => {};
        let driverTasksUnsubscribe = () => {};
        let completionSignaturePad;
        let activeDeliveryForReceipt = null;
        let activeDeliveryForCompletion = null;
        let driverChartInstance = null;


        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAAulR2nJQm-4QtNyEqKTnnDPw-iKW92Mc",
            authDomain: "my-job-file-system.firebaseapp.com",
            projectId: "my-job-file-system",
            storageBucket: "my-job-file-system.appspot.com",
            messagingSenderId: "145307873304",
            appId: "1:145307873304:web:d661ea6ec118801b4a136d",
            measurementId: "G-8EHX5K7YHL"
        };

        // --- App Initialization ---
        async function initializeAppLogic() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                const urlParams = new URLSearchParams(window.location.search);
                const podId = urlParams.get('podId');
                const feedbackId = urlParams.get('feedbackId');

                if (feedbackId) {
                    showPublicFeedbackView(feedbackId);
                } else if (podId) {
                    showPublicPodView(podId);
                } else {
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            const userDocRef = doc(db, 'users', user.uid);
                            const userDoc = await getDoc(userDocRef);

                            if (userDoc.exists() && userDoc.data().status === 'active') {
                                currentUser = { uid: user.uid, ...userDoc.data() };
                                showApp();
                            } else {
                                if (userDoc.exists()) {
                                    showNotification("Your account is inactive or pending admin approval.", true);
                                }
                                currentUser = null;
                                await signOut(auth);
                                showLogin();
                            }
                        } else {
                            currentUser = null;
                            showLogin();
                        }
                        document.body.classList.remove('loading');
                    });
                }
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showNotification("Could not connect to the database.", true);
                document.body.classList.remove('loading');
            }
        }

        // --- Authentication Logic ---
        async function handleLogin() {
            const email = document.getElementById('email-address').value;
            const password = document.getElementById('password').value;
            if (!email || !password) {
                showNotification("Please enter both email and password.", true);
                return;
            }
            showLoader();
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login failed:", error);
                let message = "Login failed. Please check your credentials.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    message = "Incorrect email or password.";
                }
                showNotification(message, true);
            } finally {
                hideLoader();
            }
        }

        async function handleSignup(e) {
            e.preventDefault();
            const name = document.getElementById('signup-name').value.trim();
            const email = document.getElementById('signup-email').value.trim();
            const password = document.getElementById('signup-password').value.trim();
            if(!name || !email || !password) {
                showNotification("Please fill out all fields.", true);
                return;
            }
            if(password.length < 6) {
                showNotification("Password must be at least 6 characters long.", true);
                return;
            }
            showLoader();
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Create user document in Firestore
                await setDoc(doc(db, "users", user.uid), {
                    displayName: name,
                    email: email,
                    role: 'driver',
                    status: 'inactive', // inactive until admin approves
                    createdAt: serverTimestamp()
                });
                
                closeModal('signup-modal');
                showNotification("Account created! Please wait for admin approval.", false);
                await signOut(auth);

            } catch (error) {
                console.error("Signup failed:", error);
                if (error.code === 'auth/email-already-in-use') {
                    showNotification("This email address is already in use.", true);
                } else {
                    showNotification("Could not create account. Please try again.", true);
                }
            } finally {
                hideLoader();
            }
        }

        async function handleForgotPassword(e) {
            e.preventDefault();
            const email = document.getElementById('forgot-email').value.trim();
            if(!email) {
                showNotification("Please enter your email address.", true);
                return;
            }
            showLoader();
            try {
                await sendPasswordResetEmail(auth, email);
                closeModal('forgot-password-modal');
                showNotification("Password reset link sent! Check your email.", false);
            } catch (error) {
                console.error("Password reset failed:", error);
                showNotification("Could not send reset link. Check the email address.", true);
            } finally {
                hideLoader();
            }
        }
        
        // --- UI & View Management ---
        function showLogin() {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('app-container').style.display = 'none';
        }

        function showApp() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('public-pod-view').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            
            document.getElementById('user-display-name').textContent = currentUser.displayName;
            document.getElementById('user-role').textContent = currentUser.role;

            document.getElementById('admin-staff-view').style.display = 'none';
            document.getElementById('driver-view').style.display = 'none';
            document.getElementById('admin-panel-btn').classList.add('hidden');
            document.getElementById('driver-dashboard-btn').classList.add('hidden');
            
            // Allow any active user to log in. The UI will adapt based on their role.
            if (currentUser.role === 'driver') {
                document.getElementById('driver-view').style.display = 'block';
                document.getElementById('header-subtitle').textContent = "View and complete your assigned deliveries.";
                loadDriverTasks();
            } else { // Default view for admin, staff, and other roles
                document.getElementById('admin-staff-view').style.display = 'block';
                document.getElementById('header-subtitle').textContent = "Assign, track, and manage deliveries.";
                if (currentUser.role === 'admin' || currentUser.role === 'staff') {
                    document.getElementById('driver-dashboard-btn').classList.remove('hidden');
                }
                if (currentUser.role === 'admin') {
                    document.getElementById('admin-panel-btn').classList.remove('hidden');
                }
                loadAdminData();
            } 
        }
        
        // --- Admin / Staff Logic ---
        async function loadAdminData() {
            showLoader();
            try {
                const jobFilesPromise = getDocs(collection(db, 'jobfiles'));
                const usersPromise = getDocs(collection(db, 'users'));

                const [jobFilesSnapshot, usersSnapshot] = await Promise.all([jobFilesPromise, usersPromise]);

                jobFilesCache = jobFilesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allUsersCache = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                populateDriverDropdown();
                listenForDeliveries();

            } catch (error) {
                console.error("Error loading admin data: ", error);
                showNotification("Failed to load initial data. Check Firestore permissions.", true);
            } finally {
                hideLoader();
            }
        }
        
        function populateDriverDropdown() {
            const assignmentSelect = document.getElementById('driver-select');
            if (!assignmentSelect) return;

            assignmentSelect.innerHTML = '<option value="">-- Select a Driver --</option>';
            const activeDrivers = allUsersCache.filter(u => u.role === 'driver' && u.status === 'active');
            activeDrivers.forEach(driver => {
                const option = document.createElement('option');
                option.value = driver.id;
                option.textContent = driver.displayName;
                assignmentSelect.appendChild(option);
            });
        }
        
        function listenForDeliveries() {
            if (deliveriesUnsubscribe) deliveriesUnsubscribe(); // Unsubscribe from previous listener
            const deliveriesRef = collection(db, 'deliveries');
            deliveriesUnsubscribe = onSnapshot(deliveriesRef, (snapshot) => {
                deliveriesCache = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                deliveriesCache.sort((a,b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
                
                renderAllDeliveryViews();
            }, (error) => {
                console.error("Firestore Error (Deliveries):", error);
                showNotification("Permission error: Could not load delivery data.", true);
            });
        }

        function renderAllDeliveryViews() {
            renderDashboardMetrics();
            
            const pendingList = document.getElementById('pending-deliveries-list');
            const completedList = document.getElementById('completed-deliveries-list');
            pendingList.innerHTML = '';
            completedList.innerHTML = '';

            const pendingSearchTerm = document.getElementById('pending-search').value.toLowerCase();
            const completedSearchTerm = document.getElementById('completed-search').value.toLowerCase();

            const searchFilter = (delivery, term) => {
                if (!term) return true;
                const job = delivery.jobFileData || {};
                return (
                    (job.jfn && job.jfn.toLowerCase().includes(term)) ||
                    (job.sh && job.sh.toLowerCase().includes(term)) ||
                    (job.co && job.co.toLowerCase().includes(term)) ||
                    (delivery.driverName && delivery.driverName.toLowerCase().includes(term)) ||
                    (delivery.receiverName && delivery.receiverName.toLowerCase().includes(term))
                );
            };

            const pendingDeliveries = deliveriesCache
                .filter(d => d.status !== 'Delivered')
                .filter(d => searchFilter(d, pendingSearchTerm));

            const completedDeliveries = deliveriesCache
                .filter(d => d.status === 'Delivered')
                .filter(d => searchFilter(d, completedSearchTerm));


            if (pendingDeliveries.length > 0) {
                pendingDeliveries.forEach(delivery => pendingList.appendChild(createDeliveryCard(delivery)));
            } else {
                pendingList.innerHTML = '<p class="text-gray-500 text-center py-4">No pending deliveries found.</p>';
            }

            if (completedDeliveries.length > 0) {
                completedDeliveries.forEach(delivery => completedList.appendChild(createDeliveryCard(delivery)));
            } else {
                completedList.innerHTML = '<p class="text-gray-500 text-center py-4">No completed deliveries found.</p>';
            }
        }
        
        function renderDashboardMetrics() {
            const pendingCount = deliveriesCache.filter(d => d.status !== 'Delivered').length;
            const completedCount = deliveriesCache.filter(d => d.status === 'Delivered').length;
            
            document.getElementById('stat-pending').textContent = pendingCount;
            document.getElementById('stat-completed').textContent = completedCount;
            document.getElementById('stat-total').textContent = deliveriesCache.length;
        }

        function createDeliveryCard(delivery) {
            const card = document.createElement('div');
            card.className = 'border p-3 rounded-lg bg-gray-50 delivery-card';
            const jobData = delivery.jobFileData || {};
            let actionButtons = '';

            if (delivery.status === 'Delivered') {
                if (currentUser.role === 'admin') {
                    actionButtons += `<button class="btn btn-danger btn-xs text-xs" onclick="confirmPodCancel('${delivery.id}', '${jobData.jfn}')">Cancel POD</button>`;
                }
                actionButtons += `${delivery.podId ? `<button class="btn btn-secondary btn-xs text-xs" onclick="openReceiptModal('${delivery.id}')">View Receipt</button>` : ''}`;
            }

            const deliveredInfo = delivery.status === 'Delivered' ? `
                <div class="mt-2 pt-2 border-t flex justify-between items-center">
                    <div>
                        <p class="text-xs"><strong>Receiver:</strong> ${delivery.receiverName || 'N/A'}</p>
                        <p class="text-xs"><strong>Completed:</strong> ${delivery.completedAt?.toDate().toLocaleString() || 'N/A'}</p>
                    </div>
                    <div class="flex gap-2">
                       ${actionButtons}
                    </div>
                </div>
                ` : '';

            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <p class="font-bold">${jobData.jfn || 'Unknown Job'}</p>
                        <p class="text-sm text-gray-700">${jobData.sh || 'N/A'} to ${jobData.co || 'N/A'}</p>
                        <p class="text-xs text-gray-500">Assigned to: <strong>${delivery.driverName || 'N/A'}</strong></p>
                    </div>
                    <span class="text-xs font-semibold px-2 py-1 rounded-full ${delivery.status === 'Delivered' ? 'bg-green-200 text-green-800' : 'bg-yellow-200 text-yellow-800'}">
                        ${delivery.status}
                    </span>
                </div>
                ${deliveredInfo}
            `;

            return card;
        }

        function handleJobFileSearch(e) {
            const searchTerm = e.target.value.toLowerCase();
            const suggestionsEl = document.getElementById('job-file-suggestions');

            if (searchTerm.length < 2) {
                suggestionsEl.innerHTML = '';
                suggestionsEl.classList.add('hidden');
                return;
            }

            const filteredJobs = jobFilesCache.filter(job => 
                (job.jfn && job.jfn.toLowerCase().includes(searchTerm)) ||
                (job.sh && job.sh.toLowerCase().includes(searchTerm)) ||
                (job.co && job.co.toLowerCase().includes(searchTerm))
            ).slice(0, 10);

            if (filteredJobs.length > 0) {
                suggestionsEl.innerHTML = filteredJobs.map(job => 
                    `<div class="suggestion-item p-2 hover:bg-gray-100 cursor-pointer" data-id="${job.id}">${job.jfn} - ${job.sh}</div>`
                ).join('');
                suggestionsEl.classList.remove('hidden');
            } else {
                suggestionsEl.innerHTML = '';
                suggestionsEl.classList.add('hidden');
            }
        }
        
        function selectJobFile(e) {
            if (e.target.classList.contains('suggestion-item')) {
                const jobId = e.target.dataset.id;
                selectedJobFile = jobFilesCache.find(job => job.id === jobId);
                
                if (selectedJobFile) {
                    document.getElementById('form-job-file-no').textContent = selectedJobFile.jfn;
                    document.getElementById('form-job-shipper-consignee').textContent = `${selectedJobFile.sh} / ${selectedJobFile.co}`;
                    document.getElementById('job-file-search').value = selectedJobFile.jfn;
                    // Corrected Auto-fill logic using keys from the main file
                    document.getElementById('delivery-origin').value = selectedJobFile.or || '';
                    document.getElementById('delivery-destination').value = selectedJobFile.de || '';
                    document.getElementById('delivery-airlines').value = selectedJobFile.ca || '';
                    document.getElementById('delivery-mawb').value = selectedJobFile.mawb || '';
                    document.getElementById('delivery-inv').value = selectedJobFile.in || '';
                }
                document.getElementById('job-file-suggestions').classList.add('hidden');
            }
        }

        async function handleAssignDelivery(e) {
            e.preventDefault();
            if (!selectedJobFile) {
                showNotification("Please select a job file first.", true);
                return;
            }

            const driverId = document.getElementById('driver-select').value;
            const location = document.getElementById('delivery-location').value.trim();

            if (!driverId || !location) {
                showNotification("Please select a driver and enter a location.", true);
                return;
            }

            // Check for existing delivery
            const existingDelivery = deliveriesCache.find(delivery => delivery.jobFileId === selectedJobFile.id);
            if (existingDelivery) {
                showNotification(`A delivery for Job File "${selectedJobFile.jfn}" has already been assigned.`, true);
                return;
            }
            
            showLoader();
            try {
                const driver = allUsersCache.find(d => d.id === driverId);
                const deliveryData = {
                    jobFileId: selectedJobFile.id,
                    jobFileData: { // Store a snapshot of key data, reading from the form and using main system keys
                        jfn: selectedJobFile.jfn || 'N/A',
                        sh: selectedJobFile.sh || 'N/A',
                        co: selectedJobFile.co || 'N/A',
                        dsc: selectedJobFile.dsc || 'N/A',
                        gw: selectedJobFile.gw || 'N/A',
                        mawb: document.getElementById('delivery-mawb').value.trim() || 'N/A',
                        or: document.getElementById('delivery-origin').value.trim() || 'N/A', 
                        de: document.getElementById('delivery-destination').value.trim() || 'N/A',
                        ca: document.getElementById('delivery-airlines').value.trim() || 'N/A',
                        in: document.getElementById('delivery-inv').value.trim() || 'N/A',
                    },
                    deliveryLocation: location,
                    deliveryNotes: document.getElementById('additional-notes')?.value.trim(),
                    driverUid: driver.id,
                    driverName: driver.displayName,
                    status: 'Pending',
                    createdAt: serverTimestamp(),
                };

                await addDoc(collection(db, 'deliveries'), deliveryData);

                showNotification("Delivery assigned successfully!");
                document.getElementById('delivery-form').reset();
                document.getElementById('form-job-file-no').textContent = 'Select a job';
                document.getElementById('form-job-shipper-consignee').textContent = 'N/A';
                document.getElementById('job-file-search').value = '';
                selectedJobFile = null;

            } catch(error) {
                console.error("Error assigning delivery:", error);
                showNotification("Could not assign delivery. Check Firestore permissions.", true);
            } finally {
                hideLoader();
            }
        }

        // --- Driver Logic & Simulation ---
        function createDriverTaskCard(task) {
            const taskCard = document.createElement('div');
            taskCard.className = `border p-4 rounded-lg shadow-sm delivery-card ${task.status === 'Pending' ? 'bg-white' : 'bg-gray-200'}`;
            const jobData = task.jobFileData || {};

            let actionButton = '';
            if (task.status === 'Pending') {
                actionButton = `<button class="btn btn-primary text-sm">Complete Delivery</button>`;
                taskCard.classList.add('cursor-pointer', 'hover:bg-gray-50');
            } else {
                actionButton = `<button class="btn btn-secondary text-sm">View Receipt</button>`;
            }

            taskCard.innerHTML = `
                <div class="flex justify-between items-center">
                    <div>
                        <p class="font-bold text-lg">${jobData.jfn}</p>
                        <p class="text-sm text-gray-700"><strong>To:</strong> ${task.deliveryLocation}</p>
                        <p class="text-xs text-gray-500"><strong>Assigned:</strong> ${task.createdAt?.toDate().toLocaleString()}</p>
                    </div>
                    <div class="flex flex-col items-end gap-2">
                        <span class="text-sm font-semibold px-2 py-1 rounded-full ${task.status === 'Delivered' ? 'bg-green-200 text-green-800' : 'bg-yellow-200 text-yellow-800'}">
                            ${task.status}
                        </span>
                        ${actionButton}
                    </div>
                </div>
            `;
            taskCard.querySelector('button')?.addEventListener('click', (e) => {
                e.stopPropagation();
                if (task.status === 'Pending') {
                    openCompletionModal(task)
                } else {
                    openReceiptModal(task.id)
                }
            });
            return taskCard;
        }

        function loadDriverTasks() {
            if (driverTasksUnsubscribe) driverTasksUnsubscribe();
            const q = query(collection(db, "deliveries"), where("driverUid", "==", currentUser.uid));
            
            driverTasksUnsubscribe = onSnapshot(q, (snapshot) => {
                const listEl = document.getElementById('driver-tasks-list');
                listEl.innerHTML = '';
                
                const tasks = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                tasks.sort((a,b) => {
                    if (a.status === 'Pending' && b.status !== 'Pending') return -1;
                    if (a.status !== 'Pending' && b.status === 'Pending') return 1;
                    return (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0);
                });

                if (tasks.length > 0) {
                    tasks.forEach(task => listEl.appendChild(createDriverTaskCard(task)));
                } else {
                    listEl.innerHTML = '<p class="text-gray-500">You have no assigned deliveries.</p>';
                }
                
                // Display performance summary on driver page
                displayDriverPerformanceSummary(currentUser.uid, tasks);

            }, (error) => {
                console.error("Firestore Error (Driver Tasks):", error);
                showNotification("Permission error: Could not load your assigned tasks.", true);
            });
        }
        
        function openCompletionModal(delivery) {
            activeDeliveryForCompletion = delivery; 
            document.getElementById('delivery-id-input').value = delivery.id;
            document.getElementById('modal-job-no').textContent = delivery.jobFileData.jfn;
            document.getElementById('modal-location').textContent = delivery.deliveryLocation;
            document.getElementById('completion-form').reset();

            // Reset modal to show completion form first
            document.getElementById('completion-form-wrapper').style.display = 'block';
            document.getElementById('post-delivery-qr-wrapper').style.display = 'none';

            
            const canvas = document.getElementById('completion-signature-pad');
            const resizeCanvas = () => {
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                const context = canvas.getContext("2d");
                context.scale(ratio, ratio);
                context.fillStyle = "white";
                context.fillRect(0, 0, canvas.width, canvas.height);
                if (completionSignaturePad) completionSignaturePad.clear();
            }
            setTimeout(resizeCanvas, 10);
            
            if (!completionSignaturePad) {
                completionSignaturePad = new SignaturePad(canvas, {
                    backgroundColor: 'rgb(255, 255, 255)' // Set background to white
                });
            } else {
                completionSignaturePad.clear();
            }

            document.getElementById('location-status').textContent = '';
            currentGeolocation = null;
            openModal('delivery-completion-modal');
        }

        async function handleCompleteDelivery(e) {
            e.preventDefault();
            const deliveryId = document.getElementById('delivery-id-input').value;
            const receiverName = document.getElementById('receiver-name').value.trim();
            const receiverMobile = document.getElementById('receiver-mobile').value.trim();

            if (!receiverName || !receiverMobile) {
                showNotification("Please enter the receiver's name and mobile number.", true);
                return;
            }
            if (completionSignaturePad.isEmpty()) {
                showNotification("Please capture the receiver's signature.", true);
                return;
            }

            showLoader();
            try {
                const signatureDataUrl = completionSignaturePad.toDataURL('image/jpeg', 0.5);
                
                const deliveryData = activeDeliveryForCompletion;
                if (!deliveryData) {
                    throw new Error("Could not find the delivery data to process.");
                }

                const podData = {
                    deliveryId: deliveryId,
                    jobFileId: deliveryData.jobFileId,
                    jobFileData: deliveryData.jobFileData,
                    deliveryLocation: deliveryData.deliveryLocation,
                    receiverName: receiverName,
                    receiverMobile: receiverMobile,
                    signatureDataUrl: signatureDataUrl, // Save as Data URL
                    completedAt: serverTimestamp(),
                    driverUid: currentUser.uid,
                    driverName: currentUser.displayName,
                };
                if (currentGeolocation) {
                    podData.geolocation = currentGeolocation.coords;
                    podData.geolocationName = currentGeolocation.displayName;
                }

                const podDocRef = doc(db, 'pods', deliveryId);
                await setDoc(podDocRef, podData);

                const deliveryRef = doc(db, 'deliveries', deliveryId);
                await updateDoc(deliveryRef, {
                    status: 'Delivered',
                    completedAt: serverTimestamp(),
                    podId: deliveryId,
                    receiverName: receiverName
                });

                // Transition to QR code view
                document.getElementById('completion-form-wrapper').style.display = 'none';
                document.getElementById('post-delivery-qr-wrapper').style.display = 'block';

                const qrContainer = document.getElementById('feedback-qrcode-container');
                qrContainer.innerHTML = '';
                new QRCode(qrContainer, {
                    text: `${window.location.origin}${window.location.pathname}?feedbackId=${deliveryId}`,
                    width: 150,
                    height: 150,
                });


            } catch (error) {
                console.error("Error completing delivery:", error);
                showNotification(`Failed to complete delivery: ${error.message}`, true);
            } finally {
                hideLoader();
            }
        }
        
        function handleGetLocation() {
            const statusEl = document.getElementById('location-status');
            if (!navigator.geolocation) {
                statusEl.textContent = 'Geolocation is not supported by your browser.';
                return;
            }

            statusEl.textContent = 'Getting location...';
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const coords = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    statusEl.textContent = `Coordinates captured. Fetching address...`;

                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${coords.lat}&lon=${coords.lng}`);
                        if(!response.ok) throw new Error('Network response was not ok');
                        const data = await response.json();
                        const displayName = data.display_name || 'Address not found';
                        
                        currentGeolocation = {
                            coords: coords,
                            displayName: displayName
                        };
                        statusEl.textContent = `Location: ${displayName}`;
                        statusEl.style.color = '#16a34a';

                    } catch (error) {
                        console.error('Reverse geocoding error:', error);
                        statusEl.textContent = 'Could not fetch address name, but coordinates saved.';
                        currentGeolocation = { coords: coords, displayName: 'N/A' };
                        statusEl.style.color = '#eab308';
                    }
                },
                () => {
                    statusEl.textContent = 'Unable to retrieve your location.';
                    statusEl.style.color = '#dc2626';
                }
            );
        }

        // --- Receipt Logic ---
        async function openReceiptModal(deliveryId) {
            showLoader();
            try {
                const podDocRef = doc(db, 'pods', deliveryId);
                const podDoc = await getDoc(podDocRef);
                
                if (podDoc.exists()) {
                    activeDeliveryForReceipt = podDoc.data();
                } else {
                    throw new Error("Receipt data not found in PODs collection.");
                }

                openModal('receipt-modal', true);
                generateReceipt();

            } catch (error) {
                console.error("Error opening receipt:", error);
                showNotification(error.message, true);
            } finally {
                hideLoader();
            }
        }

        function generateReceipt() {
            const receiptContent = document.getElementById('receipt-content');
            const data = activeDeliveryForReceipt;
            const jobData = data.jobFileData;
            const deliveryDate = (data.completedAt?.toDate() || new Date()).toLocaleString();

            let locationInfo = data.geolocationName || 'Not Captured.';
            if (data.geolocation) {
                locationInfo += ` <a href="https://www.google.com/maps?q=${data.geolocation.lat},${data.geolocation.lng}" target="_blank" class="text-blue-600 hover:underline text-xs ml-2">[View on Map]</a>`;
            }

            receiptContent.innerHTML = `
                <div class="space-y-6 text-gray-800">
                    <!-- Header -->
                    <div class="flex justify-between items-start pb-4 border-b-2 border-gray-200">
                        <div>
                            <div class="text-3xl font-extrabold" style="color: #0E639C;">Q'go<span style="color: #4FB8AF;">Cargo</span></div>
                            <p class="text-sm text-gray-500 font-semibold">PROOF OF DELIVERY</p>
                        </div>
                        <div id="qr-code-section" class="text-center p-2 rounded-lg bg-gray-100">
                            <p class="text-sm font-bold text-gray-800">Verify POD</p>
                            <div id="receipt-verification-qrcode" class="p-1 bg-white border rounded-md inline-block mt-1"></div>
                            <p class="text-xs text-gray-500 mt-1">Scan to verify online</p>
                        </div>
                    </div>

                    <!-- Job Details -->
                    <div class="grid grid-cols-2 gap-x-8 gap-y-4 text-sm">
                        <div><strong class="text-gray-500 block">Job File No:</strong> <span class="font-mono">${jobData.jfn || 'N/A'}</span></div>
                        <div><strong class="text-gray-500 block">Invoice No:</strong> <span class="font-mono">${jobData.in || 'N/A'}</span></div>
                        <div><strong class="text-gray-500 block">AWB / MAWB:</strong> <span class="font-mono">${jobData.mawb || 'N/A'}</span></div>
                        <div><strong class="text-gray-500 block">Airlines:</strong> ${jobData.ca || 'N/A'}</div>
                        <div><strong class="text-gray-500 block">Shipper:</strong> ${jobData.sh || 'N/A'}</div>
                        <div><strong class="text-gray-500 block">Consignee:</strong> ${jobData.co || 'N/A'}</div>
                        <div><strong class="text-gray-500 block">Origin:</strong> ${jobData.or || 'N/A'}</div>
                        <div><strong class="text-gray-500 block">Destination:</strong> ${jobData.de || 'N/A'}</div>
                        <div class="col-span-2"><strong class="text-gray-500 block">Description:</strong> ${jobData.dsc || 'N/A'}</div>
                        <div class="col-span-2"><strong class="text-gray-500 block">Gross Weight:</strong> ${jobData.gw || 'N/A'}</div>
                    </div>

                    <!-- Delivery Details -->
                    <div class="bg-gray-50 p-4 rounded-lg border">
                        <h4 class="font-bold text-lg mb-3">Delivery Confirmation</h4>
                        <div class="grid grid-cols-2 gap-x-8 gap-y-3 text-sm">
                            <div><strong class="text-gray-500 block">Delivered To:</strong> ${data.receiverName}</div>
                            <div><strong class="text-gray-500 block">Contact:</strong> ${data.receiverMobile}</div>
                            <div class="col-span-2"><strong class="text-gray-500 block">Date & Time:</strong> ${deliveryDate}</div>
                            <div class="col-span-2"><strong class="text-gray-500 block">Delivery Address:</strong> ${data.deliveryLocation}</div>
                            <div class="col-span-2"><strong class="text-gray-500 block">GPS Location:</strong> ${locationInfo}</div>
                            <div class="col-span-2"><strong class="text-gray-500 block">POD Confirmed By (Driver):</strong> ${data.driverName}</div>
                        </div>
                        <div class="mt-4 pt-4 border-t">
                            <p class="text-gray-600 text-sm italic mb-2">"I, <strong>${data.receiverName}</strong>, confirm I have received this shipment from the driver, <strong>${data.driverName}</strong>, in good condition on the date specified above."</p>
                            <p class="text-gray-500 text-sm font-bold mb-1">Receiver's Signature:</p>
                            <img src="${data.signatureDataUrl}" alt="Signature" class="w-48 bg-white border-2 p-1 rounded-md shadow-inner"/>
                        </div>
                    </div>
                    
                    <div class="text-center text-xs text-gray-400 pt-4">
                        Thank you for your business.
                    </div>
                </div>
            `;
            
            // Separate QR Code for verification
            const qrContainer = document.getElementById('receipt-verification-qrcode');
            qrContainer.innerHTML = '';
            new QRCode(qrContainer, {
                text: window.location.origin + window.location.pathname + '?podId=' + data.deliveryId,
                width: 80,
                height: 80,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        }
        
        async function downloadReceiptAsPDF() {
            showLoader();
            const { jsPDF } = window.jspdf;
            const receiptElement = document.getElementById('receipt-content');
            
            try {
                const canvas = await html2canvas(receiptElement, { scale: 2 });
                const imgData = canvas.toDataURL('image/png');
                
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'pt',
                    format: 'a4'
                });
                
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const canvasWidth = canvas.width;
                const canvasHeight = canvas.height;
                const ratio = canvasWidth / canvasHeight;
                const pdfRatio = pdfWidth / pdfHeight;

                let finalWidth, finalHeight;
                if(ratio > pdfRatio){
                    finalWidth = pdfWidth;
                    finalHeight = pdfWidth / ratio;
                } else {
                    finalHeight = pdfHeight;
                    finalWidth = pdfHeight * ratio;
                }
                
                const x = (pdfWidth - finalWidth) / 2;
                const y = (pdfHeight - finalHeight) / 2;

                pdf.addImage(imgData, 'PNG', x, y, finalWidth, finalHeight);
                pdf.save(`Receipt-${activeDeliveryForReceipt.jobFileData.jfn}.pdf`);

            } catch (error) {
                console.error("Error generating PDF:", error);
                showNotification("Could not generate PDF.", true);
            } finally {
                hideLoader();
            }
        }

        function printReceipt() {
            const receiptHTML = document.getElementById('receipt-content').innerHTML;
            const printWindow = window.open('', '', 'height=842,width=595');
            printWindow.document.write('<html><head><title>Delivery Receipt</title>');
            printWindow.document.write('<script src="https://cdn.tailwindcss.com"><\/script>');
            printWindow.document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"><\/script>');
            printWindow.document.write(`
                <style>
                    @media print {
                        @page {
                            size: A4;
                            margin: 15mm;
                        }
                    }
                    body {
                        font-family: 'Inter', sans-serif;
                    }
                </style>
            `);
            printWindow.document.write('</head><body>');
            printWindow.document.write(receiptHTML);
            printWindow.document.write(`
                <script>
                    window.onload = function() {
                        const qrContainer = document.getElementById('receipt-verification-qrcode');
                        if (qrContainer) {
                            new QRCode(qrContainer, {
                                text: "${window.location.origin + window.location.pathname + '?podId=' + activeDeliveryForReceipt.deliveryId}",
                                width: 80,
                                height: 80,
                            });
                            setTimeout(() => {
                                window.print();
                                window.close();
                            }, 500);
                        }
                    }
                <\/script>
            `);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
        }
        
        // --- Admin Panel ---
        async function openAdminPanel() {
            showLoader();
            try {
                const snapshot = await getDocs(collection(db, 'users'));
                const users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const listEl = document.getElementById('user-list-admin');
                listEl.innerHTML = '';
                if(users.length === 0) {
                    listEl.innerHTML = `<p class="text-gray-500 text-center p-4">No users found.</p>`;
                } else {
                    users.forEach(user => {
                        const canDelete = currentUser.uid !== user.id;
                        const deleteButton = canDelete ? `<button onclick="confirmUserDelete('${user.id}', '${user.displayName}')" class="btn btn-danger text-xs">Delete</button>` : '';
                        
                        const userEl = document.createElement('div');
                        userEl.className = "grid grid-cols-4 gap-4 items-center p-2 border-b";
                        userEl.innerHTML = `
                            <div>
                                <p class="font-medium">${user.displayName}</p>
                                <p class="text-xs text-gray-500">${user.email}</p>
                            </div>
                            <div>
                                <select data-uid="${user.id}" class="input-field status-select">
                                    <option value="active" ${user.status === 'active' ? 'selected' : ''}>Active</option>
                                    <option value="inactive" ${user.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                                </select>
                            </div>
                            <div class="text-sm text-gray-600 capitalize">${user.role}</div>
                            <div class="text-right">
                                ${deleteButton}
                            </div>
                        `;
                        listEl.appendChild(userEl);
                    });
                }
                openModal('admin-panel-modal');
            } catch (error) {
                console.error("Error opening admin panel:", error);
                showNotification("Could not load user data.", true);
            } finally {
                hideLoader();
            }
        }

        async function saveUserChanges() {
            showLoader();
            const batch = writeBatch(db);
            const statusSelects = document.querySelectorAll('.status-select');
            
            statusSelects.forEach(select => {
                const uid = select.dataset.uid;
                const newStatus = select.value;
                const docRef = doc(db, 'users', uid);
                batch.update(docRef, { status: newStatus });
            });

            try {
                await batch.commit();
                showNotification("User statuses updated successfully!", false);
                closeModal('admin-panel-modal');
                loadAdminData();
            } catch (error) {
                console.error("Error saving user statuses:", error);
                showNotification("Failed to update statuses.", true);
            } finally {
                hideLoader();
            }
        }
        
        window.confirmUserDelete = (userId, userName) => {
            const modal = document.getElementById('confirm-modal');
            modal.querySelector('#confirm-title').textContent = 'Confirm User Deletion';
            modal.querySelector('#confirm-message').innerHTML = `Are you sure you want to delete the user "${userName}"? This will only remove them from the application database, not from Firebase Authentication.`;
            openModal('confirm-modal', true);

            const okButton = modal.querySelector('#confirm-ok');
            const handleOkClick = () => {
                deleteUserFromFirestore(userId);
                closeModal('confirm-modal');
            };
            okButton.addEventListener('click', handleOkClick, { once: true });
        }
        
        window.confirmPodCancel = (deliveryId, jobFileNo) => {
            const modal = document.getElementById('confirm-modal');
            modal.querySelector('#confirm-title').textContent = 'Confirm POD Cancellation';
            modal.querySelector('#confirm-message').innerHTML = `Are you sure you want to cancel the POD for job file "${jobFileNo}"? This will delete the receipt and set the delivery back to "Pending".`;
            openModal('confirm-modal', true);

            const okButton = modal.querySelector('#confirm-ok');
            const handleOkClick = () => {
                cancelPod(deliveryId);
                closeModal('confirm-modal');
            };
            okButton.addEventListener('click', handleOkClick, { once: true });
        }

        async function cancelPod(deliveryId) {
            showLoader();
            try {
                const batch = writeBatch(db);

                const podRef = doc(db, 'pods', deliveryId);
                batch.delete(podRef);

                const deliveryRef = doc(db, 'deliveries', deliveryId);
                batch.update(deliveryRef, {
                    status: 'Pending',
                    podId: deleteField(),
                    completedAt: deleteField(),
                    receiverName: deleteField(),
                    receiverMobile: deleteField(),
                });
                
                await batch.commit();
                showNotification("POD cancelled and delivery status reset.", false);
            } catch (error) {
                console.error("Error cancelling POD:", error);
                showNotification("Failed to cancel POD.", true);
            } finally {
                hideLoader();
            }
        }

        async function deleteUserFromFirestore(userId) {
            showLoader();
            try {
                await deleteDoc(doc(db, 'users', userId));
                showNotification("User deleted successfully from Firestore.", false);
                openAdminPanel(); // Refresh the list
            } catch (error) {
                console.error("Error deleting user:", error);
                showNotification("Failed to delete user.", true);
            } finally {
                hideLoader();
            }
        }
        
        async function showPublicPodView(podId) {
            showLoader();
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'none';
            
            try {
                const podDocRef = doc(db, 'pods', podId);
                const podDoc = await getDoc(podDocRef);

                if (podDoc.exists()) {
                    activeDeliveryForReceipt = podDoc.data();
                    const view = document.getElementById('public-pod-view');
                    view.style.display = 'block';
                    view.innerHTML = `<div class="container mx-auto p-4 sm:p-6 lg:p-8"><div id="receipt-content" class="p-4 border rounded-md bg-white shadow-lg"></div></div>`;
                    generateReceipt();
                } else {
                    document.body.innerHTML = `<div class="p-4 text-center text-red-700 bg-red-100">POD with ID "${podId}" not found.</div>`;
                }

            } catch(e) {
                console.error("Error fetching public POD:", e);
                document.body.innerHTML = `<div class="p-4 text-center text-red-700 bg-red-100">Error loading POD.</div>`;
            } finally {
                hideLoader();
                document.body.classList.remove('loading');
            }
        }

        // --- Driver Performance Dashboard ---
        async function openDriverPerformanceDashboard() {
            if (currentUser.role !== 'admin' && currentUser.role !== 'staff') {
                showNotification("Access denied.", true);
                return;
            }

            showLoader();
            try {
                // Fetch feedback on demand
                const feedbackQuery = query(collection(db, 'feedback'));
                const feedbackSnapshot = await getDocs(feedbackQuery);
                feedbackCache = feedbackSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const drivers = allUsersCache.filter(u => u.role === 'driver');
                const driverStats = drivers.map(driver => {
                    const completed = deliveriesCache.filter(d => d.driverUid === driver.id && d.status === 'Delivered').length;
                    const pending = deliveriesCache.filter(d => d.driverUid === driver.id && d.status !== 'Delivered').length;
                    const skipped = deliveriesCache.filter(d => d.driverUid === driver.id && d.feedbackStatus === 'skipped').length;
                    
                    const driverFeedback = feedbackCache.filter(f => f.driverUid === driver.id);
                    const totalRatings = driverFeedback.length;
                    const averageRating = totalRatings > 0 ? (driverFeedback.reduce((sum, f) => sum + f.rating, 0) / totalRatings) : 0;

                    return { ...driver, completed, pending, averageRating, totalRatings, skipped };
                });

                driverStats.sort((a, b) => b.completed - a.completed); // Sort by most completed

                const statsListEl = document.getElementById('driver-stats-list');
                statsListEl.innerHTML = '';

                if (driverStats.length > 0) {
                    driverStats.forEach(stat => {
                        const starRating = '★'.repeat(Math.round(stat.averageRating)) + '☆'.repeat(5 - Math.round(stat.averageRating));
                        const statCard = document.createElement('div');
                        statCard.className = 'p-4 border rounded-lg bg-white flex justify-between items-center';
                        statCard.innerHTML = `
                            <div>
                                <p class="font-bold text-lg">${stat.displayName}</p>
                                <p class="text-sm text-gray-600">${stat.email}</p>
                            </div>
                            <div class="flex items-center gap-4 text-center">
                                <div title="Average Rating: ${stat.averageRating.toFixed(2)} (${stat.totalRatings} ratings)">
                                    <p class="text-2xl font-bold text-yellow-500">${starRating}</p>
                                    <p class="text-xs text-gray-500">Avg. Rating</p>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold text-green-600">${stat.completed}</p>
                                    <p class="text-xs text-gray-500">Completed</p>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold text-yellow-600">${stat.pending}</p>
                                    <p class="text-xs text-gray-500">Pending</p>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold text-red-500">${stat.skipped}</p>
                                    <p class="text-xs text-gray-500">Skipped</p>
                                </div>
                            </div>
                            <div>
                                <button onclick="showDriverFeedback('${stat.id}')" class="btn btn-primary btn-xs text-xs mr-2">View Feedback</button>
                                <button onclick="showDriverDeliveries('${stat.id}')" class="btn btn-secondary btn-xs text-xs">View Deliveries</button>
                            </div>
                        `;
                        statsListEl.appendChild(statCard);
                    });
                } else {
                    statsListEl.innerHTML = '<p class="text-center text-gray-500">No active drivers found.</p>';
                }

                // Chart.js rendering
                const chartCanvas = document.getElementById('driver-chart');
                if (driverChartInstance) {
                    driverChartInstance.destroy();
                }
                
                const chartLabels = driverStats.map(d => d.displayName);
                const chartData = driverStats.map(d => d.completed);

                driverChartInstance = new Chart(chartCanvas, {
                    type: 'bar',
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            label: 'Completed Deliveries',
                            data: chartData,
                            backgroundColor: 'rgba(79, 184, 175, 0.6)',
                            borderColor: 'rgba(79, 184, 175, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Completed Deliveries per Driver'
                            }
                        }
                    }
                });

                openModal('driver-performance-modal');
            } catch (error) {
                console.error("Error opening driver dashboard:", error);
                showNotification("Could not load driver performance data.", true);
            } finally {
                hideLoader();
            }
        }

        function showDriverDeliveries(driverId) {
            const driver = allUsersCache.find(u => u.id === driverId);
            if (!driver) return;
            const driverDeliveries = deliveriesCache.filter(d => d.driverUid === driverId);
            
            const modalTitle = document.getElementById('user-jobs-modal-title');
            const list = document.getElementById('user-jobs-list');

            modalTitle.textContent = `Deliveries for ${driver.displayName}`;
            
            if (driverDeliveries.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center p-4">This driver has no assigned deliveries.</p>';
            } else {
                list.innerHTML = '';
                driverDeliveries.forEach(delivery => {
                    const card = createDeliveryCard(delivery); 
                    list.appendChild(card);
                });
            }
            openModal('user-jobs-modal', true); 
        }

        // --- Public Feedback Logic ---
        async function showPublicFeedbackView(feedbackId) {
            document.querySelectorAll('body > div').forEach(el => el.style.display = 'none');
            document.getElementById('public-feedback-view').style.display = 'flex';
            document.body.classList.remove('loading');
            showLoader();
            try {
                // First, check if feedback already exists
                const feedbackRef = doc(db, 'feedback', feedbackId);
                const feedbackSnap = await getDoc(feedbackRef);

                if (feedbackSnap.exists()) {
                    document.getElementById('feedback-form-container').style.display = 'none';
                    document.getElementById('feedback-thanks-message').style.display = 'block';
                    document.getElementById('feedback-thanks-message').innerHTML += '<p class="text-sm mt-2">You have already rated this delivery.</p>';
                    return; 
                }

                const deliveryRef = doc(db, 'deliveries', feedbackId);
                const deliverySnap = await getDoc(deliveryRef);
                if (deliverySnap.exists()) {
                    const deliveryData = deliverySnap.data();
                    document.getElementById('feedback-delivery-id').value = feedbackId;
                    document.getElementById('feedback-job-no').textContent = deliveryData.jobFileData.jfn;
                    document.getElementById('feedback-driver-name').textContent = deliveryData.driverName;
                } else {
                    throw new Error('Delivery not found.');
                }
            } catch (error) {
                // DEVELOPER NOTE: This error is often caused by Firestore security rules.
                // For this public feedback page to work, unauthenticated users need read access
                // to individual documents in the 'deliveries' and 'feedback' collections.
                // Your rules should look something like this:
                // match /deliveries/{deliveryId} { allow get: if true; ... }
                // match /feedback/{feedbackId} { allow get: if true; ... }
                document.getElementById('feedback-form-container').innerHTML = '<p class="text-red-500 font-semibold">COULD NOT LOAD DELIVERY DETAILS.</p><p class="text-xs text-gray-500 mt-2">This may be due to a network issue or a permissions problem. Please try again later.</p>';
                console.error("Error loading for feedback:", error);
            } finally {
                hideLoader();
            }
        }
        
        // --- Feedback Helpers to get Device and IP ---
        function getDeviceDetails() {
            return navigator.userAgent || 'Unknown';
        }

        async function getIPAddress() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                if (!response.ok) return 'Unavailable';
                const data = await response.json();
                return data.ip || 'Unavailable';
            } catch (error) {
                console.error("Could not fetch IP address:", error);
                return 'Unavailable';
            }
        }

        function parseDeviceInfo(ua) {
            if (!ua) return 'N/A';

            // Specific models for better readability
            if (ua.includes('SM-S918')) return 'Samsung Galaxy S23 Ultra';
            if (ua.includes('SM-S908')) return 'Samsung Galaxy S22 Ultra';
            if (ua.includes('SM-G998')) return 'Samsung Galaxy S21 Ultra';

            // Generic Apple devices
            if (ua.includes('iPhone')) return 'iPhone';
            if (ua.includes('iPad')) return 'iPad';

            // Generic Google Pixel
            const pixelMatch = ua.match(/Pixel [^\s;)]+/);
            if (pixelMatch) return `Google ${pixelMatch[0]}`;

            // Try to extract model from generic Android UA string
            if (ua.includes('Android')) {
                const androidMatch = ua.match(/\(([^)]+)\)/);
                if (androidMatch && androidMatch[1]) {
                    const parts = androidMatch[1].split(';').map(p => p.trim());
                    // The model is often the last part before the 'Build/' string
                    const modelPart = parts[parts.length - 1];
                    if (modelPart && modelPart.includes('Build/')) {
                        return modelPart.split(' Build/')[0];
                    }
                    return modelPart; // Return whatever was found
                }
                return 'Android Device';
            }

            // Desktop Operating Systems
            if (ua.includes('Windows NT')) return 'Windows PC';
            if (ua.includes('Macintosh')) return 'Mac';
            if (ua.includes('Linux') && !ua.includes('Android')) return 'Linux PC';

            return 'Unknown Device';
        }


        async function handleFeedbackSubmit(event) {
            event.preventDefault();
            const deliveryId = document.getElementById('feedback-delivery-id').value;
            const rating = document.querySelector('input[name="rating"]:checked');
            const comment = document.getElementById('feedback-comment').value.trim();

            if (!rating) {
                showNotification("Please select a star rating.", true);
                return;
            }
            
            showLoader();
            try {
                const deliveryRef = doc(db, 'deliveries', deliveryId);
                const deliverySnap = await getDoc(deliveryRef);

                if(!deliverySnap.exists()) throw new Error("Original delivery not found.");
                const deliveryData = deliverySnap.data();

                // Get device info and IP
                const deviceInfo = getDeviceDetails();
                const ipAddress = await getIPAddress();

                const feedbackData = {
                    deliveryId: deliveryId,
                    driverUid: deliveryData.driverUid,
                    driverName: deliveryData.driverName,
                    rating: parseInt(rating.value, 10),
                    comment: comment,
                    createdAt: serverTimestamp(),
                    deviceInfo: deviceInfo,
                    ipAddress: ipAddress
                };

                await setDoc(doc(db, 'feedback', deliveryId), feedbackData);
                await updateDoc(deliveryRef, { feedbackStatus: 'rated' });

                document.getElementById('feedback-form-container').style.display = 'none';
                document.getElementById('feedback-thanks-message').style.display = 'block';

            } catch (error) {
                console.error("Error submitting feedback:", error);
                showNotification("Could not submit feedback. Please try again.", true);
            } finally {
                hideLoader();
            }
        }
        
        async function showDriverFeedback(driverId) {
            const driver = allUsersCache.find(u => u.id === driverId);
            if (!driver) return;
            
            const driverFeedback = feedbackCache.filter(f => f.driverUid === driverId)
                .sort((a,b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));

            const modalTitle = document.getElementById('feedback-modal-title');
            const list = document.getElementById('feedback-list');
            modalTitle.textContent = `Feedback for ${driver.displayName}`;
            
            if (driverFeedback.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center p-4">This driver has not received any feedback yet.</p>';
            } else {
                list.innerHTML = driverFeedback.map(feedback => {
                    const delivery = deliveriesCache.find(d => d.id === feedback.deliveryId);
                    const jobFileNo = delivery?.jobFileData?.jfn || 'N/A';
                    
                    let adminInfo = '';
                    if (currentUser.role === 'admin') {
                        const deviceName = parseDeviceInfo(feedback.deviceInfo);
                        adminInfo = `
                        <div class="mt-2 pt-2 border-t text-xs text-gray-500 space-y-1">
                            <p><strong>Device:</strong> ${deviceName}</p>
                            <p><strong>IP Address:</strong> ${feedback.ipAddress || 'N/A'}</p>
                        </div>
                        `;
                    }

                    return `
                    <div class="p-3 border rounded-lg bg-gray-50">
                        <div class="flex justify-between items-center">
                            <div>
                               <p class="text-xl text-yellow-500">${'★'.repeat(feedback.rating)}${'☆'.repeat(5 - feedback.rating)}</p>
                               <p class="text-xs text-gray-500 mt-1">For Job: <strong>${jobFileNo}</strong></p>
                            </div>
                            <p class="text-xs text-gray-400">${feedback.createdAt?.toDate().toLocaleString()}</p>
                        </div>
                        <p class="mt-2 text-gray-700">${feedback.comment || '<i>No comment left.</i>'}</p>
                        ${adminInfo}
                    </div>
                `}).join('');
            }
            
            openModal('view-feedback-modal', true);
        }

        async function showMyFeedback() {
            showLoader();
            try {
                const q = query(collection(db, "feedback"), where("driverUid", "==", currentUser.uid));
                const feedbackSnapshot = await getDocs(q);
                const myFeedback = feedbackSnapshot.docs.map(doc => doc.data())
                    .sort((a,b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));

                const modalTitle = document.getElementById('feedback-modal-title');
                const list = document.getElementById('feedback-list');
                modalTitle.textContent = `My Feedback & Ratings`;
                
                if (myFeedback.length === 0) {
                    list.innerHTML = '<p class="text-gray-500 text-center p-4">You have not received any feedback yet.</p>';
                } else {
                    list.innerHTML = myFeedback.map(feedback => {
                        const delivery = deliveriesCache.find(d => d.id === feedback.deliveryId);
                        const jobFileNo = delivery?.jobFileData?.jfn || 'N/A';
                        return `
                        <div class="p-3 border rounded-lg bg-gray-50">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-xl text-yellow-500">${'★'.repeat(feedback.rating)}${'☆'.repeat(5 - feedback.rating)}</p>
                                    <p class="text-xs text-gray-500 mt-1">For Job: <strong>${jobFileNo}</strong></p>
                                </div>
                                <p class="text-xs text-gray-400">${feedback.createdAt?.toDate().toLocaleString()}</p>
                            </div>
                            <p class="mt-2 text-gray-700">${feedback.comment || '<i>No comment left.</i>'}</p>
                        </div>
                    `}).join('');
                }
                openModal('view-feedback-modal');

            } catch(error) {
                console.error("Error fetching driver feedback:", error);
                showNotification("Could not load your feedback.", true);
            } finally {
                hideLoader();
            }
        }
        
        async function shareReceipt() {
            const receiptElement = document.getElementById('receipt-content');
            const jobData = activeDeliveryForReceipt.jobFileData;
            const publicUrl = `${window.location.origin}${window.location.pathname}?podId=${activeDeliveryForReceipt.deliveryId}`;

            try {
                const canvas = await html2canvas(receiptElement, { scale: 2 });
                canvas.toBlob(async (blob) => {
                    const file = new File([blob], `Receipt-${jobData.jfn}.png`, { type: 'image/png' });
                    const shareData = {
                        title: `Delivery Receipt for ${jobData.jfn}`,
                        text: `View the delivery receipt for job file ${jobData.jfn}.`,
                        url: publicUrl,
                        files: [file]
                    };

                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        await navigator.share(shareData);
                    } else if (navigator.canShare && navigator.canShare({url: publicUrl})) {
                        await navigator.share({
                            title: `Delivery Receipt for ${jobData.jfn}`,
                            text: `View the delivery receipt for job file ${jobData.jfn}.`,
                            url: publicUrl
                        });
                    } else {
                        showNotification("Sharing is not supported on this browser.", true);
                    }
                }, 'image/png');

            } catch (error) {
                console.error('Error sharing receipt:', error);
                showNotification('Could not share receipt.', true);
            }
        }

        function copyReceiptLink() {
            const publicUrl = `${window.location.origin}${window.location.pathname}?podId=${activeDeliveryForReceipt.deliveryId}`;
            navigator.clipboard.writeText(publicUrl).then(() => {
                showNotification("Link copied to clipboard!");
            }, () => {
                showNotification("Could not copy link.", true);
            });
        }

        async function displayDriverPerformanceSummary(driverId, tasks) {
            const summaryEl = document.getElementById('driver-performance-summary');
            if (!summaryEl) return;

            try {
                const feedbackQuery = query(collection(db, "feedback"), where("driverUid", "==", driverId));
                const feedbackSnapshot = await getDocs(feedbackQuery);
                const driverFeedback = feedbackSnapshot.docs.map(doc => doc.data());

                const completed = tasks.filter(d => d.status === 'Delivered').length;
                const pending = tasks.length - completed;
                
                const totalRatings = driverFeedback.length;
                const averageRating = totalRatings > 0 ? (driverFeedback.reduce((sum, f) => sum + f.rating, 0) / totalRatings) : 0;
                
                const starRating = '★'.repeat(Math.round(averageRating)) + '☆'.repeat(5 - Math.round(averageRating));

                summaryEl.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div class="bg-yellow-100 p-4 rounded-lg" title="Average Rating: ${averageRating.toFixed(2)} (${totalRatings} ratings)">
                            <p class="text-sm text-yellow-800">My Average Rating</p>
                            <p class="text-3xl font-bold text-yellow-500 mt-1">${starRating}</p>
                        </div>
                        <div class="bg-green-100 p-4 rounded-lg">
                            <p class="text-sm text-green-800">Completed Deliveries</p>
                            <p class="text-3xl font-bold text-green-900">${completed}</p>
                        </div>
                        <div class="bg-blue-100 p-4 rounded-lg">
                            <p class="text-sm text-blue-800">Pending Deliveries</p>
                            <p class="text-3xl font-bold text-blue-900">${pending}</p>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error("Error displaying driver performance summary:", error);
                summaryEl.innerHTML = '<p class="text-red-500 text-center">Could not load performance summary.</p>';
            }
        }


        // --- General Functions ---
        function showLoader() { document.getElementById('loader-overlay').classList.add('visible'); }
        function hideLoader() { document.getElementById('loader-overlay').classList.remove('visible'); }
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.backgroundColor = isError ? '#dc2626' : '#1e293b';
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        window.openModal = (id, keepParent = false) => {
            const modal = document.getElementById(id);
            if (keepParent) {
                const highestZ = Array.from(document.querySelectorAll('.overlay.visible'))
                    .reduce((max, el) => Math.max(max, parseInt(window.getComputedStyle(el).zIndex || 1000)), 1000);
                modal.style.zIndex = highestZ + 10;
            }
            modal.classList.add('visible');
        };
        window.closeModal = (id) => document.getElementById(id).classList.remove('visible');

        function handleLogout() {
            signOut(auth).catch((error) => {
                console.error("Logout failed:", error);
                showNotification("Logout failed. Please try again.", true);
            });
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeAppLogic();
            
            document.getElementById('auth-btn').addEventListener('click', handleLogin);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('driver-signup-link').addEventListener('click', (e) => { e.preventDefault(); openModal('signup-modal'); });
            document.getElementById('forgot-password-link').addEventListener('click', (e) => { e.preventDefault(); openModal('forgot-password-modal'); });
            document.getElementById('signup-form').addEventListener('submit', handleSignup);
            document.getElementById('forgot-password-form').addEventListener('submit', handleForgotPassword);

            document.getElementById('job-file-search').addEventListener('input', handleJobFileSearch);
            document.getElementById('job-file-suggestions').addEventListener('click', selectJobFile);
            document.getElementById('delivery-form').addEventListener('submit', handleAssignDelivery);
            
            document.getElementById('pending-search').addEventListener('input', renderAllDeliveryViews);
            document.getElementById('completed-search').addEventListener('input', renderAllDeliveryViews);

            document.getElementById('completion-form').addEventListener('submit', handleCompleteDelivery);
            document.getElementById('clear-completion-signature-btn').addEventListener('click', () => completionSignaturePad.clear());
            document.getElementById('get-location-btn').addEventListener('click', handleGetLocation);
            
            document.getElementById('pdf-receipt-btn').addEventListener('click', downloadReceiptAsPDF);
            document.getElementById('print-receipt-btn').addEventListener('click', printReceipt);
            document.getElementById('admin-panel-btn').addEventListener('click', openAdminPanel);
            document.getElementById('driver-dashboard-btn').addEventListener('click', openDriverPerformanceDashboard);
            document.getElementById('feedback-form').addEventListener('submit', handleFeedbackSubmit);
            document.getElementById('my-feedback-btn').addEventListener('click', showMyFeedback);
            document.getElementById('share-btn').addEventListener('click', shareReceipt);
            document.getElementById('copy-link-btn').addEventListener('click', copyReceiptLink);


            const confirmCancelBtn = document.getElementById('confirm-cancel');
            confirmCancelBtn.addEventListener('click', () => {
                const okButton = document.getElementById('confirm-ok');
                const newOkButton = okButton.cloneNode(true);
                okButton.parentNode.replaceChild(newOkButton, okButton);
                closeModal('confirm-modal');
            });

        });
        
        // Make functions globally accessible for inline onclick handlers
        window.saveUserChanges = saveUserChanges;
        window.openReceiptModal = openReceiptModal;
        window.confirmUserDelete = confirmUserDelete;
        window.confirmPodCancel = confirmPodCancel;
        window.showDriverDeliveries = showDriverDeliveries;
        window.showDriverFeedback = showDriverFeedback;

    </script>
</body>
</html>

