<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POD Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --theme-color: #4f46e5; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        body.loading > * {
            visibility: hidden;
        }
        .input-field {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: var(--theme-color);
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3);
        }
        .input-field:disabled {
            background-color: #f9fafb;
            cursor: not-allowed;
            color: #6b7280;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-primary { background-color: var(--theme-color); color: white; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-secondary:hover { background-color: #4b5563; }
        .btn-success { background-color: #16a34a; color: white; }
        .btn-success:hover { background-color: #15803d; }
        .btn-danger { background-color: #dc2626; color: white; }
        .btn-danger:hover { background-color: #b91c1c; }


        .overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.6); display: flex;
            align-items: center; justify-content: center; z-index: 1000;
            opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
            padding: 1rem;
        }
        .overlay.visible {
            opacity: 1; visibility: visible;
        }
        .modal-content {
            background: white; padding: 1.5rem; border-radius: 0.5rem;
            width: 100%; max-width: 600px;
            max-height: 90vh; overflow-y: auto;
            transform: scale(0.95); transition: transform 0.3s;
        }
        .overlay.visible .modal-content {
            transform: scale(1);
        }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--theme-color);
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #notification {
            position: fixed; bottom: 20px; left: 50%;
            transform: translateX(-50%);
            background-color: #2d3748; color: white;
            padding: 1rem 1.5rem; border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translate(-50%, 100px); opacity: 0;
            transition: transform 0.5s, opacity 0.5s;
            z-index: 2000; text-align: center;
        }
        #notification.show {
            transform: translate(-50%, 0); opacity: 1;
        }

        /* Search suggestions */
        .suggestions-container {
            position: absolute;
            width: 100%;
            background-color: white;
            border: 1px solid #d1d5db;
            border-top: none;
            border-radius: 0 0 0.375rem 0.375rem;
            max-height: 200px;
            overflow-y: auto;
            z-index: 50;
        }
        .suggestion-item {
            padding: 0.75rem;
            cursor: pointer;
        }
        .suggestion-item:hover {
            background-color: #f3f4f6;
        }
        
        .signature-pad-canvas {
            border: 2px dashed #d1d5db;
            border-radius: 0.375rem;
        }

        #driver-simulation-section {
            max-width: 375px;
            margin-left: auto;
            margin-right: auto;
            border: 8px solid black;
            border-radius: 2rem;
            padding: 1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-100 loading">

    <!-- Login Screen -->
     <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
             <div>
                <div class="text-center text-4xl font-extrabold" style="color: #0E639C;">Q'go<span style="color: #4FB8AF;">Cargo</span></div>
                <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">Delivery System Login</h2>
            </div>
            <div class="mt-8 space-y-6 bg-white p-8 rounded-lg shadow-md">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <label for="email-address" class="sr-only">Email address</label>
                        <input id="email-address" name="email" type="email" autocomplete="email" class="input-field rounded-t-md" placeholder="Email address">
                    </div>
                    <div>
                        <label for="password" class="sr-only">Password</label>
                        <input id="password" name="password" type="password" autocomplete="current-password" class="input-field rounded-b-md" placeholder="Password">
                    </div>
                </div>
                <div>
                    <button id="auth-btn" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Sign in
                    </button>
                </div>
                 <div class="flex items-center justify-between text-sm mt-4">
                    <a href="#" id="forgot-password-link" class="font-medium text-indigo-600 hover:text-indigo-500">
                        Forgot your password?
                    </a>
                     <a href="#" id="create-driver-account-link" class="font-medium text-green-600 hover:text-green-500">
                        Create a Driver Account
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Public POD View -->
    <div id="public-pod-view" class="hidden"></div>


    <!-- Main Application Container (Hidden by default) -->
    <div id="app-container" class="hidden container mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header -->
        <header class="flex flex-col sm:flex-row justify-between items-center mb-6 pb-4 border-b">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Delivery System</h1>
                <p id="header-subtitle" class="text-gray-500">Assign, track, and manage all job file deliveries.</p>
            </div>
            <div class="text-sm mt-4 sm:mt-0">
                <p>Welcome, <span id="user-display-name" class="font-bold"></span> (<span id="user-role" class="capitalize"></span>)</p>
                <div class="flex items-center justify-end gap-4 mt-2">
                    <button id="admin-panel-btn" class="btn btn-primary text-xs hidden">Admin Panel</button>
                    <button id="logout-btn" class="btn btn-secondary text-xs">Logout</button>
                </div>
            </div>
        </header>

        <!-- Admin / Staff View -->
        <div id="admin-staff-view" class="hidden space-y-8">
                <!-- 1. Dashboard / Overview -->
                <section id="dashboard-section" class="space-y-6">
                    <!-- Stat Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white p-4 rounded-lg shadow flex items-center gap-4">
                            <div class="bg-yellow-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                            <div><p class="text-sm text-gray-500">Pending Deliveries</p><p id="stat-pending" class="text-2xl font-bold">0</p></div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow flex items-center gap-4">
                            <div class="bg-green-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                            <div><p class="text-sm text-gray-500">Completed Deliveries</p><p id="stat-completed" class="text-2xl font-bold">0</p></div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow flex items-center gap-4">
                            <div class="bg-indigo-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10l2 2h8a1 1 0 001-1z" /></svg></div>
                            <div><p class="text-sm text-gray-500">Total Deliveries</p><p id="stat-total" class="text-2xl font-bold">0</p></div>
                        </div>
                    </div>
                    <!-- Recent Activity -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold mb-2">Recent Activity</h3>
                        <div id="recent-activity-list" class="space-y-3">
                            <p class="text-gray-500">No recent activities.</p>
                        </div>
                    </div>
                </section>
                
                <!-- 2. Assign New Delivery -->
                <section class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Assign New Delivery</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Job File Selection -->
                        <div class="space-y-4">
                            <h3 class="font-semibold text-lg">1. Select Job File</h3>
                            <div class="relative">
                                <label for="job-file-search" class="block text-sm font-medium text-gray-700">Search by Job No, Shipper, or Consignee</label>
                                <input type="text" id="job-file-search" class="input-field mt-1" placeholder="Start typing to search...">
                                <div id="job-file-suggestions" class="suggestions-container hidden"></div>
                            </div>
                        </div>
                        <!-- Delivery Details Form -->
                        <form id="delivery-form" class="space-y-4" novalidate>
                            <h3 class="font-semibold text-lg">2. Enter Delivery Details</h3>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Job File No.</label>
                                <input type="text" id="form-job-file-no" class="input-field mt-1" disabled>
                            </div>
                             <div>
                                <label class="block text-sm font-medium text-gray-700">Shipper / Consignee</label>
                                <input type="text" id="form-job-shipper-consignee" class="input-field mt-1" disabled>
                            </div>
                            <div>
                                <label for="delivery-location" class="block text-sm font-medium text-gray-700">Delivery Location</label>
                                <textarea id="delivery-location" rows="2" class="input-field mt-1" placeholder="Enter the full delivery address"></textarea>
                            </div>
                            <div>
                                <label for="additional-notes" class="block text-sm font-medium text-gray-700">Additional Notes</label>
                                <textarea id="additional-notes" rows="2" class="input-field mt-1" placeholder="e.g., Contact person, specific instructions"></textarea>
                            </div>
                            <div>
                                <label for="driver-select" class="block text-sm font-medium text-gray-700">Assign Driver</label>
                                <select id="driver-select" class="input-field mt-1">
                                    <option value="">-- Select a Driver --</option>
                                    <!-- Drivers populated by JS -->
                                </select>
                            </div>
                            <div class="text-right">
                                 <button type="submit" class="btn btn-primary">Assign Delivery</button>
                            </div>
                        </form>
                    </div>
                </section>

                <!-- 3. Delivery Lists -->
                <section class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Pending Deliveries -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-semibold mb-4">Pending Deliveries</h2>
                        <div id="pending-deliveries-list" class="space-y-3 max-h-96 overflow-y-auto">
                            <p class="text-gray-500">No pending deliveries.</p>
                        </div>
                    </div>
                    <!-- Completed Deliveries -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-semibold mb-4">Completed Deliveries</h2>
                        <div id="completed-deliveries-list" class="space-y-3 max-h-96 overflow-y-auto">
                             <p class="text-gray-500">No completed deliveries yet.</p>
                        </div>
                    </div>
                </section>

                 <!-- 4. Driver View Simulation (ADMIN ONLY) -->
                 <section id="driver-simulation-section" class="bg-white hidden">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                         <h2 class="text-2xl font-semibold">User View Simulation</h2>
                         <div class="flex items-center gap-2 mt-2 sm:mt-0">
                            <label for="user-simulation-select" class="text-sm font-medium">View tasks for:</label>
                            <select id="user-simulation-select" class="input-field w-auto">
                                <option value="">-- Select User --</option>
                            </select>
                         </div>
                    </div>
                    <div id="user-simulation-list" class="space-y-4 max-h-[40rem] overflow-y-auto p-2 bg-gray-50 rounded">
                        <p class="text-center text-gray-500 p-4">Select a user to see their assigned tasks.</p>
                    </div>
                </section>
        </div>

        <!-- Driver View -->
        <div id="driver-view" class="hidden">
            <section class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4">My Assigned Deliveries</h2>
                <div id="driver-tasks-list" class="space-y-4">
                    <p class="text-gray-500">You have no assigned deliveries.</p>
                </div>
            </section>
        </div>
    </div>

    <!-- Modals -->
    <div id="loader-overlay" class="overlay"><div class="loader"></div></div>
    <div id="notification"></div>
    
    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="overlay">
        <div class="modal-content max-w-sm">
            <h3 class="text-lg font-bold mb-4" id="confirm-title">Confirm Action</h3>
            <div id="confirm-message" class="mb-4 text-sm">Are you sure?</div>
            <div class="text-right mt-6 space-x-2">
                <button id="confirm-cancel" class="btn btn-secondary">Cancel</button>
                <button id="confirm-ok" class="btn btn-danger">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgot-password-modal" class="overlay">
        <div class="modal-content max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Reset Password</h3>
                <button onclick="closeModal('forgot-password-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <p class="mb-4 text-gray-600">Enter your email and we'll send a password reset link.</p>
            <form id="forgot-password-form" novalidate>
                <input id="reset-email" type="email" class="input-field" placeholder="Email address">
                <div class="text-right mt-4">
                    <button type="submit" class="btn btn-primary">Send Reset Link</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Driver Sign-Up Modal -->
    <div id="signup-modal" class="overlay">
        <div class="modal-content max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Create Driver Account</h3>
                <button onclick="closeModal('signup-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <form id="signup-form" class="space-y-4" novalidate>
                <div>
                    <label for="signup-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                    <input type="text" id="signup-name" class="input-field mt-1">
                </div>
                <div>
                    <label for="signup-email" class="block text-sm font-medium text-gray-700">Email Address</label>
                    <input type="email" id="signup-email" class="input-field mt-1">
                </div>
                <div>
                    <label for="signup-password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="signup-password" class="input-field mt-1">
                </div>
                <div class="text-right pt-4">
                    <button type="submit" class="btn btn-primary w-full">Create Account</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Admin Panel Modal -->
    <div id="admin-panel-modal" class="overlay">
        <div class="modal-content max-w-3xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Admin Panel</h3>
                <button onclick="closeModal('admin-panel-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div class="space-y-4">
                <h4 class="text-lg font-semibold">User Management</h4>
                <div id="user-list-admin" class="space-y-2 max-h-[60vh] overflow-y-auto">
                    <!-- User list will be populated here -->
                </div>
                <div class="text-right">
                    <button onclick="saveUserChanges()" class="btn btn-success">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delivery Completion Modal (for Driver) -->
    <div id="delivery-completion-modal" class="overlay">
        <div class="modal-content max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Complete Delivery</h3>
                <button onclick="closeModal('delivery-completion-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <form id="completion-form" class="space-y-4" novalidate>
                <input type="hidden" id="delivery-id-input">
                <div class="p-4 bg-gray-50 rounded-md">
                    <p><strong>Job File:</strong> <span id="modal-job-no"></span></p>
                    <p><strong>Location:</strong> <span id="modal-location"></span></p>
                </div>
                <div>
                    <label for="receiver-name" class="block text-sm font-medium text-gray-700">Receiver's Name</label>
                    <input type="text" id="receiver-name" class="input-field mt-1">
                </div>
                <div>
                    <label for="receiver-mobile" class="block text-sm font-medium text-gray-700">Receiver's Mobile Number</label>
                    <input type="tel" id="receiver-mobile" class="input-field mt-1">
                </div>
                 
                <div>
                    <label class="block text-sm font-medium text-gray-700">Receiver's Signature</label>
                    <div class="relative w-full h-48 mt-1">
                        <canvas id="completion-signature-pad" class="signature-pad-canvas absolute top-0 left-0 w-full h-full"></canvas>
                    </div>
                    <div class="text-right mt-1">
                         <button type="button" id="clear-completion-signature-btn" class="btn btn-secondary text-xs">Clear</button>
                    </div>
                </div>

                 <div>
                    <button type="button" id="get-location-btn" class="btn btn-secondary text-sm w-full">Get Current Location</button>
                    <p id="location-status" class="text-xs text-gray-500 mt-1 text-center"></p>
                </div>
                <div class="flex justify-end items-center gap-4 pt-4">
                    <button type="submit" class="btn btn-success">Mark as Delivered</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Receipt Modal (For Viewing Receipts) -->
    <div id="receipt-modal" class="overlay">
        <div class="modal-content max-w-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 id="receipt-modal-title" class="text-2xl font-bold">View Receipt</h3>
                <button onclick="closeModal('receipt-modal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            
             <div id="receipt-view">
                 <div id="receipt-content" class="p-4 border rounded-md">
                    <!-- Receipt content will be generated here -->
                 </div>
                 <div class="text-right mt-4 flex justify-end gap-2">
                    <button id="pdf-receipt-btn" class="btn btn-secondary">PDF</button>
                    <button id="print-receipt-btn" class="btn btn-primary">Print</button>
                 </div>
            </div>
        </div>
    </div>


    <!-- Firebase SDK and App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, serverTimestamp, getDocs, writeBatch, addDoc, updateDoc, deleteDoc, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Global variables ---
        let db, auth;
        let currentUser = null;
        let jobFilesCache = [];
        let allUsersCache = [];
        let deliveriesCache = [];
        let selectedJobFile = null;
        let currentGeolocation = null;
        let deliveriesUnsubscribe = () => {};
        let driverTasksUnsubscribe = () => {};
        let completionSignaturePad;
        let activeDeliveryForReceipt = null;
        let activeDeliveryForCompletion = null;


        // --- Firebase Configuration (Same as your main file) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAAulR2nJQm-4QtNyEqKTnnDPw-iKW92Mc",
            authDomain: "my-job-file-system.firebaseapp.com",
            projectId: "my-job-file-system",
            storageBucket: "my-job-file-system.appspot.com",
            messagingSenderId: "145307873304",
            appId: "1:145307873304:web:d661ea6ec118801b4a136d",
            measurementId: "G-8EHX5K7YHL"
        };

        // --- App Initialization ---
        async function initializeAppLogic() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                const urlParams = new URLSearchParams(window.location.search);
                const podId = urlParams.get('podId');

                if (podId) {
                    showPublicPodView(podId);
                } else {
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            const userDocRef = doc(db, 'users', user.uid);
                            const userDoc = await getDoc(userDocRef);

                            if (userDoc.exists() && userDoc.data().status === 'active') {
                                currentUser = { uid: user.uid, ...userDoc.data() };
                                showApp();
                            } else {
                                if (userDoc.exists()) {
                                    showNotification("Your account is pending admin approval.", true);
                                }
                                currentUser = null;
                                await signOut(auth);
                                showLogin();
                            }
                        } else {
                            currentUser = null;
                            showLogin();
                        }
                        document.body.classList.remove('loading');
                    });
                }
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showNotification("Could not connect to the database.", true);
                document.body.classList.remove('loading');
            }
        }

        // --- Authentication Logic ---
        async function handleLogin() {
            const email = document.getElementById('email-address').value;
            const password = document.getElementById('password').value;
            if (!email || !password) {
                showNotification("Please enter both email and password.", true);
                return;
            }
            showLoader();
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login failed:", error);
                let message = "Login failed. Please check your credentials.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    message = "Incorrect email or password.";
                }
                showNotification(message, true);
            } finally {
                hideLoader();
            }
        }
        
         async function handleForgotPassword(e) {
            e.preventDefault();
            const email = document.getElementById('reset-email').value.trim();
            if (!email) {
                showNotification("Please enter your email address.", true);
                return;
            }
            showLoader();
            try {
                await sendPasswordResetEmail(auth, email);
                hideLoader();
                closeModal('forgot-password-modal');
                showNotification("Password reset link sent! Check your email inbox.", false);
            } catch (error) {
                hideLoader();
                console.error("Password reset error:", error);
                showNotification("Could not send reset link. Please try again.", true);
            }
        }
        
        async function handleDriverSignUp(e) {
            e.preventDefault();
            const name = document.getElementById('signup-name').value.trim();
            const email = document.getElementById('signup-email').value.trim();
            const password = document.getElementById('signup-password').value;

            if (!name || !email || !password) {
                showNotification("Please fill in all fields.", true);
                return;
            }
            if (password.length < 6) {
                showNotification("Password should be at least 6 characters.", true);
                return;
            }

            showLoader();
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                const userDocRef = doc(db, 'users', user.uid);
                const newUser = {
                    displayName: name,
                    email: email,
                    role: 'driver',
                    status: 'inactive', // Admin must approve
                    createdAt: serverTimestamp()
                };
                await setDoc(userDocRef, newUser);

                await signOut(auth);

                closeModal('signup-modal');
                showNotification("Account created. Please wait for admin approval.", false);

            } catch (error) {
                console.error("Sign up error:", error);
                let message = "Could not create account. Please try again.";
                if (error.code === 'auth/email-already-in-use') {
                    message = "An account with this email already exists.";
                }
                showNotification(message, true);
            } finally {
                hideLoader();
            }
        }


        // --- UI & View Management ---
        function showLogin() {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('app-container').style.display = 'none';
        }

        function showApp() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('public-pod-view').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            
            document.getElementById('user-display-name').textContent = currentUser.displayName;
            document.getElementById('user-role').textContent = currentUser.role;

            document.getElementById('admin-staff-view').style.display = 'none';
            document.getElementById('driver-view').style.display = 'none';
            document.getElementById('admin-panel-btn').classList.add('hidden');
            document.getElementById('driver-simulation-section').classList.add('hidden');
            
            if (currentUser.role === 'admin' || currentUser.role === 'staff') {
                document.getElementById('admin-staff-view').style.display = 'block';
                document.getElementById('header-subtitle').textContent = "Assign, track, and manage deliveries.";
                if (currentUser.role === 'admin') {
                    document.getElementById('admin-panel-btn').classList.remove('hidden');
                    document.getElementById('driver-simulation-section').classList.remove('hidden');
                }
                loadAdminData();
            } else if (currentUser.role === 'driver') {
                document.getElementById('driver-view').style.display = 'block';
                document.getElementById('header-subtitle').textContent = "View and complete your assigned deliveries.";
                loadDriverTasks();
            } else {
                showNotification("You do not have permission to access the delivery system.", true);
                setTimeout(handleLogout, 3000);
            }
        }
        
        // --- Admin / Staff Logic ---
        async function loadAdminData() {
            showLoader();
            try {
                const jobFilesPromise = getDocs(collection(db, 'jobfiles'));
                const usersPromise = getDocs(collection(db, 'users'));

                const [jobFilesSnapshot, usersSnapshot] = await Promise.all([jobFilesPromise, usersPromise]);

                jobFilesCache = jobFilesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allUsersCache = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                populateUserDropdowns();
                listenForDeliveries();

            } catch (error) {
                console.error("Error loading admin data: ", error);
                showNotification("Failed to load initial data. Check Firestore permissions.", true);
            } finally {
                hideLoader();
            }
        }
        
        function populateUserDropdowns() {
            const assignmentSelect = document.getElementById('driver-select');
            const simulationSelect = document.getElementById('user-simulation-select');
            
            assignmentSelect.innerHTML = '<option value="">-- Select a Driver --</option>';
            simulationSelect.innerHTML = '<option value="">-- Select a User --</option>';

            const activeDrivers = allUsersCache.filter(u => u.role === 'driver' && u.status === 'active');

            activeDrivers.forEach(driver => {
                const option = document.createElement('option');
                option.value = driver.id;
                option.textContent = driver.displayName;
                assignmentSelect.appendChild(option);
            });

            allUsersCache.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.displayName} (${user.role})`;
                simulationSelect.appendChild(option);
            });
        }
        
        function listenForDeliveries() {
            if (deliveriesUnsubscribe) deliveriesUnsubscribe(); // Unsubscribe from previous listener
            const deliveriesRef = collection(db, 'deliveries');
            deliveriesUnsubscribe = onSnapshot(deliveriesRef, (snapshot) => {
                deliveriesCache = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                deliveriesCache.sort((a,b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
                
                renderAllDeliveryViews();
            }, (error) => {
                console.error("Firestore Error (Deliveries):", error);
                showNotification("Permission error: Could not load delivery data.", true);
            });
        }

        function renderAllDeliveryViews() {
            renderDashboardMetrics();
            
            const pendingList = document.getElementById('pending-deliveries-list');
            const completedList = document.getElementById('completed-deliveries-list');
            pendingList.innerHTML = '';
            completedList.innerHTML = '';
            
            const pendingDeliveries = deliveriesCache.filter(d => d.status !== 'Delivered');
            const completedDeliveries = deliveriesCache.filter(d => d.status === 'Delivered');

            if (pendingDeliveries.length > 0) {
                pendingDeliveries.forEach(delivery => pendingList.appendChild(createDeliveryCard(delivery)));
            } else {
                pendingList.innerHTML = '<p class="text-gray-500">No pending deliveries.</p>';
            }

            if (completedDeliveries.length > 0) {
                completedDeliveries.forEach(delivery => completedList.appendChild(createDeliveryCard(delivery)));
            } else {
                completedList.innerHTML = '<p class="text-gray-500">No completed deliveries yet.</p>';
            }
            
            if (currentUser.role === 'admin') {
                renderUserSimulationView();
            }
        }
        
        function renderDashboardMetrics() {
            const pendingCount = deliveriesCache.filter(d => d.status !== 'Delivered').length;
            const completedCount = deliveriesCache.filter(d => d.status === 'Delivered').length;
            
            document.getElementById('stat-pending').textContent = pendingCount;
            document.getElementById('stat-completed').textContent = completedCount;
            document.getElementById('stat-total').textContent = deliveriesCache.length;
            
            const activityList = document.getElementById('recent-activity-list');
            activityList.innerHTML = '';
            const recentActivities = deliveriesCache.slice(0, 5);
            
            if (recentActivities.length === 0) {
                 activityList.innerHTML = '<p class="text-gray-500">No recent activities.</p>';
                 return;
            }

            recentActivities.forEach(delivery => {
                const li = document.createElement('div');
                li.className = 'flex items-center justify-between text-sm p-2 rounded-md hover:bg-gray-50';
                const isCompleted = delivery.status === 'Delivered';
                const time = (isCompleted ? delivery.completedAt : delivery.createdAt)?.toDate().toLocaleString() || 'just now';

                li.innerHTML = `
                    <div>
                        <p class="font-medium">${delivery.jobFileData.jfn}</p>
                        <p class="text-xs text-gray-500">${isCompleted ? `Completed by ${delivery.driverName}` : `Assigned to ${delivery.driverName}`}</p>
                    </div>
                    <div class="text-right">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${isCompleted ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">${delivery.status}</span>
                        <p class="text-xs text-gray-400 mt-1">${time}</p>
                    </div>
                `;
                activityList.appendChild(li);
            });
        }

        function createDeliveryCard(delivery) {
            const card = document.createElement('div');
            card.className = 'border p-3 rounded-lg bg-gray-50';
            const jobData = delivery.jobFileData || {};
            let actionButtons = '';

            if (delivery.status === 'Delivered') {
                if (currentUser.role === 'admin') {
                     actionButtons += `<button class="btn btn-danger btn-xs text-xs" onclick="confirmPodCancel('${delivery.id}', '${jobData.jfn}')">Cancel POD</button>`;
                }
                actionButtons += `${delivery.podId ? `<button class="btn btn-secondary btn-xs text-xs" onclick="openReceiptModal('${delivery.id}')">View Receipt</button>` : ''}`;
            }

            const deliveredInfo = delivery.status === 'Delivered' ? `
                    <div class="mt-2 pt-2 border-t flex justify-between items-center">
                        <div>
                            <p class="text-xs"><strong>Receiver:</strong> ${delivery.receiverName || 'N/A'}</p>
                            <p class="text-xs"><strong>Completed:</strong> ${delivery.completedAt?.toDate().toLocaleString() || 'N/A'}</p>
                        </div>
                        <div class="flex gap-2">
                           ${actionButtons}
                        </div>
                    </div>
                ` : '';

            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <p class="font-bold">${jobData.jfn || 'Unknown Job'}</p>
                        <p class="text-sm text-gray-700">${jobData.sh || 'N/A'} to ${jobData.co || 'N/A'}</p>
                        <p class="text-xs text-gray-500">Assigned to: <strong>${delivery.driverName || 'N/A'}</strong></p>
                    </div>
                    <span class="text-xs font-semibold px-2 py-1 rounded-full ${delivery.status === 'Delivered' ? 'bg-green-200 text-green-800' : 'bg-yellow-200 text-yellow-800'}">
                        ${delivery.status}
                    </span>
                </div>
                ${deliveredInfo}
            `;

            return card;
        }

        function handleJobFileSearch(e) {
            const searchTerm = e.target.value.toLowerCase();
            const suggestionsEl = document.getElementById('job-file-suggestions');

            if (searchTerm.length < 2) {
                suggestionsEl.innerHTML = '';
                suggestionsEl.classList.add('hidden');
                return;
            }

            const filteredJobs = jobFilesCache.filter(job => 
                (job.jfn && job.jfn.toLowerCase().includes(searchTerm)) ||
                (job.sh && job.sh.toLowerCase().includes(searchTerm)) ||
                (job.co && job.co.toLowerCase().includes(searchTerm))
            ).slice(0, 10);

            if (filteredJobs.length > 0) {
                suggestionsEl.innerHTML = filteredJobs.map(job => 
                    `<div class="suggestion-item" data-id="${job.id}">${job.jfn} - ${job.sh}</div>`
                ).join('');
                suggestionsEl.classList.remove('hidden');
            } else {
                suggestionsEl.innerHTML = '';
                suggestionsEl.classList.add('hidden');
            }
        }
        
        function selectJobFile(e) {
            if (e.target.classList.contains('suggestion-item')) {
                const jobId = e.target.dataset.id;
                selectedJobFile = jobFilesCache.find(job => job.id === jobId);
                
                if (selectedJobFile) {
                    document.getElementById('form-job-file-no').value = selectedJobFile.jfn;
                    document.getElementById('form-job-shipper-consignee').value = `${selectedJobFile.sh} / ${selectedJobFile.co}`;
                    document.getElementById('job-file-search').value = selectedJobFile.jfn;
                }
                document.getElementById('job-file-suggestions').classList.add('hidden');
            }
        }

        async function handleAssignDelivery(e) {
            e.preventDefault();
            if (!selectedJobFile) {
                showNotification("Please select a job file first.", true);
                return;
            }

            const driverId = document.getElementById('driver-select').value;
            const location = document.getElementById('delivery-location').value.trim();

            if (!driverId || !location) {
                showNotification("Please select a driver and enter a location.", true);
                return;
            }
            
            showLoader();
            try {
                const driver = allUsersCache.find(d => d.id === driverId);
                const deliveryData = {
                    jobFileId: selectedJobFile.id,
                    jobFileData: { // Store a snapshot of key data
                        jfn: selectedJobFile.jfn,
                        sh: selectedJobFile.sh,
                        co: selectedJobFile.co,
                        dsc: selectedJobFile.dsc,
                        gw: selectedJobFile.gw,
                        mawb: selectedJobFile.mawb
                    },
                    deliveryLocation: location,
                    deliveryNotes: document.getElementById('additional-notes').value.trim(),
                    driverUid: driver.id,
                    driverName: driver.displayName,
                    status: 'Pending',
                    createdAt: serverTimestamp(),
                };

                await addDoc(collection(db, 'deliveries'), deliveryData);

                showNotification("Delivery assigned successfully!");
                document.getElementById('delivery-form').reset();
                document.getElementById('job-file-search').value = '';
                selectedJobFile = null;

            } catch(error) {
                console.error("Error assigning delivery:", error);
                showNotification("Could not assign delivery. Check Firestore permissions.", true);
            } finally {
                hideLoader();
            }
        }

        // --- Driver Logic & Simulation ---
        function createDriverTaskCard(task) {
            const taskCard = document.createElement('div');
            taskCard.className = `border p-4 rounded-lg shadow-sm ${task.status === 'Pending' ? 'bg-white' : 'bg-gray-200'}`;
            const jobData = task.jobFileData || {};

            let actionButton = '';
            if (task.status === 'Pending') {
                 actionButton = `<button class="btn btn-primary text-sm">Complete Delivery</button>`;
                 taskCard.classList.add('cursor-pointer', 'hover:bg-gray-50');
            } else {
                actionButton = `<button class="btn btn-secondary text-sm">View Receipt</button>`;
            }

            taskCard.innerHTML = `
                <div class="flex justify-between items-center">
                    <div>
                        <p class="font-bold text-lg">${jobData.jfn}</p>
                        <p class="text-sm text-gray-700"><strong>To:</strong> ${task.deliveryLocation}</p>
                        <p class="text-xs text-gray-500"><strong>Assigned:</strong> ${task.createdAt?.toDate().toLocaleString()}</p>
                    </div>
                    <div class="flex flex-col items-end gap-2">
                        <span class="text-sm font-semibold px-2 py-1 rounded-full ${task.status === 'Delivered' ? 'bg-green-200 text-green-800' : 'bg-yellow-200 text-yellow-800'}">
                            ${task.status}
                        </span>
                        ${actionButton}
                    </div>
                </div>
            `;
             taskCard.querySelector('button')?.addEventListener('click', (e) => {
                e.stopPropagation();
                if (task.status === 'Pending') {
                    openCompletionModal(task)
                } else {
                    openReceiptModal(task.id)
                }
             });
            return taskCard;
        }

        function loadDriverTasks() {
            if (driverTasksUnsubscribe) driverTasksUnsubscribe();
            const q = query(collection(db, "deliveries"), where("driverUid", "==", currentUser.uid));
            
            driverTasksUnsubscribe = onSnapshot(q, (snapshot) => {
                const listEl = document.getElementById('driver-tasks-list');
                listEl.innerHTML = '';
                
                const tasks = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                tasks.sort((a,b) => {
                    if (a.status === 'Pending' && b.status !== 'Pending') return -1;
                    if (a.status !== 'Pending' && b.status === 'Pending') return 1;
                    return (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0);
                });

                if (tasks.length > 0) {
                    tasks.forEach(task => listEl.appendChild(createDriverTaskCard(task)));
                } else {
                     listEl.innerHTML = '<p class="text-gray-500">You have no assigned deliveries.</p>';
                }
            }, (error) => {
                console.error("Firestore Error (Driver Tasks):", error);
                showNotification("Permission error: Could not load your assigned tasks.", true);
            });
        }
        
        function openCompletionModal(delivery) {
            activeDeliveryForCompletion = delivery; // **FIX**: Store the full delivery object
            document.getElementById('delivery-id-input').value = delivery.id;
            document.getElementById('modal-job-no').textContent = delivery.jobFileData.jfn;
            document.getElementById('modal-location').textContent = delivery.deliveryLocation;
            document.getElementById('completion-form').reset();
            
            const canvas = document.getElementById('completion-signature-pad');
            const resizeCanvas = () => {
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                canvas.getContext("2d").scale(ratio, ratio);
                if (completionSignaturePad) completionSignaturePad.clear();
            }
            setTimeout(resizeCanvas, 10);
            
            if (!completionSignaturePad) {
                completionSignaturePad = new SignaturePad(canvas, {
                    backgroundColor: 'rgb(255, 255, 255)' // Set background to white
                });
            } else {
                completionSignaturePad.clear();
            }

            document.getElementById('location-status').textContent = '';
            currentGeolocation = null;
            openModal('delivery-completion-modal');
        }

        async function handleCompleteDelivery(e) {
            e.preventDefault();
            const deliveryId = document.getElementById('delivery-id-input').value;
            const receiverName = document.getElementById('receiver-name').value.trim();
            const receiverMobile = document.getElementById('receiver-mobile').value.trim();

            if (!receiverName || !receiverMobile) {
                showNotification("Please enter the receiver's name and mobile number.", true);
                return;
            }
             if (completionSignaturePad.isEmpty()) {
                showNotification("Please capture the receiver's signature.", true);
                return;
            }

            showLoader();
            try {
                const signatureDataUrl = completionSignaturePad.toDataURL('image/jpeg', 0.5);
                
                const deliveryData = activeDeliveryForCompletion; // **FIX**: Use the stored delivery object
                if (!deliveryData) {
                    throw new Error("Could not find the delivery data to process.");
                }

                const podData = {
                    deliveryId: deliveryId,
                    jobFileId: deliveryData.jobFileId,
                    jobFileData: deliveryData.jobFileData,
                    receiverName: receiverName,
                    receiverMobile: receiverMobile,
                    signatureDataUrl: signatureDataUrl, // Save as Data URL
                    completedAt: serverTimestamp(),
                    driverUid: currentUser.uid,
                    driverName: currentUser.displayName,
                };
                 if (currentGeolocation) {
                    podData.geolocation = currentGeolocation;
                }

                const podDocRef = doc(db, 'pods', deliveryId);
                await setDoc(podDocRef, podData);

                const deliveryRef = doc(db, 'deliveries', deliveryId);
                await updateDoc(deliveryRef, {
                    status: 'Delivered',
                    completedAt: serverTimestamp(),
                    podId: deliveryId,
                    receiverName: receiverName
                });
                
                showNotification("Delivery completed successfully!");
                closeModal('delivery-completion-modal');

            } catch (error) {
                console.error("Error completing delivery:", error);
                showNotification(`Failed to complete delivery: ${error.message}`, true);
            } finally {
                hideLoader();
            }
        }
        
        function handleGetLocation() {
            const statusEl = document.getElementById('location-status');
            if (!navigator.geolocation) {
                statusEl.textContent = 'Geolocation is not supported by your browser.';
                return;
            }

            statusEl.textContent = 'Getting location...';
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    currentGeolocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    statusEl.textContent = `Location captured successfully.`;
                    statusEl.style.color = '#16a34a';
                },
                () => {
                    statusEl.textContent = 'Unable to retrieve your location.';
                    statusEl.style.color = '#dc2626';
                }
            );
        }

        // --- Receipt Logic ---
        async function openReceiptModal(deliveryId) {
            showLoader();
            try {
                const podDocRef = doc(db, 'pods', deliveryId);
                const podDoc = await getDoc(podDocRef);
                
                if (podDoc.exists()) {
                    activeDeliveryForReceipt = podDoc.data();
                } else {
                     throw new Error("Receipt data not found in PODs collection.");
                }

                openModal('receipt-modal', true);
                generateReceipt();

            } catch (error) {
                console.error("Error opening receipt:", error);
                showNotification(error.message, true);
            } finally {
                hideLoader();
            }
        }

        function generateReceipt() {
            const receiptContent = document.getElementById('receipt-content');
            const jobData = activeDeliveryForReceipt.jobFileData;
            const receiverName = activeDeliveryForReceipt.receiverName;
            const deliveryDate = (activeDeliveryForReceipt.completedAt?.toDate() || new Date()).toLocaleString();

            receiptContent.innerHTML = `
                <div class="space-y-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="text-2xl font-bold" style="color: #0E639C;">Q'go<span style="color: #4FB8AF;">Cargo</span></div>
                            <p class="text-xs text-gray-500">Proof of Delivery</p>
                        </div>
                        <div class="text-right text-xs">
                            <p class="font-bold">Job No: ${jobData.jfn}</p>
                            <p>MAWB/OBL: ${jobData.mawb || 'N/A'}</p>
                        </div>
                    </div>
                    <div class="border-t border-b py-2 grid grid-cols-2 gap-x-4 text-sm">
                        <div>
                            <p class="text-gray-500">Shipper</p>
                            <p class="font-medium">${jobData.sh}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-gray-500">Consignee</p>
                            <p class="font-medium">${jobData.co}</p>
                        </div>
                    </div>
                     <div class="text-sm space-y-1">
                        <p><strong>Description:</strong> ${jobData.dsc || 'N/A'}</p>
                        <p><strong>Gross Weight:</strong> ${jobData.gw || 'N/A'}</p>
                        <p><strong>Delivery Location:</strong> ${activeDeliveryForReceipt.deliveryLocation || activeDeliveryForReceipt.jobFileData.de}</p>
                        <p><strong>Receiver Mobile:</strong> ${activeDeliveryForReceipt.receiverMobile || 'N/A'}</p>
                     </div>
                     <div class="bg-gray-50 p-3 rounded-md flex justify-between items-end">
                        <div>
                            <p class="text-sm font-semibold">Recipient Confirmation</p>
                            <p class="text-xs mt-1">I, <strong>${receiverName}</strong>, confirm the receipt of the goods on <strong>${deliveryDate}</strong>.</p>
                            <div class="mt-2">
                                <p class="text-xs mb-1 text-gray-600">Signature:</p>
                                <img src="${activeDeliveryForReceipt.signatureDataUrl}" alt="Signature" class="w-40 bg-white border p-1 rounded-md"/>
                            </div>
                        </div>
                        <div id="receipt-qrcode" class="p-1 bg-white border rounded-md"></div>
                    </div>
                </div>
            `;
            
            // Generate QR Code
            const qrContainer = document.getElementById('receipt-qrcode');
            qrContainer.innerHTML = '';
            new QRCode(qrContainer, {
                text: window.location.origin + window.location.pathname + '?podId=' + activeDeliveryForReceipt.deliveryId,
                width: 80,
                height: 80,
            });
        }
        
        async function downloadReceiptAsPDF() {
            showLoader();
            const { jsPDF } = window.jspdf;
            const receiptElement = document.getElementById('receipt-content');
            
            try {
                const canvas = await html2canvas(receiptElement, { scale: 2 });
                const imgData = canvas.toDataURL('image/png');
                
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'pt',
                    format: [canvas.width / 2, canvas.height / 2]
                });
                
                pdf.addImage(imgData, 'PNG', 0, 0, pdf.internal.pageSize.getWidth(), pdf.internal.pageSize.getHeight());
                pdf.save(`Receipt-${activeDeliveryForReceipt.jobFileData.jfn}.pdf`);

            } catch (error) {
                 console.error("Error generating PDF:", error);
                 showNotification("Could not generate PDF.", true);
            } finally {
                hideLoader();
            }
        }

        function printReceipt() {
            const receiptHTML = document.getElementById('receipt-content').innerHTML;
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>Delivery Receipt</title>');
            printWindow.document.write('<script src="https://cdn.tailwindcss.com"><\/script>');
            printWindow.document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"><\/script>');
            printWindow.document.write('</head><body class="p-6">');
            printWindow.document.write(receiptHTML);
            printWindow.document.write(`
                <script>
                    const qrContainer = document.getElementById('receipt-qrcode');
                    if (qrContainer) {
                         new QRCode(qrContainer, {
                            text: "${window.location.origin + window.location.pathname + '?podId=' + activeDeliveryForReceipt.deliveryId}",
                            width: 80,
                            height: 80,
                        });
                        setTimeout(() => window.print(), 500);
                    }
                <\/script>
            `);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
        }
        
        function renderUserSimulationView() {
            const selectedUserId = document.getElementById('user-simulation-select').value;
            const listEl = document.getElementById('user-simulation-list');
            listEl.innerHTML = '';
            
            if (!selectedUserId) {
                listEl.innerHTML = '<p class="text-center text-gray-500 p-4">Select a user to see their assigned tasks.</p>';
                return;
            }

            const userTasks = deliveriesCache.filter(d => d.driverUid === selectedUserId);
            if(userTasks.length > 0) {
                 userTasks.forEach(task => listEl.appendChild(createDriverTaskCard(task)));
            } else {
                 listEl.innerHTML = '<p class="text-center text-gray-500 p-4">This user has no assigned tasks.</p>';
            }
        }
        
        // --- Admin Panel ---
        async function openAdminPanel() {
            showLoader();
            try {
                // Fetch all users now, not just drivers
                const snapshot = await getDocs(collection(db, 'users'));
                const users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const listEl = document.getElementById('user-list-admin');
                listEl.innerHTML = '';
                if(users.length === 0) {
                    listEl.innerHTML = `<p class="text-gray-500 text-center p-4">No users found.</p>`;
                } else {
                    users.forEach(user => {
                        const canDelete = currentUser.uid !== user.id && user.role !== 'admin';
                        const deleteButton = canDelete ? `<button onclick="confirmUserDelete('${user.id}', '${user.displayName}')" class="btn btn-danger text-xs">Delete</button>` : '';
                        
                        const userEl = document.createElement('div');
                        userEl.className = "grid grid-cols-4 gap-4 items-center p-2 border-b";
                        userEl.innerHTML = `
                            <div>
                                <p class="font-medium">${user.displayName}</p>
                                <p class="text-xs text-gray-500">${user.email}</p>
                            </div>
                             <div>
                                <select data-uid="${user.id}" class="input-field status-select" ${currentUser.uid === user.id ? 'disabled' : ''}>
                                    <option value="active" ${user.status === 'active' ? 'selected' : ''}>Active</option>
                                    <option value="inactive" ${user.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                                </select>
                            </div>
                            <div class="text-sm text-gray-600">${user.role}</div>
                            <div class="text-right">
                                ${deleteButton}
                            </div>
                        `;
                        listEl.appendChild(userEl);
                    });
                }
                openModal('admin-panel-modal');
            } catch (error) {
                console.error("Error opening admin panel:", error);
                showNotification("Could not load user data.", true);
            } finally {
                hideLoader();
            }
        }

        async function saveUserChanges() {
            showLoader();
            const batch = writeBatch(db);
            const statusSelects = document.querySelectorAll('.status-select');
            
            statusSelects.forEach(select => {
                const uid = select.dataset.uid;
                const newStatus = select.value;
                const docRef = doc(db, 'users', uid);
                batch.update(docRef, { status: newStatus });
            });

            try {
                await batch.commit();
                showNotification("User statuses updated successfully!", false);
                closeModal('admin-panel-modal');
                loadAdminData();
            } catch (error) {
                console.error("Error saving user statuses:", error);
                showNotification("Failed to update statuses.", true);
            } finally {
                hideLoader();
            }
        }
        
        window.confirmUserDelete = (userId, userName) => {
             const modal = document.getElementById('confirm-modal');
            modal.querySelector('#confirm-title').textContent = 'Confirm User Deletion';
            modal.querySelector('#confirm-message').innerHTML = `Are you sure you want to delete the user "${userName}"? This will only remove them from the application database, not from Firebase Authentication.`;
            openModal('confirm-modal', true);

            const okButton = modal.querySelector('#confirm-ok');
            const handleOkClick = () => {
                deleteUserFromFirestore(userId);
                closeModal('confirm-modal');
                okButton.removeEventListener('click', handleOkClick);
            };
            okButton.addEventListener('click', handleOkClick, { once: true });
        }
        
        window.confirmPodCancel = (deliveryId, jobFileNo) => {
            const modal = document.getElementById('confirm-modal');
            modal.querySelector('#confirm-title').textContent = 'Confirm POD Cancellation';
            modal.querySelector('#confirm-message').innerHTML = `Are you sure you want to cancel the POD for job file "${jobFileNo}"? This will delete the receipt and set the delivery back to "Pending".`;
            openModal('confirm-modal', true);

            const okButton = modal.querySelector('#confirm-ok');
             const handleOkClick = () => {
                cancelPod(deliveryId);
                closeModal('confirm-modal');
                okButton.removeEventListener('click', handleOkClick);
            };
            okButton.addEventListener('click', handleOkClick, { once: true });
        }

        async function cancelPod(deliveryId) {
            showLoader();
            try {
                const batch = writeBatch(db);

                const podRef = doc(db, 'pods', deliveryId);
                batch.delete(podRef);

                const deliveryRef = doc(db, 'deliveries', deliveryId);
                batch.update(deliveryRef, {
                    status: 'Pending',
                    podId: deleteField(),
                    completedAt: deleteField(),
                    receiverName: deleteField(),
                    receiverMobile: deleteField(),
                });
                
                await batch.commit();
                showNotification("POD cancelled and delivery status reset.", false);
            } catch (error) {
                console.error("Error cancelling POD:", error);
                showNotification("Failed to cancel POD.", true);
            } finally {
                hideLoader();
            }
        }

        async function deleteUserFromFirestore(userId) {
            showLoader();
            try {
                await deleteDoc(doc(db, 'users', userId));
                showNotification("User deleted successfully from Firestore.", false);
                openAdminPanel(); // Refresh the list
            } catch (error) {
                console.error("Error deleting user:", error);
                showNotification("Failed to delete user.", true);
            } finally {
                hideLoader();
            }
        }
        
         async function showPublicPodView(podId) {
            showLoader();
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'none';
            
            try {
                const podDocRef = doc(db, 'pods', podId);
                const podDoc = await getDoc(podDocRef);

                if (podDoc.exists()) {
                    activeDeliveryForReceipt = podDoc.data();
                    const view = document.getElementById('public-pod-view');
                    view.style.display = 'block';
                    view.innerHTML = `<div class="container mx-auto p-4 sm:p-6 lg:p-8"><div id="receipt-content" class="p-4 border rounded-md bg-white shadow-lg"></div></div>`;
                    generateReceipt();
                } else {
                    document.body.innerHTML = `<div class="p-4 text-center text-red-700 bg-red-100">POD with ID "${podId}" not found.</div>`;
                }

            } catch(e) {
                console.error("Error fetching public POD:", e);
                document.body.innerHTML = `<div class="p-4 text-center text-red-700 bg-red-100">Error loading POD.</div>`;
            } finally {
                hideLoader();
                document.body.classList.remove('loading');
            }
        }


        // --- General Functions ---
        function showLoader() { document.getElementById('loader-overlay').classList.add('visible'); }
        function hideLoader() { document.getElementById('loader-overlay').classList.remove('visible'); }
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.backgroundColor = isError ? '#c53030' : '#2d3748';
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        window.openModal = (id, keepParent = false) => {
            const modal = document.getElementById(id);
             if (keepParent) {
                const highestZ = Array.from(document.querySelectorAll('.overlay.visible'))
                    .reduce((max, el) => Math.max(max, parseInt(window.getComputedStyle(el).zIndex || 1000)), 1000);
                modal.style.zIndex = highestZ + 10;
            }
            modal.classList.add('visible');
        };
        window.closeModal = (id) => document.getElementById(id).classList.remove('visible');

        function handleLogout() {
            signOut(auth).catch((error) => {
                console.error("Logout failed:", error);
                showNotification("Logout failed. Please try again.", true);
            });
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeAppLogic();
            
            document.getElementById('auth-btn').addEventListener('click', handleLogin);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('job-file-search').addEventListener('input', handleJobFileSearch);
            document.getElementById('job-file-suggestions').addEventListener('click', selectJobFile);
            document.getElementById('delivery-form').addEventListener('submit', handleAssignDelivery);
            document.getElementById('user-simulation-select').addEventListener('change', renderUserSimulationView);
            document.getElementById('completion-form').addEventListener('submit', handleCompleteDelivery);
            document.getElementById('clear-completion-signature-btn').addEventListener('click', () => completionSignaturePad.clear());
            document.getElementById('get-location-btn').addEventListener('click', handleGetLocation);
            
            document.getElementById('pdf-receipt-btn').addEventListener('click', downloadReceiptAsPDF);
            document.getElementById('print-receipt-btn').addEventListener('click', printReceipt);
            document.getElementById('admin-panel-btn').addEventListener('click', openAdminPanel);

            document.getElementById('create-driver-account-link').addEventListener('click', (e) => {
                e.preventDefault();
                openModal('signup-modal');
            });
            document.getElementById('signup-form').addEventListener('submit', handleDriverSignUp);
            document.getElementById('forgot-password-link').addEventListener('click', (e) => {
                e.preventDefault();
                openModal('forgot-password-modal');
            });
            document.getElementById('forgot-password-form').addEventListener('submit', handleForgotPassword);


            const confirmCancelBtn = document.getElementById('confirm-cancel');
            confirmCancelBtn.addEventListener('click', () => {
                 const okButton = document.getElementById('confirm-ok');
                 const newOkButton = okButton.cloneNode(true);
                 okButton.parentNode.replaceChild(newOkButton, okButton);
                 closeModal('confirm-modal');
            });

        });
        
        // Make functions globally accessible for inline onclick handlers
        window.saveUserChanges = saveUserChanges;
        window.openReceiptModal = openReceiptModal;
        window.confirmUserDelete = confirmUserDelete;
        window.confirmPodCancel = confirmPodCancel;

    </script>
</body>
</html>

